<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Crypto Detector v2</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');
*{font-family:'Space Grotesk',sans-serif}
.mono{font-family:'JetBrains Mono',monospace}
.tab-active{background:#1d4ed8!important;color:#fff!important}
.gauge-ring{stroke-dasharray:251;stroke-dashoffset:251;transition:stroke-dashoffset 1s ease;stroke-linecap:round}
.card-hover{transition:all .2s;cursor:pointer}
.card-hover:hover{transform:translateY(-2px);box-shadow:0 8px 30px rgba(0,0,0,.4)}
.bar{transition:width .8s ease}
.pill{display:inline-block;padding:2px 8px;border-radius:9999px;font-size:11px;font-weight:600}
.sentiment-pos{color:#4ade80}.sentiment-neg{color:#f87171}.sentiment-neu{color:#94a3b8}
.tab-content{display:none}
.result-card{cursor:pointer;transition:opacity .2s}
.excluded{opacity:.4;border-style:dashed!important}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:#1e293b}::-webkit-scrollbar-thumb{background:#334155;border-radius:2px}
</style>
</head>
<body class="bg-gray-950 text-gray-100 min-h-screen">

<!-- â•â• MODAL DETALLE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="modal-detail" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 overflow-y-auto p-4">
  <div class="max-w-4xl mx-auto bg-gray-900 rounded-2xl shadow-2xl my-4 overflow-hidden">
    <div id="detail-header" class="p-6 pb-4 border-b border-gray-800 flex justify-between items-start">
      <div class="flex items-center gap-4">
        <img id="detail-img" src="" class="w-12 h-12 rounded-full bg-gray-800"/>
        <div>
          <h2 id="detail-name" class="text-2xl font-bold"></h2>
          <p id="detail-symbol" class="text-gray-400 mono text-sm"></p>
        </div>
        <span id="detail-badge" class="pill"></span>
      </div>
      <button onclick="closeModal('modal-detail')" class="text-gray-500 hover:text-white text-2xl leading-none">âœ•</button>
    </div>
    <div class="flex gap-1 px-6 pt-4 border-b border-gray-800">
      <button onclick="setDetailTab('overview')"    id="dtab-overview"    class="dtab px-4 py-2 rounded-t text-sm font-medium text-gray-400 hover:text-white">ğŸ“Š Resumen</button>
      <button onclick="setDetailTab('indicators')"  id="dtab-indicators"  class="dtab px-4 py-2 rounded-t text-sm font-medium text-gray-400 hover:text-white">ğŸ¯ Indicadores</button>
      <button onclick="setDetailTab('qualitative')" id="dtab-qualitative" class="dtab px-4 py-2 rounded-t text-sm font-medium text-gray-400 hover:text-white">ğŸ’¬ Red Social</button>
    </div>
    <!-- Tab Resumen -->
    <div id="dcontent-overview" class="detail-tab p-6 space-y-4">
      <div class="grid grid-cols-4 gap-3">
        <div class="bg-gray-800 rounded-xl p-4 col-span-2">
          <p class="text-xs text-gray-500 mb-1">Precio actual</p>
          <p id="d-price" class="text-3xl font-bold mono"></p>
          <div class="flex gap-3 mt-2">
            <span id="d-chg24" class="text-sm font-medium"></span>
            <span id="d-chg7"  class="text-sm text-gray-400"></span>
            <span id="d-chg30" class="text-sm text-gray-500"></span>
          </div>
        </div>
        <div class="bg-gray-800 rounded-xl p-4 flex flex-col items-center justify-center">
          <p class="text-xs text-gray-500 mb-2">BoostPower</p>
          <div class="relative w-20 h-20">
            <svg viewBox="0 0 100 100" class="w-full h-full -rotate-90">
              <circle cx="50" cy="50" r="40" fill="none" stroke="#1e293b" stroke-width="10"/>
              <circle id="d-gauge" cx="50" cy="50" r="40" fill="none" stroke="#3b82f6" stroke-width="10" class="gauge-ring"/>
            </svg>
            <div class="absolute inset-0 flex items-center justify-center">
              <span id="d-bp" class="text-xl font-bold mono">0%</span>
            </div>
          </div>
        </div>
        <div class="bg-gray-800 rounded-xl p-4 flex flex-col justify-center">
          <p class="text-xs text-gray-500 mb-1">ClasificaciÃ³n</p>
          <p id="d-classname" class="text-lg font-bold"></p>
          <p id="d-confidence" class="text-xs text-gray-400 mt-1"></p>
          <p id="d-target" class="text-xs text-blue-400 mt-2 font-medium"></p>
        </div>
      </div>
      <div class="bg-gray-800/50 border border-gray-700 rounded-xl p-4">
        <p class="text-xs text-gray-500 mb-2">ğŸ“ Resumen del algoritmo</p>
        <p id="d-summary" class="text-sm text-gray-300 leading-relaxed"></p>
      </div>
      <div class="bg-gray-800/50 border border-gray-700 rounded-xl p-4">
        <p class="text-xs text-gray-500 mb-1">ğŸ” RazÃ³n de clasificaciÃ³n</p>
        <p id="d-reason" class="text-sm text-gray-300"></p>
      </div>
      <div class="grid grid-cols-3 gap-3 text-sm">
        <div class="bg-gray-800 rounded-xl p-3"><p class="text-xs text-gray-500">Market Cap</p><p id="d-mcap" class="font-semibold mono"></p></div>
        <div class="bg-gray-800 rounded-xl p-3"><p class="text-xs text-gray-500">Volumen 24h</p><p id="d-vol" class="font-semibold mono"></p></div>
        <div class="bg-gray-800 rounded-xl p-3"><p class="text-xs text-gray-500">Supply circulante</p><p id="d-supply" class="font-semibold mono"></p></div>
        <div class="bg-gray-800 rounded-xl p-3"><p class="text-xs text-gray-500">ATH</p><p id="d-ath" class="font-semibold mono text-red-400"></p></div>
        <div class="bg-gray-800 rounded-xl p-3"><p class="text-xs text-gray-500">ATL</p><p id="d-atl" class="font-semibold mono text-green-400"></p></div>
        <div class="bg-gray-800 rounded-xl p-3"><p class="text-xs text-gray-500">ATL hace</p><p id="d-atldays" class="font-semibold"></p></div>
      </div>
      <div class="bg-gray-800 rounded-xl p-4">
        <div class="flex justify-between text-xs text-gray-500 mb-2"><span>ATL</span><span id="d-atlpct" class="text-white font-medium"></span><span>ATH</span></div>
        <div class="w-full bg-gray-700 rounded-full h-3">
          <div id="d-atlbar" class="bar h-3 rounded-full bg-gradient-to-r from-green-500 to-blue-500" style="width:0%"></div>
        </div>
        <p class="text-xs text-gray-600 mt-1">PosiciÃ³n en el rango histÃ³rico â€” cuanto mÃ¡s a la izquierda, mayor potencial</p>
      </div>
    </div>
    <!-- Tab Indicadores -->
    <div id="dcontent-indicators" class="detail-tab hidden p-6 space-y-4">
      <div><p class="text-sm font-semibold text-green-400 mb-3">â¬†ï¸ Factores de Potencial</p><div id="d-potential-factors" class="space-y-2"></div></div>
      <div><p class="text-sm font-semibold text-red-400 mb-3">â¬‡ï¸ Factores de Resistencia</p><div id="d-resistance-factors" class="space-y-2"></div></div>
      <div class="bg-gray-800/50 border border-gray-700 rounded-xl p-4">
        <p class="text-xs text-gray-500 mb-3">ğŸ“Š Indicadores derivados</p>
        <div id="d-derived-indicators" class="grid grid-cols-2 gap-2 text-sm"></div>
      </div>
    </div>
    <!-- Tab Red Social -->
    <div id="dcontent-qualitative" class="detail-tab hidden p-6 space-y-5">
      <div class="bg-gray-800 rounded-xl p-4">
        <p class="text-xs text-gray-500 mb-2">ğŸ˜¨ Fear & Greed Index</p>
        <div class="flex items-center gap-3">
          <span id="d-fgi-val" class="text-3xl font-bold mono"></span>
          <span id="d-fgi-label" class="text-sm text-gray-300"></span>
        </div>
      </div>
      <!-- LunarCrush y Santiment -->
      <div id="d-social-extra" class="hidden grid grid-cols-2 gap-3"></div>
      <div>
        <p class="text-sm font-semibold mb-3">ğŸ“° Noticias recientes</p>
        <div id="d-news-sources" class="text-xs text-gray-500 mb-2"></div>
        <div id="d-news" class="space-y-2"><p class="text-gray-500 text-sm">Cargando...</p></div>
      </div>
      <div>
        <div class="flex justify-between items-center mb-3">
          <p class="text-sm font-semibold">ğŸ”´ Reddit</p>
          <span id="d-reddit-meta" class="text-xs text-gray-400"></span>
        </div>
        <div id="d-reddit" class="space-y-2"><p class="text-gray-500 text-sm">Cargando...</p></div>
      </div>
    </div>
  </div>
</div>

<!-- â•â• MODAL CICLO â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="modal-cycle" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
  <div class="bg-gray-900 rounded-2xl p-6 w-full max-w-md shadow-2xl">
    <h3 class="text-xl font-bold mb-1">â° Configurar Ciclo</h3>
    <p class="text-xs text-gray-500 mb-1">Modo actual: <span id="modal-mode-label" class="text-blue-400 font-semibold">Normal</span></p>
    <p class="text-xs text-yellow-500 mb-4" id="modal-sig-note"></p>
    <div class="grid grid-cols-3 gap-2 mb-4">
      <button onclick="setDur(30*60000)"   class="dur-btn bg-gray-700 hover:bg-blue-700 px-3 py-2 rounded-lg text-sm">30 min</button>
      <button onclick="setDur(60*60000)"   class="dur-btn bg-gray-700 hover:bg-blue-700 px-3 py-2 rounded-lg text-sm">1 hora</button>
      <button onclick="setDur(4*3600000)"  class="dur-btn bg-gray-700 hover:bg-blue-700 px-3 py-2 rounded-lg text-sm">4 horas</button>
      <button onclick="setDur(6*3600000)"  class="dur-btn bg-gray-700 hover:bg-blue-700 px-3 py-2 rounded-lg text-sm">6h â­</button>
      <button onclick="setDur(12*3600000)" class="dur-btn bg-blue-700 px-3 py-2 rounded-lg text-sm font-bold">12h â­â­</button>
      <button onclick="setDur(24*3600000)" class="dur-btn bg-gray-700 hover:bg-blue-700 px-3 py-2 rounded-lg text-sm">24 horas</button>
    </div>
    <input type="number" id="dur-custom" placeholder="Minutos personalizados" min="1" max="10080"
      class="w-full bg-gray-800 rounded-lg px-3 py-2 text-sm mb-4" oninput="setDurMin(this.value)"/>
    <div class="bg-gray-800 rounded-lg p-3 mb-4 text-sm">
      <span class="text-gray-400">DuraciÃ³n: </span><span id="dur-label" class="font-bold text-blue-400">12 horas</span>
      <span class="text-gray-400 ml-3">Activos: </span><span id="dur-assets" class="font-bold">â€”</span>
      <span id="dur-sig-badge" class="ml-3 pill bg-green-900 text-green-300">âœ“ Significativo</span>
    </div>
    <div class="flex gap-3">
      <button onclick="confirmCycle()" class="flex-1 bg-blue-700 hover:bg-blue-600 py-2 rounded-lg font-semibold">ğŸš€ Iniciar</button>
      <button onclick="closeModal('modal-cycle')" class="flex-1 bg-gray-700 hover:bg-gray-600 py-2 rounded-lg">Cancelar</button>
    </div>
  </div>
</div>

<!-- â•â• MODAL API KEY â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="modal-apikey" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
  <div class="bg-gray-900 rounded-2xl p-6 w-full max-w-sm shadow-2xl">
    <h3 class="text-lg font-bold mb-1">âš™ï¸ Configurar API Key</h3>
    <p id="apikey-name" class="text-sm text-blue-400 mb-4 mono"></p>
    <input type="password" id="apikey-input" placeholder="Pega tu API key aquÃ­..."
      class="w-full bg-gray-800 rounded-lg px-3 py-2 text-sm mb-4 mono"/>
    <div id="apikey-msg" class="text-sm mb-3"></div>
    <div class="flex gap-3">
      <button onclick="saveAPIKey()" class="flex-1 bg-green-700 hover:bg-green-600 py-2 rounded-lg text-sm font-semibold">ğŸ’¾ Guardar</button>
      <button onclick="closeModal('modal-apikey')" class="flex-1 bg-gray-700 hover:bg-gray-600 py-2 rounded-lg text-sm">Cerrar</button>
    </div>
  </div>
</div>

<!-- â•â• LAYOUT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="max-w-7xl mx-auto p-4">

  <div class="flex justify-between items-center mb-5 pt-2">
    <div>
      <h1 class="text-3xl font-bold tracking-tight">Crypto<span class="text-blue-500">Detector</span></h1>
      <p class="text-gray-500 text-xs mono mt-0.5">v2.0 Â· Potencial âˆ’ Resistencia</p>
    </div>
    <div id="fgi-badge" class="text-right"></div>
  </div>

  <!-- Tabs -->
  <div class="flex gap-1 mb-5 bg-gray-900 p-1 rounded-xl border border-gray-800 overflow-x-auto">
    <button onclick="setTab('monitor')"    id="tab-monitor"    class="tab-btn flex-1 py-2 rounded-lg text-sm font-medium text-gray-400 hover:text-white transition-colors tab-active whitespace-nowrap px-3">ğŸ“Š Monitor</button>
    <button onclick="setTab('config')"     id="tab-config"     class="tab-btn flex-1 py-2 rounded-lg text-sm font-medium text-gray-400 hover:text-white transition-colors whitespace-nowrap px-3">âš™ï¸ Config</button>
    <button onclick="setTab('validation')" id="tab-validation" class="tab-btn flex-1 py-2 rounded-lg text-sm font-medium text-gray-400 hover:text-white transition-colors whitespace-nowrap px-3">âœ… ValidaciÃ³n</button>
    <button onclick="setTab('analysis')"   id="tab-analysis"   class="tab-btn flex-1 py-2 rounded-lg text-sm font-medium text-gray-400 hover:text-white transition-colors whitespace-nowrap px-3">ğŸ”¬ AnÃ¡lisis</button>
    <button onclick="setTab('status')"     id="tab-status"     class="tab-btn flex-1 py-2 rounded-lg text-sm font-medium text-gray-400 hover:text-white transition-colors whitespace-nowrap px-3">ğŸ”Œ APIs</button>
    <button onclick="setTab('invest')"    id="tab-invest"     class="tab-btn flex-1 py-2 rounded-lg text-sm font-medium text-gray-400 hover:text-white transition-colors whitespace-nowrap px-3">ğŸ’¼ InversiÃ³n</button>
    <button onclick="setTab('pump')"      id="tab-pump"       class="tab-btn flex-1 py-2 rounded-lg text-sm font-medium text-gray-400 hover:text-white transition-colors whitespace-nowrap px-3">ğŸš¨ Detector</button>
  </div>

  <!-- â•â•â•â• MONITOR â•â•â•â• -->
  <div id="content-monitor" class="tab-content" style="display:block">
    <div class="flex flex-wrap gap-3 items-center mb-4">
      <h2 class="text-xl font-semibold flex-1">Monitor en Tiempo Real</h2>
      <!-- Selector de modo -->
      <div class="flex bg-gray-900 border border-gray-700 rounded-lg p-1 gap-1">
        <button onclick="setMode('normal')"      id="mode-normal"      class="mode-btn px-3 py-1.5 rounded text-xs font-semibold bg-blue-700 text-white transition-colors">ğŸ“Š Normal</button>
        <button onclick="setMode('speculative')" id="mode-speculative" class="mode-btn px-3 py-1.5 rounded text-xs font-semibold text-gray-400 hover:text-white transition-colors">ğŸ¯ Especulativo</button>
      </div>
      <button onclick="loadCryptos()" class="bg-green-700 hover:bg-green-600 px-4 py-2 rounded-lg text-sm font-semibold">ğŸ”„ Cargar</button>
      <button onclick="openCycleModal()" id="btn-cycle" disabled
        class="bg-blue-700 hover:bg-blue-600 px-4 py-2 rounded-lg text-sm font-semibold disabled:opacity-40 disabled:cursor-not-allowed">â° Iniciar Ciclo</button>
    </div>
    <!-- DescripciÃ³n del modo -->
    <div id="mode-desc" class="hidden bg-gray-900 border border-yellow-800 rounded-xl p-3 mb-4 text-sm">
      <span class="text-yellow-400 font-semibold">ğŸ¯ Modo Especulativo:</span>
      <span class="text-gray-300"> Filtra activos con Market Cap â‰¤$200M y Volumen â‰¤$50M. Mayor riesgo, mayor potencial de rebote explosivo desde mÃ­nimos.</span>
    </div>
    <div id="market-context" class="hidden bg-gray-900 border border-gray-800 rounded-xl p-4 mb-4">
      <p class="text-xs text-gray-500 mb-2">Contexto de mercado</p>
      <div id="market-headlines" class="space-y-1"></div>
    </div>
    <div id="stats" class="grid grid-cols-4 gap-3 mb-4"></div>
    <p class="text-xs text-gray-600 mb-2">Haz click en un activo para ver anÃ¡lisis completo</p>
    <div id="crypto-list" class="space-y-2"></div>
  </div>

  <!-- â•â•â•â• CONFIG â•â•â•â• -->
  <div id="content-config" class="tab-content">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-semibold">âš™ï¸ ConfiguraciÃ³n del Algoritmo</h2>
      <div class="flex items-center gap-2">
        <span class="text-xs text-gray-500">Editando modelo:</span>
        <button onclick="switchConfigModel('normal')" id="cfgbtn-normal"
          class="cfg-model-btn px-3 py-1.5 rounded-lg text-sm font-semibold bg-blue-700 text-white">ğŸ“Š Generalista</button>
        <button onclick="switchConfigModel('speculative')" id="cfgbtn-speculative"
          class="cfg-model-btn px-3 py-1.5 rounded-lg text-sm font-semibold bg-gray-700 text-gray-300">ğŸ¯ Especulativo</button>
      </div>
    </div>
    <div id="config-model-banner" class="bg-blue-950 border border-blue-800 rounded-xl p-3 mb-4">
      <p class="text-sm text-blue-300 font-semibold" id="config-model-desc">ğŸ“Š Modelo Generalista â€” activos de alta capitalizaciÃ³n y liquidez</p>
      <p class="text-xs text-gray-500 mt-0.5">Los cambios solo afectan a este modelo. Los ciclos de cada modo alimentan su propio modelo de forma independiente.</p>
    </div>
    <div class="bg-gray-900 rounded-xl border border-gray-800 p-5 mb-4">
      <h3 class="font-semibold mb-4 text-blue-400">ğŸ¯ Umbrales de ClasificaciÃ³n</h3>
      <div class="grid grid-cols-2 gap-4">
        <div><label class="text-xs text-gray-400">BoostPower mÃ­nimo INVERTIBLE: <span id="c-inv-min-v" class="text-white font-bold">65%</span></label><input type="range" id="c-inv-min" min="50" max="90" step="5" value="65" oninput="cfgUpdate('c-inv-min','c-inv-min-v','%')" class="w-full mt-1"/></div>
        <div><label class="text-xs text-gray-400">BoostPower mÃ­nimo APALANCADO: <span id="c-apl-min-v" class="text-white font-bold">40%</span></label><input type="range" id="c-apl-min" min="25" max="65" step="5" value="40" oninput="cfgUpdate('c-apl-min','c-apl-min-v','%')" class="w-full mt-1"/></div>
        <div><label class="text-xs text-gray-400">Market Cap mÃ¡x. INVERTIBLE: <span id="c-mcap-v" class="text-white font-bold">$500M</span></label><input type="range" id="c-mcap" min="50" max="5000" step="50" value="500" oninput="cfgUpdateMcap()" class="w-full mt-1"/></div>
        <div><label class="text-xs text-gray-400">Objetivo de subida INVERTIBLE: <span id="c-target-v" class="text-white font-bold">30%</span></label><input type="range" id="c-target" min="10" max="100" step="5" value="30" oninput="cfgUpdate('c-target','c-target-v','%')" class="w-full mt-1"/></div>
        <div><label class="text-xs text-gray-400">Tolerancia magnitud predicciÃ³n: <span id="c-tol-v" class="text-white font-bold">Â±5%</span></label><input type="range" id="c-tol" min="2" max="20" step="1" value="5" oninput="cfgUpdate('c-tol','c-tol-v','%','Â±')" class="w-full mt-1"/></div>
        <div><label class="text-xs text-gray-400">Objetivo subida APALANCADO: <span id="c-apl-target-v" class="text-white font-bold">10%</span></label><input type="range" id="c-apl-target" min="5" max="40" step="5" value="10" oninput="cfgUpdate('c-apl-target','c-apl-target-v','%')" class="w-full mt-1"/></div>
      </div>
    </div>
    <div class="bg-gray-900 rounded-xl border border-gray-800 p-5 mb-4">
      <h3 class="font-semibold mb-4 text-blue-400">âš–ï¸ Meta-pesos</h3>
      <label class="text-xs text-gray-400">Potencial: <span id="c-pot-v" class="text-green-400 font-bold">60%</span> Â· Resistencia: <span id="c-res-v" class="text-red-400 font-bold">40%</span></label>
      <input type="range" id="c-pot" min="30" max="80" step="5" value="60" oninput="updateMetaWeights()" class="w-full mt-2"/>
    </div>
    <div class="bg-gray-900 rounded-xl border border-gray-800 p-5 mb-4">
      <h3 class="font-semibold mb-4 text-blue-400">ğŸ‹ï¸ Pesos de Factores</h3>
      <div class="grid grid-cols-2 gap-5">
        <div><p class="text-xs font-semibold text-green-400 mb-3">â¬†ï¸ Potencial</p><div id="potential-sliders" class="space-y-2"></div></div>
        <div><p class="text-xs font-semibold text-red-400 mb-3">â¬‡ï¸ Resistencia</p><div id="resistance-sliders" class="space-y-2"></div></div>
      </div>
    </div>
    <div class="flex gap-3">
      <button onclick="saveConfig()" class="bg-green-700 hover:bg-green-600 px-6 py-2 rounded-lg font-semibold">ğŸ’¾ Guardar</button>
      <button onclick="resetConfig()" class="bg-yellow-700 hover:bg-yellow-600 px-6 py-2 rounded-lg font-semibold">ğŸ”„ Resetear</button>
    </div>
    <div id="config-msg" class="mt-3 text-sm"></div>
  </div>

  <!-- â•â•â•â• VALIDACIÃ“N â•â•â•â• -->
  <div id="content-validation" class="tab-content">
    <h2 class="text-xl font-semibold mb-4">âœ… ValidaciÃ³n de Ciclos</h2>
    <!-- Leyenda de significatividad -->
    <div class="bg-gray-900 border border-gray-800 rounded-xl p-4 mb-5 text-sm">
      <p class="text-xs font-semibold text-gray-400 mb-2">ğŸ“Œ Criterio de significatividad</p>
      <div class="flex gap-4">
        <span class="pill bg-green-900 text-green-300">â­â­ â‰¥6h â€” Significativo</span>
        <span class="text-gray-500">Se usa para calibrar el algoritmo</span>
      </div>
      <div class="flex gap-4 mt-1">
        <span class="pill bg-gray-800 text-gray-400">âš—ï¸ &lt;6h â€” Testing</span>
        <span class="text-gray-500">Valida tendencia, no corrige pesos</span>
      </div>
    </div>
    <div class="mb-5"><h3 class="text-sm font-semibold text-blue-400 mb-3">ğŸ”„ Ciclos Activos</h3><div id="active-cycles"><p class="text-gray-500 text-sm">Sin ciclos activos</p></div></div>
    <div class="mb-5"><h3 class="text-sm font-semibold text-green-400 mb-3">ğŸ“‹ Historial</h3><div id="completed-cycles"><p class="text-gray-500 text-sm">Sin ciclos completados</p></div></div>
    <div><h3 class="text-sm font-semibold text-purple-400 mb-3">ğŸ“Š EstadÃ­sticas Globales</h3><div id="global-stats"></div></div>
  </div>

  <!-- â•â•â•â• ANÃLISIS â•â•â•â• -->
  <div id="content-analysis" class="tab-content">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-semibold">ğŸ”¬ AnÃ¡lisis de Simulaciones</h2>
      <div class="flex items-center gap-3">
        <span class="text-sm text-gray-500">Modelo:</span>
        <select id="analysis-mode-select" onchange="switchAnalysisMode(this.value)" class="bg-gray-800 border border-gray-700 rounded px-3 py-1.5 text-sm">
          <option value="normal">ğŸ“Š Generalista</option>
          <option value="speculative">ğŸ¯ Especulativo</option>
        </select>
        <button onclick="loadAnalysis()" class="bg-blue-700 hover:bg-blue-600 px-4 py-2 rounded-lg text-sm font-semibold">ğŸ”„ Analizar</button>
      </div>
    </div>
    <div id="analysis-mode-info" class="bg-blue-950 border border-blue-800 rounded-lg p-3 mb-4">
      <p class="text-sm text-blue-300">Analizando ciclos del modelo <span id="analysis-mode-label" class="font-bold">Generalista</span></p>
    </div>
    <div class="bg-gray-900 border border-gray-700 rounded-xl p-4 mb-5 text-sm">
      <p class="text-gray-400 font-semibold mb-1">ğŸ“Œ CÃ³mo funciona</p>
      <p class="text-gray-500">Solo simulaciones <strong class="text-white">â‰¥6 horas</strong> calibran el algoritmo. Las ejecuciones cortas (&lt;6h) validan la tendencia proporcionalmente pero <strong class="text-yellow-400">no corrigen los pesos</strong>. Las predicciones se escalan automÃ¡ticamente a la ventana temporal del ciclo.</p>
    </div>
    <div id="analysis-content">
      <p class="text-gray-500 text-sm">Haz click en "Analizar" para procesar los resultados.</p>
    </div>

    <!-- â•â• INSIGHTS â€” LOS N SABIOS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="mt-8 pt-6 border-t border-gray-800">
      <div class="flex justify-between items-center mb-4">
        <div>
          <h3 class="text-lg font-bold text-purple-400">ğŸ§  Los N Sabios â€” Consenso de Agentes IA</h3>
          <p class="text-xs text-gray-500 mt-1">Analiza ciclos histÃ³ricos con Gemini, Claude, GPT-4 y Llama para obtener recomendaciones de consenso</p>
        </div>
        <button onclick="openInsightsModal()" class="bg-purple-700 hover:bg-purple-600 px-4 py-2 rounded-lg text-sm font-semibold">
          ğŸš€ Analizar con LLMs
        </button>
      </div>
      <div id="insights-result" class="hidden">
        <!-- El resultado del anÃ¡lisis se renderiza aquÃ­ -->
      </div>
    </div>
  </div>

  <!-- â•â•â•â• APIs â•â•â•â• -->
  <div id="content-status" class="tab-content">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-semibold">ğŸ”Œ Estado de APIs</h2>
      <div class="flex gap-2">
        <button onclick="loadAPIStatus()" class="bg-blue-700 hover:bg-blue-600 px-4 py-2 rounded-lg text-sm">ğŸ”„ Actualizar</button>
        <button onclick="runDebug()" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg text-sm">ğŸ”§ Debug</button>
      </div>
    </div>
    <div id="debug-panel" class="hidden bg-gray-900 border border-yellow-700 rounded-xl p-4 mb-5 text-sm mono"></div>
    <div id="api-summary" class="grid grid-cols-4 gap-3 mb-5"></div>
    <div class="space-y-5">
      <div><h3 class="text-sm font-semibold text-green-400 mb-2">ğŸŸ¢ FREE</h3><div id="apis-free" class="space-y-2"></div></div>
      <div><h3 class="text-sm font-semibold text-yellow-400 mb-2">ğŸŸ¡ FREEMIUM</h3><div id="apis-freemium" class="space-y-2"></div></div>
      <div><h3 class="text-sm font-semibold text-orange-400 mb-2">ğŸŸ  PAID</h3><div id="apis-paid" class="space-y-2"></div></div>
      <div><h3 class="text-sm font-semibold text-red-400 mb-2">ğŸ”´ PREMIUM</h3><div id="apis-premium" class="space-y-2"></div></div>

      <!-- â•â•â• AGENTES IA â€” Estado de conexiÃ³n â•â•â• -->
      <div class="bg-gray-900 border border-purple-900/40 rounded-2xl p-5">
        <div class="flex items-center justify-between mb-1">
          <h3 class="text-sm font-bold text-purple-400">ğŸ§  Agentes IA â€” "Los N Sabios"</h3>
          <div id="llm-global-badge" class="text-xs"></div>
        </div>
        <p class="text-xs text-gray-500 mb-4">Agentes de inteligencia artificial para consenso de anÃ¡lisis. Se necesitan â‰¥2 para calcular consenso.</p>
        <div id="llm-agents-status-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
          <!-- Renderizado dinÃ¡micamente por renderLLMAgentsStatus() -->
          <p class="text-gray-600 text-sm col-span-3">â³ Verificando agentes...</p>
        </div>
      </div>

      <!-- LLMs para Insights â€” configuraciÃ³n -->
      <div>
        <h3 class="text-sm font-semibold text-purple-400 mb-2">ğŸ§  LLMs para Insights (Opcional)</h3>
        <p class="text-xs text-gray-500 mb-3">Configura al menos 2 APIs para usar "3 Sabios Recomiendan"</p>
        <div class="space-y-3">
          <!-- Gemini -->
          <div class="bg-gray-900 border border-gray-800 rounded-xl p-4">
            <div class="flex items-center gap-2 mb-2">
              <span class="text-sm font-semibold">ğŸ”· Google Gemini</span>
              <span class="pill bg-blue-950 text-blue-400 text-xs">FREE</span>
            </div>
            <input type="password" id="api-key-gemini" placeholder="AIza..." class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm mb-2">
            <div class="flex gap-2">
              <button onclick="saveAPIKey('GEMINI_API_KEY', 'api-key-gemini')" class="bg-blue-700 hover:bg-blue-600 px-3 py-1 rounded text-xs">ğŸ’¾ Guardar</button>
              <a href="https://aistudio.google.com/apikey" target="_blank" class="text-xs text-blue-400 hover:underline flex items-center">Obtener key â†’</a>
            </div>
          </div>
          
          <!-- Claude -->
          <div class="bg-gray-900 border border-gray-800 rounded-xl p-4">
            <div class="flex items-center gap-2 mb-2">
              <span class="text-sm font-semibold">ğŸŸ£ Anthropic Claude</span>
              <span class="pill bg-purple-950 text-purple-400 text-xs">PAID</span>
            </div>
            <input type="password" id="api-key-claude" placeholder="sk-ant-..." class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm mb-2">
            <div class="flex gap-2">
              <button onclick="saveAPIKey('ANTHROPIC_API_KEY', 'api-key-claude')" class="bg-purple-700 hover:bg-purple-600 px-3 py-1 rounded text-xs">ğŸ’¾ Guardar</button>
              <a href="https://console.anthropic.com/settings/keys" target="_blank" class="text-xs text-purple-400 hover:underline flex items-center">Obtener key â†’</a>
            </div>
          </div>
          
          <!-- OpenAI -->
          <div class="bg-gray-900 border border-gray-800 rounded-xl p-4">
            <div class="flex items-center gap-2 mb-2">
              <span class="text-sm font-semibold">ğŸŸ¢ OpenAI GPT-4</span>
              <span class="pill bg-green-950 text-green-400 text-xs">PAID</span>
            </div>
            <input type="password" id="api-key-openai" placeholder="sk-proj-..." class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm mb-2">
            <div class="flex gap-2">
              <button onclick="saveAPIKey('OPENAI_API_KEY', 'api-key-openai')" class="bg-green-700 hover:bg-green-600 px-3 py-1 rounded text-xs">ğŸ’¾ Guardar</button>
              <a href="https://platform.openai.com/api-keys" target="_blank" class="text-xs text-green-400 hover:underline flex items-center">Obtener key â†’</a>
            </div>
          </div>
          
          <!-- Groq Llama -->
          <div class="bg-gray-900 border border-gray-800 rounded-xl p-4">
            <div class="flex items-center gap-2 mb-2">
              <span class="text-sm font-semibold">ğŸŸ  Groq Llama</span>
              <span class="pill bg-orange-950 text-orange-400 text-xs">FREE</span>
            </div>
            <input type="password" id="api-key-groq" placeholder="gsk_..." class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm mb-2">
            <div class="flex gap-2">
              <button onclick="saveAPIKey('GROQ_API_KEY', 'api-key-groq')" class="bg-orange-700 hover:bg-orange-600 px-3 py-1 rounded text-xs">ğŸ’¾ Guardar</button>
              <a href="https://console.groq.com/keys" target="_blank" class="text-xs text-orange-400 hover:underline flex items-center">Obtener key â†’</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- â•â•â•â• INVERSIÃ“N â•â•â•â• -->
  <div id="content-invest" class="tab-content">

    <!-- Header con modo badge -->
    <div class="flex flex-wrap justify-between items-center mb-4 gap-3">
      <div class="flex items-center gap-3">
        <h2 class="text-xl font-semibold">ğŸ’¼ MÃ³dulo de InversiÃ³n</h2>
        <span id="inv-mode-badge" class="pill bg-blue-900 text-blue-300">âš—ï¸ Simulado</span>
        <span id="inv-exchange-badge" class="pill bg-gray-800 text-gray-300">Binance</span>
      </div>
      <div class="flex gap-2">
        <button onclick="loadInvestData()" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg text-sm">ğŸ”„ Actualizar</button>
        <button onclick="openTab('inv-config')" class="bg-blue-700 hover:bg-blue-600 px-4 py-2 rounded-lg text-sm">âš™ï¸ Configurar</button>
        <button onclick="pingExchange()" class="bg-green-700 hover:bg-green-600 px-4 py-2 rounded-lg text-sm">ğŸ”— Test Exchange</button>
      </div>
    </div>

    <!-- Alerta modo real -->
    <div id="inv-real-warning" class="hidden bg-red-950 border border-red-700 rounded-xl p-4 mb-4">
      <p class="text-red-400 font-semibold">âš ï¸ MODO REAL ACTIVO â€” Las operaciones se ejecutarÃ¡n con dinero real</p>
      <p class="text-red-300 text-sm mt-1">AsegÃºrate de que las claves de exchange son correctas y el capital configurado es el deseado.</p>
    </div>

    <!-- Sub-tabs -->
    <div class="flex gap-1 mb-5 bg-gray-900 p-1 rounded-xl border border-gray-800">
      <button onclick="openTab('inv-overview')"    id="invtab-inv-overview"    class="invtab flex-1 py-1.5 rounded-lg text-sm font-medium text-gray-400 hover:text-white transition-colors">ğŸ“Š Resumen</button>
      <button onclick="openTab('inv-positions')"   id="invtab-inv-positions"   class="invtab flex-1 py-1.5 rounded-lg text-sm font-medium text-gray-400 hover:text-white transition-colors">ğŸ“‹ Posiciones</button>
      <button onclick="openTab('inv-performance')" id="invtab-inv-performance" class="invtab flex-1 py-1.5 rounded-lg text-sm font-medium text-gray-400 hover:text-white transition-colors">ğŸ“ˆ Rendimiento</button>
      <button onclick="openTab('inv-config')"      id="invtab-inv-config"      class="invtab flex-1 py-1.5 rounded-lg text-sm font-medium text-gray-400 hover:text-white transition-colors">âš™ï¸ Config</button>
      <button onclick="openTab('inv-log')"         id="invtab-inv-log"         class="invtab flex-1 py-1.5 rounded-lg text-sm font-medium text-gray-400 hover:text-white transition-colors">ğŸ“œ Log</button>
      <button onclick="openTab('inv-rounds')"      id="invtab-inv-rounds"      class="invtab flex-1 py-1.5 rounded-lg text-sm font-medium text-gray-400 hover:text-white transition-colors">ğŸ¯ Rondas</button>
    </div>

    <!-- Resumen -->
    <div id="inv-overview" class="inv-subtab">
      <div id="inv-capital-grid" class="grid grid-cols-4 gap-3 mb-5"></div>
      <!-- DecisiÃ³n manual (con datos del monitor) -->
      <div class="bg-gray-900 border border-gray-800 rounded-xl p-5 mb-5">
        <div class="flex justify-between items-center mb-3">
          <div>
            <p class="font-semibold">ğŸ¤– DecisiÃ³n de inversiÃ³n</p>
            <p class="text-xs text-gray-500 mt-0.5">Basada en el snapshot actual del monitor</p>
          </div>
          <button onclick="decideCycle()" id="btn-decide"
            class="bg-blue-700 hover:bg-blue-600 px-4 py-2 rounded-lg text-sm font-semibold disabled:opacity-40">
            ğŸ¯ Analizar & Decidir
          </button>
        </div>
        <div id="inv-decision" class="text-gray-500 text-sm">Haz click en "Analizar & Decidir" con activos cargados en el monitor.</div>
      </div>
      <!-- Posiciones abiertas resumen -->
      <div>
        <p class="text-sm font-semibold mb-3">ğŸ”“ Posiciones abiertas</p>
        <div id="inv-open-summary"><p class="text-gray-500 text-sm">Sin posiciones abiertas.</p></div>
      </div>
    </div>

    <!-- Posiciones -->
    <div id="inv-positions" class="inv-subtab hidden">
      <!-- Banner de ronda activa -->
      <div id="inv-round-banner" class="hidden mb-4 bg-indigo-950/60 border border-indigo-800 rounded-xl p-3">
        <div class="flex items-center justify-between flex-wrap gap-2">
          <div>
            <p class="text-sm font-semibold text-indigo-300">ğŸ¯ <span id="inv-round-label">Ronda #1 activa</span></p>
            <p class="text-xs text-gray-400 mt-0.5" id="inv-round-info">Iniciada â€”</p>
          </div>
          <div class="flex gap-2">
            <button onclick="evaluateCycle()" class="bg-orange-800 hover:bg-orange-700 px-3 py-1.5 rounded-lg text-xs font-semibold">
              ğŸ”¬ Diagnosticar
            </button>
            <button onclick="openCloseRoundModal()" class="bg-red-800 hover:bg-red-700 px-3 py-1.5 rounded-lg text-xs font-semibold">
              ğŸ Cerrar Ronda
            </button>
          </div>
        </div>
      </div>
      <!-- Sin ronda activa -->
      <div id="inv-no-round-banner" class="hidden mb-4 bg-gray-900 border border-gray-700 border-dashed rounded-xl p-3 text-center">
        <p class="text-sm text-gray-500 mb-2">Sin ronda de inversiÃ³n activa</p>
        <button onclick="openNewRoundWizard()" class="bg-indigo-700 hover:bg-indigo-600 px-4 py-2 rounded-lg text-sm font-semibold">
          ğŸš€ Abrir Nueva Ronda
        </button>
      </div>
      <div class="flex justify-between items-center mb-4">
        <p class="font-semibold">Posiciones</p>
        <button onclick="evaluateCycle()" class="bg-orange-700 hover:bg-orange-600 px-4 py-2 rounded-lg text-sm font-semibold">
          âš–ï¸ Evaluar ciclo actual
        </button>
      </div>
      <div id="inv-positions-open" class="mb-5">
        <p class="text-xs font-semibold text-green-400 mb-2">ABIERTAS</p>
        <div id="inv-pos-open-list"><p class="text-gray-500 text-sm">â€”</p></div>
      </div>
      <div id="inv-positions-closed">
        <p class="text-xs font-semibold text-gray-400 mb-2">CERRADAS (Ãºltimas 20)</p>
        <div id="inv-pos-closed-list"><p class="text-gray-500 text-sm">â€”</p></div>
      </div>
    </div>

    <!-- Rendimiento -->
    <div id="inv-performance" class="inv-subtab hidden">
      <!-- CalibraciÃ³n del modelo de predicciÃ³n -->
      <div id="inv-calibration-panel" class="mb-5 bg-gray-900 border border-gray-800 rounded-xl p-4">
        <div class="flex items-center justify-between mb-3">
          <div>
            <p class="text-sm font-semibold text-purple-300">ğŸ§ª CalibraciÃ³n del Modelo de PredicciÃ³n</p>
            <p class="text-xs text-gray-500 mt-0.5">El algoritmo aprende de cada ejecuciÃ³n real para mejorar sus previsiones</p>
          </div>
          <div class="flex gap-2">
            <button onclick="loadCalibrationStatus()" class="bg-gray-700 hover:bg-gray-600 px-3 py-1.5 rounded-lg text-xs">ğŸ”„ Estado</button>
            <button onclick="rebuildCalibration()" class="bg-purple-800 hover:bg-purple-700 px-3 py-1.5 rounded-lg text-xs font-semibold">âš™ï¸ Recalibrar</button>
          </div>
        </div>
        <div id="inv-calibration-content"><p class="text-gray-600 text-xs">Clic en "Estado" para ver la calibraciÃ³n actual</p></div>
      </div>
      <div id="inv-perf-content"><p class="text-gray-500 text-sm">Cargando rendimiento...</p></div>
    </div>

    <!-- Config -->
    <div id="inv-config" class="inv-subtab hidden">
      <div class="space-y-5">
        <!-- Modo y Exchange -->
        <div class="bg-gray-900 border border-gray-800 rounded-xl p-5">
          <h3 class="font-semibold text-blue-400 mb-4">ğŸ”§ Modo de operaciÃ³n</h3>
          <div class="grid grid-cols-2 gap-5">
            <div>
              <p class="text-xs text-gray-400 mb-2">Modo</p>
              <div class="flex gap-2">
                <button onclick="setInvestMode('simulated')" id="imode-simulated"
                  class="imode-btn flex-1 py-2 rounded-lg text-sm font-semibold bg-blue-700 text-white">âš—ï¸ Simulado</button>
                <button onclick="setInvestMode('testnet')" id="imode-testnet"
                  class="imode-btn flex-1 py-2 rounded-lg text-sm font-semibold bg-gray-700 text-gray-300">ğŸ§ª Testnet</button>
                <button onclick="setInvestMode('real')" id="imode-real"
                  class="imode-btn flex-1 py-2 rounded-lg text-sm font-semibold bg-gray-700 text-gray-300">ğŸ’µ Real</button>
              </div>
            </div>
            <div>
              <p class="text-xs text-gray-400 mb-2">Exchange</p>
              <div class="flex gap-2">
                <button onclick="setInvestExchange('binance')" id="iex-binance"
                  class="iex-btn flex-1 py-2 rounded-lg text-sm font-semibold bg-yellow-700 text-white">ğŸŸ¡ Binance</button>
                <button onclick="setInvestExchange('coinbase')" id="iex-coinbase"
                  class="iex-btn flex-1 py-2 rounded-lg text-sm font-semibold bg-gray-700 text-gray-300">ğŸ”µ Coinbase</button>
              </div>
            </div>
          </div>
        </div>

        <!-- API Keys de Exchange -->
        <div class="bg-gray-900 border border-gray-800 rounded-xl p-5">
          <h3 class="font-semibold text-yellow-400 mb-4">ğŸ”‘ Claves del Exchange</h3>
          <p class="text-xs text-gray-500 mb-3">Las claves se guardan en Redis (encriptadas). Para testnet de Binance: <a href="https://testnet.binance.vision" target="_blank" class="text-blue-400">testnet.binance.vision</a></p>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="text-xs text-gray-400">Binance API Key</label>
              <div class="flex gap-2 mt-1">
                <input type="password" id="binance-api-key" placeholder="Pega tu API key..."
                  class="flex-1 bg-gray-800 rounded-lg px-3 py-2 text-sm mono"/>
                <button onclick="saveExchangeKey('BINANCE_API_KEY','binance-api-key')"
                  class="bg-yellow-700 hover:bg-yellow-600 px-3 py-2 rounded-lg text-xs font-semibold">ğŸ’¾</button>
              </div>
            </div>
            <div>
              <label class="text-xs text-gray-400">Binance Secret Key</label>
              <div class="flex gap-2 mt-1">
                <input type="password" id="binance-secret-key" placeholder="Pega tu Secret key..."
                  class="flex-1 bg-gray-800 rounded-lg px-3 py-2 text-sm mono"/>
                <button onclick="saveExchangeKey('BINANCE_SECRET_KEY','binance-secret-key')"
                  class="bg-yellow-700 hover:bg-yellow-600 px-3 py-2 rounded-lg text-xs font-semibold">ğŸ’¾</button>
              </div>
            </div>
            <div>
              <label class="text-xs text-gray-400">Coinbase API Key</label>
              <div class="flex gap-2 mt-1">
                <input type="password" id="coinbase-api-key" placeholder="Pega tu API key..."
                  class="flex-1 bg-gray-800 rounded-lg px-3 py-2 text-sm mono"/>
                <button onclick="saveExchangeKey('COINBASE_API_KEY','coinbase-api-key')"
                  class="bg-blue-700 hover:bg-blue-600 px-3 py-2 rounded-lg text-xs font-semibold">ğŸ’¾</button>
              </div>
            </div>
            <div>
              <label class="text-xs text-gray-400">Coinbase Secret Key</label>
              <div class="flex gap-2 mt-1">
                <input type="password" id="coinbase-secret-key" placeholder="Pega tu Secret key..."
                  class="flex-1 bg-gray-800 rounded-lg px-3 py-2 text-sm mono"/>
                <button onclick="saveExchangeKey('COINBASE_SECRET_KEY','coinbase-secret-key')"
                  class="bg-blue-700 hover:bg-blue-600 px-3 py-2 rounded-lg text-xs font-semibold">ğŸ’¾</button>
              </div>
            </div>
          </div>
          <div id="exchange-key-msg" class="text-sm mt-2"></div>
        </div>

        <!-- ParÃ¡metros de inversiÃ³n -->
        <div class="bg-gray-900 border border-gray-800 rounded-xl p-5">
          <h3 class="font-semibold text-green-400 mb-4">ğŸ’° ParÃ¡metros de inversiÃ³n</h3>
          <div class="grid grid-cols-2 gap-5">
            <div>
              <label class="text-xs text-gray-400">Capital total (USD): <span id="ic-capital-v" class="text-white font-bold">$1000</span></label>
              <input type="number" id="ic-capital" value="1000" min="10" max="1000000" step="10"
                oninput="document.getElementById('ic-capital-v').textContent='$'+this.value"
                class="w-full bg-gray-800 rounded-lg px-3 py-2 text-sm mono mt-1"/>
            </div>
            <div>
              <label class="text-xs text-gray-400">Capital por ciclo: <span id="ic-percycle-v" class="text-white font-bold">30%</span></label>
              <input type="range" id="ic-percycle" min="5" max="100" step="5" value="30"
                oninput="document.getElementById('ic-percycle-v').textContent=this.value+'%'" class="w-full mt-2"/>
            </div>
            <div>
              <label class="text-xs text-gray-400">Posiciones mÃ¡ximas por ciclo: <span id="ic-maxpos-v" class="text-white font-bold">3</span></label>
              <input type="range" id="ic-maxpos" min="1" max="10" step="1" value="3"
                oninput="document.getElementById('ic-maxpos-v').textContent=this.value" class="w-full mt-2"/>
            </div>
            <div>
              <label class="text-xs text-gray-400">MÃ­nimo de seÃ±ales para operar: <span id="ic-minsig-v" class="text-white font-bold">2</span></label>
              <input type="range" id="ic-minsig" min="1" max="5" step="1" value="2"
                oninput="document.getElementById('ic-minsig-v').textContent=this.value" class="w-full mt-2"/>
            </div>
          </div>
        </div>

        <!-- Umbrales de decisiÃ³n -->
        <div class="bg-gray-900 border border-gray-800 rounded-xl p-5">
          <h3 class="font-semibold text-orange-400 mb-4">ğŸ¯ Umbrales de venta</h3>
          <div class="grid grid-cols-2 gap-5">
            <div>
              <label class="text-xs text-gray-400">Take Profit: <span id="ic-tp-v" class="text-green-400 font-bold">+10%</span></label>
              <input type="range" id="ic-tp" min="2" max="50" step="1" value="10"
                oninput="document.getElementById('ic-tp-v').textContent='+'+this.value+'%'" class="w-full mt-2"/>
            </div>
            <div>
              <label class="text-xs text-gray-400">Stop Loss: <span id="ic-sl-v" class="text-red-400 font-bold">âˆ’5%</span></label>
              <input type="range" id="ic-sl" min="1" max="30" step="1" value="5"
                oninput="document.getElementById('ic-sl-v').textContent='âˆ’'+this.value+'%'" class="w-full mt-2"/>
            </div>
            <div>
              <label class="text-xs text-gray-400">Ciclos mÃ¡x. sin vender: <span id="ic-hold-v" class="text-yellow-400 font-bold">3</span></label>
              <input type="range" id="ic-hold" min="1" max="10" step="1" value="3"
                oninput="document.getElementById('ic-hold-v').textContent=this.value" class="w-full mt-2"/>
            </div>
            <div>
              <label class="text-xs text-gray-400">BoostPower mÃ­nimo para invertir: <span id="ic-bp-v" class="text-blue-400 font-bold">65%</span></label>
              <input type="range" id="ic-bp" min="50" max="90" step="5" value="65"
                oninput="document.getElementById('ic-bp-v').textContent=this.value+'%'" class="w-full mt-2"/>
            </div>
          </div>
        </div>

        <div class="flex gap-3">
          <button onclick="saveInvestConfig()" class="bg-green-700 hover:bg-green-600 px-6 py-2 rounded-lg font-semibold">ğŸ’¾ Guardar configuraciÃ³n</button>
        </div>
        <div id="inv-config-msg" class="text-sm"></div>
      </div>
    </div>

    <!-- Log -->
    <div id="inv-log" class="inv-subtab hidden">
      <!-- Barra de controles del log -->
      <div class="flex flex-wrap items-center justify-between gap-2 mb-4">
        <div class="flex flex-wrap gap-1">
          <button data-filter="all"          onclick="setLogFilter('all')"         class="log-filter-btn px-2.5 py-1 rounded text-xs bg-gray-700 text-white transition-colors">Todos</button>
          <button data-filter="invest"       onclick="setLogFilter('invest')"      class="log-filter-btn px-2.5 py-1 rounded text-xs text-gray-500 bg-transparent transition-colors">ğŸ’° InversiÃ³n</button>
          <button data-filter="evaluate"     onclick="setLogFilter('evaluate')"    class="log-filter-btn px-2.5 py-1 rounded text-xs text-gray-500 bg-transparent transition-colors">âš–ï¸ EvaluaciÃ³n</button>
          <button data-filter="no_invest"    onclick="setLogFilter('no_invest')"   class="log-filter-btn px-2.5 py-1 rounded text-xs text-gray-500 bg-transparent transition-colors">â¸ï¸ Sin inv.</button>
          <button data-filter="manual_close" onclick="setLogFilter('manual_close')" class="log-filter-btn px-2.5 py-1 rounded text-xs text-gray-500 bg-transparent transition-colors">ğŸ”’ Manual</button>
          <button data-filter="watchdog_close" onclick="setLogFilter('watchdog_close')" class="log-filter-btn px-2.5 py-1 rounded text-xs text-gray-500 bg-transparent transition-colors">ğŸ”” WD Cierre</button>
          <button data-filter="watchdog_scan"  onclick="setLogFilter('watchdog_scan')"  class="log-filter-btn px-2.5 py-1 rounded text-xs text-gray-500 bg-transparent transition-colors">ğŸ” WD Scan</button>
        </div>
        <div class="flex gap-2">
          <button onclick="exportInvestLog()"
            class="bg-gray-800 hover:bg-gray-700 px-3 py-1.5 rounded-lg text-xs font-semibold text-gray-300">
            â¬‡ Exportar JSON
          </button>
          <button id="btn-analyze-sabios" onclick="analyzeLogWithSabios()"
            class="bg-purple-800 hover:bg-purple-700 px-3 py-1.5 rounded-lg text-xs font-semibold text-white disabled:opacity-40">
            ğŸ§  Analizar con Sabios
          </button>
        </div>
      </div>
      <!-- Entradas del log -->
      <div id="inv-log-content"><p class="text-gray-500 text-sm">Cargando...</p></div>
      <!-- Resultado anÃ¡lisis Sabios -->
      <div id="inv-log-sabios-result"></div>
    </div>

    <!-- Rondas -->
    <div id="inv-rounds" class="inv-subtab hidden">
      <div class="flex justify-between items-center mb-4">
        <div>
          <p class="font-semibold">ğŸ¯ Rondas de InversiÃ³n</p>
          <p class="text-xs text-gray-500 mt-0.5">Historial de ciclos completos de inversiÃ³n</p>
        </div>
        <button onclick="openNewRoundWizard()" class="bg-indigo-700 hover:bg-indigo-600 px-4 py-2 rounded-lg text-sm font-semibold">
          ğŸš€ Nueva Ronda
        </button>
      </div>
      <!-- Ronda activa -->
      <div id="inv-rounds-active" class="mb-4"></div>
      <!-- Historial -->
      <div id="inv-rounds-history"><p class="text-gray-500 text-sm">Cargando...</p></div>
    </div>

  </div><!-- /content-invest -->

  <!-- â•â•â•â• DETECTOR DE PUMP COORDINADO â•â•â•â• -->
  <div id="content-pump" class="tab-content">

    <!-- Header -->
    <div class="flex flex-wrap justify-between items-center mb-4 gap-3">
      <div>
        <h2 class="text-xl font-semibold">ğŸš¨ Detector de Especulaciones Externas</h2>
        <p class="text-xs text-gray-500 mt-0.5">DetecciÃ³n automÃ¡tica de Pump Coordinado en small-caps Â· Escaneo cada 6h</p>
      </div>
      <div class="flex gap-2 flex-wrap">
        <button onclick="loadPumpScan()" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg text-sm">ğŸ“‹ Ver Ãºltimo</button>
        <button onclick="runPumpScan()" id="btn-pump-scan" class="bg-red-700 hover:bg-red-600 px-4 py-2 rounded-lg text-sm font-semibold">ğŸ” Escanear ahora</button>
        <button onclick="openPumpTab('pump-config')" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg text-sm">âš™ï¸ Config</button>
      </div>
    </div>

    <!-- Resumen del Ãºltimo escaneo -->
    <div id="pump-scan-meta" class="bg-gray-900 border border-gray-800 rounded-xl p-4 mb-4 hidden">
      <div class="flex justify-between items-center">
        <div>
          <span id="pump-scan-time" class="text-sm text-gray-400"></span>
          <span id="pump-scan-count" class="ml-3 text-sm"></span>
        </div>
        <div id="pump-scheduler-badge" class="pill bg-gray-800 text-gray-400 text-xs">â° Scheduler</div>
      </div>
    </div>

    <!-- Sub-tabs -->
    <div class="flex gap-1 mb-5 bg-gray-900 p-1 rounded-xl border border-gray-800">
      <button onclick="openPumpTab('pump-results')"  id="pumptab-pump-results"  class="pumptab flex-1 py-1.5 rounded-lg text-sm font-medium text-gray-400 hover:text-white transition-colors">ğŸ” Detecciones</button>
      <button onclick="openPumpTab('pump-history')"  id="pumptab-pump-history"  class="pumptab flex-1 py-1.5 rounded-lg text-sm font-medium text-gray-400 hover:text-white transition-colors">ğŸ“œ Historial</button>
      <button onclick="openPumpTab('pump-config')"   id="pumptab-pump-config"   class="pumptab flex-1 py-1.5 rounded-lg text-sm font-medium text-gray-400 hover:text-white transition-colors">âš™ï¸ Config & Email</button>
    </div>

    <!-- Detecciones -->
    <div id="pump-results" class="pumptab-content">

      <!-- Leyenda de scoring -->
      <div class="grid grid-cols-3 gap-3 mb-5">
        <div class="bg-green-950 border border-green-900 rounded-xl p-3 text-center">
          <div class="text-xs text-gray-500 mb-1">Score 0â€“3</div>
          <div class="text-green-400 font-bold">âœ… NORMAL</div>
          <div class="text-xs text-gray-500 mt-1">Sin seÃ±ales significativas</div>
        </div>
        <div class="bg-orange-950 border border-orange-900 rounded-xl p-3 text-center">
          <div class="text-xs text-gray-500 mb-1">Score 4â€“6</div>
          <div class="text-orange-400 font-bold">âš ï¸ SOSPECHOSO</div>
          <div class="text-xs text-gray-500 mt-1">Investigar manualmente</div>
        </div>
        <div class="bg-red-950 border border-red-900 rounded-xl p-3 text-center">
          <div class="text-xs text-gray-500 mb-1">Score 7+</div>
          <div class="text-red-400 font-bold">ğŸš¨ PUMP CASI SEGURO</div>
          <div class="text-xs text-gray-500 mt-1">Alta probabilidad de manipulaciÃ³n</div>
        </div>
      </div>

      <div id="pump-detections-list">
        <div class="text-center py-10">
          <p class="text-gray-500 text-sm mb-3">Sin escaneo reciente.</p>
          <button onclick="runPumpScan()" class="bg-red-700 hover:bg-red-600 px-6 py-2 rounded-lg text-sm font-semibold">ğŸ” Iniciar primer escaneo</button>
        </div>
      </div>
    </div>

    <!-- Historial -->
    <div id="pump-history" class="pumptab-content hidden">
      <div id="pump-history-list"><p class="text-gray-500 text-sm">Cargando historial...</p></div>
    </div>

    <!-- Config & Email -->
    <div id="pump-config" class="pumptab-content hidden">
      <div class="space-y-5">

        <!-- Ajustes del detector -->
        <div class="bg-gray-900 border border-gray-800 rounded-xl p-5">
          <h3 class="font-semibold text-blue-400 mb-4">âš™ï¸ Ajustes del Detector</h3>
          <div class="grid grid-cols-2 gap-5">
            <div class="col-span-2 flex items-center gap-3">
              <label class="text-sm text-gray-400">Detector activo</label>
              <button onclick="toggleDetector()" id="btn-detector-toggle"
                class="bg-green-700 hover:bg-green-600 px-4 py-2 rounded-lg text-sm font-semibold">âœ… Activado</button>
            </div>
            <div>
              <label class="text-xs text-gray-400">Frecuencia de escaneo: <span id="pc-interval-v" class="text-white font-bold">6h</span></label>
              <input type="range" id="pc-interval" min="1" max="24" step="1" value="6"
                oninput="document.getElementById('pc-interval-v').textContent=this.value+'h'" class="w-full mt-2"/>
            </div>
            <div>
              <label class="text-xs text-gray-400">Score mÃ­nimo para alerta email: <span id="pc-minscore-v" class="text-white font-bold">4</span></label>
              <input type="range" id="pc-minscore" min="2" max="9" step="1" value="4"
                oninput="document.getElementById('pc-minscore-v').textContent=this.value" class="w-full mt-2"/>
            </div>
          </div>
          <button onclick="savePumpSettings()" class="mt-4 bg-blue-700 hover:bg-blue-600 px-6 py-2 rounded-lg text-sm font-semibold">ğŸ’¾ Guardar ajustes</button>
          <div id="pump-settings-msg" class="text-sm mt-2"></div>
        </div>

        <!-- ConfiguraciÃ³n de email -->
        <div class="bg-gray-900 border border-gray-800 rounded-xl p-5">
          <h3 class="font-semibold text-yellow-400 mb-1">ğŸ“§ Alertas por Email</h3>
          <p class="text-xs text-gray-500 mb-4">Se envÃ­a automÃ¡ticamente si se detecta un pump con el score configurado. Usa Gmail con <a href="https://myaccount.google.com/apppasswords" target="_blank" class="text-blue-400">App Password</a> o cualquier SMTP.</p>
          <div class="grid grid-cols-2 gap-4 mb-4">
            <div>
              <label class="text-xs text-gray-400">SMTP Host</label>
              <input type="text" id="pe-host" placeholder="smtp.gmail.com" value="smtp.gmail.com"
                class="w-full bg-gray-800 rounded-lg px-3 py-2 text-sm mono mt-1"/>
            </div>
            <div>
              <label class="text-xs text-gray-400">Puerto</label>
              <input type="number" id="pe-port" placeholder="587" value="587"
                class="w-full bg-gray-800 rounded-lg px-3 py-2 text-sm mono mt-1"/>
            </div>
            <div>
              <label class="text-xs text-gray-400">Usuario (tu email)</label>
              <input type="email" id="pe-user" placeholder="tu@gmail.com"
                class="w-full bg-gray-800 rounded-lg px-3 py-2 text-sm mt-1"/>
            </div>
            <div>
              <label class="text-xs text-gray-400">ContraseÃ±a / App Password</label>
              <input type="password" id="pe-pass" placeholder="App password..."
                class="w-full bg-gray-800 rounded-lg px-3 py-2 text-sm mt-1"/>
            </div>
            <div class="col-span-2">
              <label class="text-xs text-gray-400">Destinatario (email de alertas)</label>
              <input type="email" id="pe-to" placeholder="alertas@tudominio.com"
                class="w-full bg-gray-800 rounded-lg px-3 py-2 text-sm mt-1"/>
            </div>
          </div>
          <div class="flex gap-3">
            <button onclick="savePumpEmail()" class="bg-green-700 hover:bg-green-600 px-6 py-2 rounded-lg text-sm font-semibold">ğŸ’¾ Guardar email</button>
            <button onclick="testPumpEmail()" class="bg-yellow-700 hover:bg-yellow-600 px-6 py-2 rounded-lg text-sm font-semibold">ğŸ“¨ Enviar prueba</button>
          </div>
          <div id="pump-email-msg" class="text-sm mt-2"></div>
        </div>

        <!-- Info seÃ±ales -->
        <div class="bg-gray-900 border border-gray-800 rounded-xl p-5">
          <h3 class="font-semibold text-gray-400 mb-3">ğŸ“Š SeÃ±ales analizadas</h3>
          <div class="grid grid-cols-2 gap-2 text-sm">
            <div class="bg-gray-800 rounded-lg p-3">
              <p class="text-orange-400 font-semibold mb-1">ğŸ“± Spike Social (+2)</p>
              <p class="text-xs text-gray-400">Reddit multi-subreddit: posts hoy vs. media 7 dÃ­as. Umbral: Ã—5.</p>
            </div>
            <div class="bg-gray-800 rounded-lg p-3">
              <p class="text-orange-400 font-semibold mb-1">ğŸ—£ï¸ Mensajes Clonados (+2)</p>
              <p class="text-xs text-gray-400">Similitud Jaccard entre tÃ­tulos. Alerta si >40% son similares.</p>
            </div>
            <div class="bg-gray-800 rounded-lg p-3">
              <p class="text-orange-400 font-semibold mb-1">ğŸ“Š Volumen AnÃ³malo (+2)</p>
              <p class="text-xs text-gray-400">Historial 7 dÃ­as CoinGecko. Alerta si volumen Ã—4 sobre media.</p>
            </div>
            <div class="bg-gray-800 rounded-lg p-3">
              <p class="text-orange-400 font-semibold mb-1">ğŸ‹ Ballenas (+2)</p>
              <p class="text-xs text-gray-400">Glassnode: inflows a exchanges Ã—3. Requiere API key.</p>
            </div>
            <div class="bg-gray-800 rounded-lg p-3">
              <p class="text-orange-400 font-semibold mb-1">ğŸ“° Noticias VacÃ­as (+1)</p>
              <p class="text-xs text-gray-400">Keywords de pump en CryptoCompare/CoinDesk/CoinTelegraph.</p>
            </div>
            <div class="bg-gray-800 rounded-lg p-3">
              <p class="text-orange-400 font-semibold mb-1">ğŸŒ™ LunarCrush (+2)</p>
              <p class="text-xs text-gray-400">Galaxy Score >75, Alt Rank <15, Social Volume >10K. Requiere key.</p>
            </div>
            <div class="bg-gray-800 rounded-lg p-3">
              <p class="text-orange-400 font-semibold mb-1">â±ï¸ Timing Sincronizado (+1)</p>
              <p class="text-xs text-gray-400">â‰¥5 posts Reddit en ventana de 3h con spike simultÃ¡neo.</p>
            </div>
            <div class="bg-gray-800 rounded-lg p-3">
              <p class="text-gray-500 font-semibold mb-1">ğŸ”œ FUD Internacional</p>
              <p class="text-xs text-gray-500">PrÃ³ximamente â€” detecciÃ³n de FUD coordinado.</p>
            </div>
          </div>
        </div>

      </div>
    </div>

  </div><!-- /content-pump -->

</div><!-- /container -->

<script>
'use strict';
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ESTADO GLOBAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let cryptos = [], config = null, metadata = null;
let currentMode = 'normal';
let selectedDuration = 12 * 3600000;
let cycleTimers = {};
let currentApiKeyName = null;

const SIGNIFICANT_MS = 6 * 3600000;

// Info de APIs para la tarjeta de estado
const API_INFO = {
  coingecko:     { extract:'precio, market cap, ATH/ATL, volumen 24h, supply', indicators:'ATL Proximity, Leverage Ratio, Volume Surge, Rebound Recency', weight:'45% score cuantitativo' },
  alternative:   { extract:'Fear & Greed Index (0-100)', indicators:'Fear Overlap (resistencia)', weight:'10% score resistencia' },
  reddit:        { extract:'Posts 24h en CryptoCurrency, CryptoMarkets, CryptoMoonShots, SatoshiStreetBets + sub propio', indicators:'Social Momentum, Reddit Sentiment', weight:'20% score potencial social' },
  blockchain:    { extract:'Transacciones BTC on-chain 24h', indicators:'On-chain Activity proxy', weight:'Indicador auxiliar' },
  cryptocompare: { extract:'Noticias crypto recientes con cuerpo', indicators:'News Sentiment (mercado general)', weight:'15% score potencial' },
  newsapi:       { extract:'Noticias filtradas por sÃ­mbolo del activo', indicators:'Asset News Sentiment (mayor precisiÃ³n)', weight:'15% score potencial' },
  coindesk:      { extract:'RSS CoinDesk filtrado por activo', indicators:'Asset News Sentiment (fuente premium)', weight:'Fusionado en score de noticias' },
  cointelegraph: { extract:'RSS CoinTelegraph filtrado por activo', indicators:'Asset News Sentiment (fuente premium)', weight:'Fusionado en score de noticias' },
  lunarcrush:    { extract:'Social Score, Galaxy Score, Tweet Volume, Alt Rank', indicators:'Social Momentum enriquecido', weight:'Factor premium: refina score social' },
  santiment:     { extract:'Social Volume, Social Dominance, Dev Activity (GraphQL)', indicators:'Dev Activity, Social Dominance', weight:'Factor premium: enriquece potencial' },
  github:        { extract:'Rate limits y actividad de repos', indicators:'Developer Activity proxy', weight:'Factor auxiliar' },
  serpapi:       { extract:'Volumen bÃºsquedas Google Trends', indicators:'Search Trend Score (interÃ©s real)', weight:'Factor premium: sustituye proxy' },
  twitter:       { extract:'Tweets con menciones del activo', indicators:'Twitter Sentiment Score', weight:'Factor premium: 20% score social' },
  glassnode:     { extract:'Direcciones activas Ãºnicas', indicators:'Network Growth Score', weight:'Factor premium: enriquece resistencia' },
  cryptoquant:   { extract:'Flujo neto de exchanges', indicators:'Exchange Net Flow (presiÃ³n vendedora)', weight:'Factor premium: refinamiento resistencia' },
  whaleAlert:    { extract:'Movimientos >$1M de wallets', indicators:'Whale Activity Score', weight:'Factor premium: movimiento institucional' }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function init() {
  const [cfgRes, metaRes] = await Promise.allSettled([
    fetch('/api/config').then(r => r.json()),
    fetch('/api/config/metadata').then(r => r.json())
  ]);
  if (cfgRes.status === 'fulfilled'  && cfgRes.value.success)  { config = cfgRes.value.config; applyConfigToUI(); }
  if (metaRes.status === 'fulfilled' && metaRes.value.success) { metadata = metaRes.value.metadata; buildFactorSliders(); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setTab(tab) {
  document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
  document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('tab-active','text-white'));
  const tabEl = document.getElementById('content-' + tab);
  if (tabEl) tabEl.style.display = 'block';
  const btnEl = document.getElementById('tab-' + tab);
  if (btnEl) btnEl.classList.add('tab-active','text-white');
  if (tab === 'validation') loadValidation();
  if (tab === 'status')     loadAPIStatus();
  if (tab === 'analysis')   { 
    switchAnalysisMode(currentMode); 
    loadAnalysis(); 
  }
  if (tab === 'invest')     loadInvestData();
  if (tab === 'pump')       { loadPumpSettings(); loadPumpScan(); }
  if (tab === 'config')     switchConfigModel(configEditMode || 'normal');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODO ESPECULATIVO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setMode(mode) {
  const modeChanged = currentMode !== mode; // detectar cambio real de modo
  currentMode = mode;
  // Actualizar badge de anÃ¡lisis
  const ab = document.getElementById('analysis-mode-badge');
  if (ab) { ab.textContent = mode==='speculative' ? 'ğŸ¯ Modelo: Especulativo' : 'ğŸ“Š Modelo: Generalista';
    ab.className = 'pill text-sm ' + (mode==='speculative' ? 'bg-yellow-900 text-yellow-300' : 'bg-blue-900 text-blue-300'); }
  document.querySelectorAll('.mode-btn').forEach(b => {
    b.classList.remove('bg-blue-700','text-white');
    b.classList.add('text-gray-400');
  });
  const btn = document.getElementById('mode-' + mode);
  btn.classList.add('bg-blue-700','text-white');
  btn.classList.remove('text-gray-400');
  document.getElementById('mode-desc').classList.toggle('hidden', mode === 'normal');
  // FIX: auto-recargar activos si ya estaban cargados y el modo cambiÃ³
  // Evita que Normal muestre los small-caps del modo Especulativo anterior
  if (modeChanged && cryptos.length > 0) {
    loadCryptos();
  } else if (modeChanged && cryptos.length === 0) {
    // Informar al usuario que debe pulsar Cargar con el nuevo modo
    const list = document.getElementById('crypto-list');
    if (list) list.innerHTML = `<p class="text-blue-400 text-sm py-3">ğŸ”„ Modo cambiado a <b>${mode === 'speculative' ? 'Especulativo (small-caps)' : 'Normal (large-caps)'}</b> â€” pulsa <b>Cargar</b> para ver los activos de este modelo.</p>`;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MONITOR â€” carga de activos
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadCryptos() {
  document.getElementById('crypto-list').innerHTML = '<p class="text-gray-500 text-sm py-4">â³ Cargando datos de mercado...</p>';
  document.getElementById('stats').innerHTML = '';
  try {
    const r = await fetch(`/api/crypto?mode=${currentMode}`);
    const d = await r.json();
    if (!d.success) throw new Error(d.error);
    cryptos = d.data;
    document.getElementById('btn-cycle').disabled = false;

    // FGI
    if (d.marketContext?.fearGreed) {
      const fg = d.marketContext.fearGreed;
      const col = fg.value < 30 ? 'text-red-400' : fg.value < 50 ? 'text-orange-400' : fg.value < 70 ? 'text-yellow-400' : 'text-green-400';
      document.getElementById('fgi-badge').innerHTML = `<p class="text-xs text-gray-500">Fear & Greed</p><p class="text-xl font-bold ${col} mono">${fg.value}</p><p class="text-xs text-gray-400">${fg.classification}</p>`;
    }

    // Headlines
    if (d.marketContext?.topHeadlines?.length) {
      document.getElementById('market-context').classList.remove('hidden');
      document.getElementById('market-headlines').innerHTML = d.marketContext.topHeadlines.map(h =>
        `<a href="${h.url}" target="_blank" class="flex items-center gap-2 text-xs text-gray-400 hover:text-white">
          <span class="${h.sentiment?.score > 0.1 ? 'sentiment-pos' : h.sentiment?.score < -0.1 ? 'sentiment-neg' : 'sentiment-neu'}">â—</span>${h.title}</a>`
      ).join('');
    }

    // Stats
    const inv = cryptos.filter(c => c.classification === 'INVERTIBLE').length;
    const apl = cryptos.filter(c => c.classification === 'APALANCADO').length;
    const rui = cryptos.filter(c => c.classification === 'RUIDOSO').length;
    const modeBadge = currentMode === 'speculative'
      ? `<div class="col-span-4 mb-1"><span class="pill bg-yellow-900 text-yellow-300">ğŸ¯ Modo Especulativo Â· Small-Cap â‰¤$200M Â· Vol â‰¤$50M</span></div>` : '';
    document.getElementById('stats').innerHTML = modeBadge + `
      <div class="bg-green-950 border border-green-800 rounded-xl p-4 text-center"><div class="text-3xl font-bold text-green-400">${inv}</div><div class="text-xs text-green-600 mt-1 font-semibold">INVERTIBLES</div></div>
      <div class="bg-yellow-950 border border-yellow-800 rounded-xl p-4 text-center"><div class="text-3xl font-bold text-yellow-400">${apl}</div><div class="text-xs text-yellow-600 mt-1 font-semibold">APALANCADOS</div></div>
      <div class="bg-gray-900 border border-gray-700 rounded-xl p-4 text-center"><div class="text-3xl font-bold text-gray-400">${rui}</div><div class="text-xs text-gray-600 mt-1 font-semibold">RUIDOSOS</div></div>
      <div class="bg-blue-950 border border-blue-800 rounded-xl p-4 text-center"><div class="text-3xl font-bold text-blue-400">${cryptos.length}</div><div class="text-xs text-blue-600 mt-1 font-semibold">TOTAL</div></div>`;

    // Lista
    const list = document.getElementById('crypto-list');
    list.innerHTML = '';
    cryptos.forEach(c => {
      const border = c.color === 'green' ? 'border-green-700' : c.color === 'yellow' ? 'border-yellow-700' : 'border-gray-700';
      const badge  = c.color === 'green' ? 'bg-green-900 text-green-300' : c.color === 'yellow' ? 'bg-yellow-900 text-yellow-300' : 'bg-gray-800 text-gray-400';
      const chg = c.price_change_percentage_24h || 0;
      const card = document.createElement('div');
      card.className = `card-hover bg-gray-900 rounded-xl p-4 border border-gray-800 border-l-4 ${border}`;
      card.onclick = () => openDetail(c.id);
      card.innerHTML = `
        <div class="flex justify-between items-center">
          <div class="flex items-center gap-3 min-w-0">
            ${c.image ? `<img src="${c.image}" class="w-8 h-8 rounded-full flex-shrink-0" onerror="this.style.display='none'"/>` : ''}
            <div class="min-w-0">
              <div class="flex items-center gap-2 flex-wrap">
                <span class="font-bold">${c.name}</span>
                <span class="text-gray-500 mono text-xs">${c.symbol.toUpperCase()}</span>
                <span class="pill ${badge}">${c.classification}</span>
                ${currentMode==='speculative' ? '<span class="pill bg-yellow-950 text-yellow-600 text-xs">small-cap</span>' : ''}
              </div>
              <div class="flex items-center gap-3 mt-0.5">
                <span class="font-semibold mono text-sm">$${fmt(c.current_price)}</span>
                <span class="${chg>=0?'text-green-400':'text-red-400'} text-xs">${chg>=0?'â†‘':'â†“'}${Math.abs(chg).toFixed(2)}%</span>
                ${c.price_change_percentage_7d_in_currency!=null ? `<span class="text-gray-500 text-xs">7d: ${(c.price_change_percentage_7d_in_currency||0).toFixed(1)}%</span>` : ''}
              </div>
              ${c.classificationDetail?.reason ? `<p class="text-xs text-gray-500 mt-1 truncate">${c.classificationDetail.reason}</p>` : ''}
            </div>
          </div>
          <div class="text-right ml-4 flex-shrink-0">
            <div class="text-2xl font-bold mono">${c.boostPowerPercent}%</div>
            <div class="text-xs text-gray-500">BoostPower</div>
            ${c.predictedChange > 0 ? `<div class="text-xs text-green-400 mt-1">+${c.predictedChange}% previsto${c.calibrationApplied ? ' <span title="Calibrado con datos reales">ğŸ§ª</span>' : ''}</div>` : ''}
          </div>
        </div>`;
      list.appendChild(card);
    });
  } catch(e) {
    document.getElementById('crypto-list').innerHTML = `<p class="text-red-400 text-sm">âŒ ${e.message}</p>`;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DETALLE DE ACTIVO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function openDetail(id) {
  showModal('modal-detail');
  setDetailTab('overview');

  const base = cryptos.find(c => c.id === id);
  if (base) {
    document.getElementById('detail-name').textContent   = base.name;
    document.getElementById('detail-symbol').textContent = base.symbol.toUpperCase();
    document.getElementById('d-price').textContent       = '$' + fmt(base.current_price);
    document.getElementById('d-bp').textContent          = base.boostPowerPercent + '%';
    if (base.image) document.getElementById('detail-img').src = base.image;
    setBadge(base.classification, base.color);
    animateGauge(base.boostPower);
    document.getElementById('d-summary').textContent = base.summary || 'Cargando anÃ¡lisis completo...';
  }

  try {
    const r = await fetch(`/api/crypto/${id}/detail?mode=${currentMode}`);
    const d = await r.json();
    if (!d.success) throw new Error(d.error);
    renderDetail(d.asset);
  } catch(e) {
    document.getElementById('d-summary').textContent = 'âŒ ' + e.message;
  }
}

function renderDetail(a) {
  const clsObj = typeof a.classification === 'object' ? a.classification : { category: a.classification, color: a.color||'gray', confidence:'', reason:'' };
  document.getElementById('detail-name').textContent   = a.name;
  document.getElementById('detail-symbol').textContent = a.symbol.toUpperCase();
  if (a.image) document.getElementById('detail-img').src = a.image;
  setBadge(clsObj.category, clsObj.color);
  animateGauge(a.boostPower);

  // Precio
  document.getElementById('d-price').textContent  = '$' + fmt(a.current_price);
  document.getElementById('d-bp').textContent     = a.boostPowerPercent + '%';
  document.getElementById('d-chg24').innerHTML = `<span class="${(a.change24h||0)>=0?'text-green-400':'text-red-400'}">24h: ${(a.change24h||0)>=0?'+':''}${(a.change24h||0).toFixed(2)}%</span>`;
  document.getElementById('d-chg7').textContent  = a.change7d  != null ? `7d: ${(a.change7d||0).toFixed(1)}%`  : '';
  document.getElementById('d-chg30').textContent = a.change30d != null ? `30d: ${(a.change30d||0).toFixed(1)}%` : '';

  // ClasificaciÃ³n
  document.getElementById('d-classname').textContent  = clsObj.category;
  document.getElementById('d-classname').className    = `text-lg font-bold ${clsObj.color==='green'?'text-green-400':clsObj.color==='yellow'?'text-yellow-400':'text-gray-400'}`;
  document.getElementById('d-confidence').textContent = clsObj.confidence ? 'Confianza: '+clsObj.confidence : '';
  document.getElementById('d-target').textContent     = a.predictedChange > 0 ? `Objetivo: +${a.predictedChange}%` : 'Sin predicciÃ³n de subida';
  document.getElementById('d-reason').textContent     = clsObj.reason || 'â€”';
  document.getElementById('d-summary').textContent    = a.summary || 'â€”';

  // Fundamentales
  document.getElementById('d-mcap').textContent   = '$' + fmtLarge(a.market_cap);
  document.getElementById('d-vol').textContent    = '$' + fmtLarge(a.total_volume);
  document.getElementById('d-supply').textContent = fmtLarge(a.circulating_supply) + (a.max_supply ? ` / ${fmtLarge(a.max_supply)}` : '');
  document.getElementById('d-ath').textContent    = '$' + fmt(a.ath) + (a.ath_date ? ' (' + new Date(a.ath_date).getFullYear() + ')' : '');
  document.getElementById('d-atl').textContent    = '$' + fmt(a.atl);

  const ind = a.breakdown?.indicators;
  if (ind) {
    document.getElementById('d-atldays').textContent = ind.atlDaysAgo != null ? `hace ${ind.atlDaysAgo} dÃ­as` : 'â€”';
    const pct = ind.atlProximityPct ?? 50;
    document.getElementById('d-atlpct').textContent = pct.toFixed(0) + '% del rango';
    setTimeout(() => { document.getElementById('d-atlbar').style.width = pct + '%'; }, 100);
    renderDerivedIndicators(ind);
  }

  if (a.breakdown?.potential?.factors)  renderFactorBars('d-potential-factors',  a.breakdown.potential.factors,  'green');
  if (a.breakdown?.resistance?.factors) renderFactorBars('d-resistance-factors', a.breakdown.resistance.factors, 'red');

  // FGI
  if (a.fearGreed) {
    document.getElementById('d-fgi-val').textContent   = a.fearGreed.value;
    document.getElementById('d-fgi-label').textContent = a.fearGreed.classification;
    const fg = a.fearGreed.value;
    document.getElementById('d-fgi-val').className = `text-3xl font-bold mono ${fg<30?'text-red-400':fg<50?'text-orange-400':fg<70?'text-yellow-400':'text-green-400'}`;
  }

  // LunarCrush + Santiment
  const socialExtra = document.getElementById('d-social-extra');
  const hasSocial = a.lunarCrush || a.santiment;
  socialExtra.classList.toggle('hidden', !hasSocial);
  if (hasSocial) {
    socialExtra.innerHTML = '';
    if (a.lunarCrush) {
      socialExtra.innerHTML += `
        <div class="bg-gray-800 rounded-xl p-3">
          <p class="text-xs text-gray-500 mb-2">ğŸŒ™ LunarCrush</p>
          ${a.lunarCrush.galaxyScore   != null ? `<div class="text-sm"><span class="text-gray-400">Galaxy Score:</span> <span class="font-bold">${a.lunarCrush.galaxyScore}</span></div>` : ''}
          ${a.lunarCrush.altRank       != null ? `<div class="text-sm"><span class="text-gray-400">Alt Rank:</span> <span class="font-bold">#${a.lunarCrush.altRank}</span></div>` : ''}
          ${a.lunarCrush.socialScore   != null ? `<div class="text-sm"><span class="text-gray-400">Social Score:</span> <span class="font-bold">${a.lunarCrush.socialScore}</span></div>` : ''}
          ${a.lunarCrush.tweetVolume   != null ? `<div class="text-sm"><span class="text-gray-400">Tweets 24h:</span> <span class="font-bold">${fmtLarge(a.lunarCrush.tweetVolume)}</span></div>` : ''}
        </div>`;
    }
    if (a.santiment) {
      socialExtra.innerHTML += `
        <div class="bg-gray-800 rounded-xl p-3">
          <p class="text-xs text-gray-500 mb-2">ğŸ“ˆ Santiment</p>
          ${a.santiment.socialVolume    != null ? `<div class="text-sm"><span class="text-gray-400">Social Volume:</span> <span class="font-bold">${a.santiment.socialVolume}</span></div>` : ''}
          ${a.santiment.socialDominance != null ? `<div class="text-sm"><span class="text-gray-400">Dominancia Social:</span> <span class="font-bold">${(a.santiment.socialDominance*100).toFixed(1)}%</span></div>` : ''}
          ${a.santiment.devActivity     != null ? `<div class="text-sm"><span class="text-gray-400">Dev Activity 7d:</span> <span class="font-bold">${a.santiment.devActivity}</span></div>` : ''}
        </div>`;
    }
  }

  // Noticias
  const newsDiv = document.getElementById('d-news');
  if (a.news?.articles?.length > 0) {
    document.getElementById('d-news-sources').textContent = a.news.sources ? 'Fuentes: ' + a.news.sources.join(', ') : '';
    newsDiv.innerHTML = a.news.articles.slice(0, 8).map(n => `
      <a href="${n.url}" target="_blank" class="block bg-gray-800 rounded-lg p-3 hover:bg-gray-700">
        <div class="flex items-start gap-2">
          <span class="${n.sentiment?.score>0.1?'sentiment-pos':n.sentiment?.score<-0.1?'sentiment-neg':'sentiment-neu'} mt-0.5 flex-shrink-0">â—</span>
          <div>
            <p class="text-sm text-gray-200 leading-snug">${n.title}</p>
            <p class="text-xs text-gray-500 mt-1">${n.source||'â€”'} Â· ${timeAgo(n.publishedAt)} Â· <span class="${n.sentiment?.score>0.1?'sentiment-pos':n.sentiment?.score<-0.1?'sentiment-neg':'sentiment-neu'}">${n.sentiment?.label||'neutral'}</span></p>
          </div>
        </div>
      </a>`).join('');
  } else {
    document.getElementById('d-news-sources').textContent = '';
    newsDiv.innerHTML = '<p class="text-gray-500 text-sm">Sin noticias especÃ­ficas encontradas.</p>';
  }

  // Reddit
  const redditDiv = document.getElementById('d-reddit');
  if (a.reddit?.posts?.length > 0) {
    const sub = a.reddit.subredditsSearched?.join(', ') || 'CryptoCurrency';
    document.getElementById('d-reddit-meta').textContent = `${a.reddit.postCount} posts Â· ${sub}`;
    redditDiv.innerHTML = a.reddit.posts.slice(0, 6).map(p => `
      <a href="${p.url}" target="_blank" class="block bg-gray-800 rounded-lg p-3 hover:bg-gray-700">
        <div class="flex items-start gap-2">
          <span class="${p.sentiment?.score>0.1?'sentiment-pos':p.sentiment?.score<-0.1?'sentiment-neg':'sentiment-neu'} mt-0.5 flex-shrink-0">â—</span>
          <div class="flex-1">
            <p class="text-sm text-gray-200 leading-snug">${p.title}</p>
            <p class="text-xs text-gray-500 mt-1">r/${p.subreddit} Â· â¬†ï¸${p.score} Â· ğŸ’¬${p.comments} Â· ${timeAgo(p.created)}</p>
          </div>
        </div>
      </a>`).join('');
  } else {
    document.getElementById('d-reddit-meta').textContent = '';
    redditDiv.innerHTML = '<p class="text-gray-500 text-sm">Sin posts recientes encontrados.</p>';
  }
}

function renderFactorBars(containerId, factors, color) {
  const names = { atlProximity:'Proximidad ATL', volumeSurge:'Surge Volumen', socialMomentum:'Momentum Social', newsSentiment:'Sentimiento Noticias', reboundRecency:'Recencia ATL',
    leverageRatio:'Ratio Apalancamiento', marketCapSize:'TamaÃ±o Cap', volatilityNoise:'Ruido Volatilidad', fearOverlap:'Solapamiento FGI' };
  document.getElementById(containerId).innerHTML = Object.entries(factors).map(([k,v]) => {
    const pct = Math.round(v*100);
    return `<div>
      <div class="flex justify-between text-xs mb-0.5"><span class="text-gray-400">${names[k]||k}</span><span class="mono font-medium">${pct}%</span></div>
      <div class="w-full bg-gray-800 rounded-full h-1.5"><div class="bar bg-${color}-600 h-1.5 rounded-full" style="width:${pct}%"></div></div>
    </div>`;
  }).join('');
}

function renderDerivedIndicators(ind) {
  const rows = [
    ['PosiciÃ³n ATL-ATH', ind.atlProximityPct != null ? ind.atlProximityPct.toFixed(0)+'%' : 'â€”', '0%=ATL, 100%=ATH'],
    ['Precio vs ATH',    ind.priceVsAth      != null ? ind.priceVsAth.toFixed(0)+'%'      : 'â€”', 'del mÃ¡ximo histÃ³rico'],
    ['Vol/Cap ratio',    ind.capEfficiency   != null ? ind.capEfficiency.toFixed(1)+'%'    : 'â€”', '>10% = muy activo'],
    ['Market Cap',       ind.marketCapM      != null ? '$'+fmtLarge(ind.marketCapM*1e6)   : 'â€”', ''],
    ['Noticias',         ind.newsCount       != null ? ind.newsCount                       : 'â€”', 'recientes'],
    ['Sentimiento news', ind.newsSentimentLabel || 'â€”', ''],
    ['FGI',              ind.fearGreedIndex  != null ? ind.fearGreedIndex+' Â· '+(ind.fearGreedLabel||'') : 'â€”', ''],
    ['Reddit posts',     ind.redditPosts     != null ? ind.redditPosts                     : 'â€”', '24h'],
    ['ATL hace',         ind.atlDaysAgo      != null ? ind.atlDaysAgo+' dÃ­as'             : 'â€”', ''],
    ['Cambio 24h',       ind.change24h       != null ? (ind.change24h>=0?'+':'')+ind.change24h.toFixed(2)+'%' : 'â€”', '']
  ];
  document.getElementById('d-derived-indicators').innerHTML = rows.map(([l,v,h]) => `
    <div class="bg-gray-800 rounded-lg p-2">
      <p class="text-xs text-gray-500">${l}</p>
      <p class="font-semibold mono text-sm">${v}</p>
      ${h ? `<p class="text-xs text-gray-600">${h}</p>` : ''}
    </div>`).join('');
}

function setBadge(cat, color) {
  const b = document.getElementById('detail-badge');
  b.textContent = cat;
  b.className = 'pill ' + (color==='green'?'bg-green-900 text-green-300':color==='yellow'?'bg-yellow-900 text-yellow-300':'bg-gray-800 text-gray-400');
}

function animateGauge(bp) {
  const g = document.getElementById('d-gauge');
  if (!g) return;
  g.style.strokeDashoffset = 251 - (bp * 251);
  g.style.stroke = bp > 0.65 ? '#22c55e' : bp > 0.40 ? '#eab308' : '#6b7280';
}

function setDetailTab(tab) {
  document.querySelectorAll('.detail-tab').forEach(el => el.classList.add('hidden'));
  document.querySelectorAll('.dtab').forEach(el => el.classList.remove('bg-gray-800','text-white'));
  document.getElementById('dcontent-'+tab).classList.remove('hidden');
  document.getElementById('dtab-'+tab).classList.add('bg-gray-800','text-white');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function applyConfigToUI() {
  if (!config || !config.potentialWeights) return;
  const cl = config.classification || {}, pr = config.prediction || {}, mw = config.metaWeights || {};
  setSlider('c-inv-min',    Math.round((cl.invertibleMinBoost    ?? 0.65)*100), 'c-inv-min-v',    '%');
  setSlider('c-apl-min',    Math.round((cl.apalancadoMinBoost    ?? 0.40)*100), 'c-apl-min-v',    '%');
  setSlider('c-mcap',       Math.round((cl.invertibleMaxMarketCap?? 500e6)/1e6),'c-mcap-v',       '', '$', 'M');
  setSlider('c-target',     pr.invertibleTarget   ?? 30,  'c-target-v',     '%');
  setSlider('c-apl-target', pr.apalancadoTarget   ?? 10,  'c-apl-target-v', '%');
  setSlider('c-tol',        pr.magnitudeTolerance ?? 5,   'c-tol-v',        '%', 'Â±');
  setSlider('c-pot',        Math.round((mw.potential ?? 0.6)*100), 'c-pot-v', '%');
  document.getElementById('c-res-v').textContent = (100-Math.round((mw.potential??0.6)*100))+'%';
}
function setSlider(id, val, lbId, unit='', prefix='', suffix='') {
  const el = document.getElementById(id), lb = document.getElementById(lbId);
  if (el) el.value = val;
  if (lb) lb.textContent = prefix + val + unit + suffix;
}
function cfgUpdate(sid, lid, unit='', prefix='') {
  document.getElementById(lid).textContent = prefix + document.getElementById(sid).value + unit;
}
function cfgUpdateMcap() { document.getElementById('c-mcap-v').textContent = '$' + document.getElementById('c-mcap').value + 'M'; }
function updateMetaWeights() {
  const v = parseInt(document.getElementById('c-pot').value);
  document.getElementById('c-pot-v').textContent = v + '%';
  document.getElementById('c-res-v').textContent = (100-v) + '%';
}
function buildFactorSliders() {
  if (!metadata || !config?.potentialWeights) return;
  const build = (factors, weightObj, cid, color) => {
    const div = document.getElementById(cid);
    if (!div || !weightObj) return;
    div.innerHTML = '';
    factors.forEach(f => {
      const w = Math.round((weightObj[f.id]??0)*100);
      div.innerHTML += `<div class="mb-1">
        <div class="flex justify-between text-xs mb-0.5"><span class="text-gray-300">${f.name}</span><span id="fw-${f.id}" class="${color} mono">${w}%</span></div>
        <input type="range" id="fslider-${f.id}" min="0" max="50" step="5" value="${w}" oninput="document.getElementById('fw-${f.id}').textContent=this.value+'%'" class="w-full h-1 accent-blue-500"/>
        <p class="text-gray-600 text-xs">${f.description}</p></div>`;
    });
  };
  build(metadata.potential,  config.potentialWeights,  'potential-sliders',  'text-green-400');
  build(metadata.resistance, config.resistanceWeights, 'resistance-sliders', 'text-red-400');
}
function buildConfigFromUI() {
  const pot = parseInt(document.getElementById('c-pot').value)/100;
  const pw={}, rw={};
  metadata?.potential?.forEach(f  => { pw[f.id] = parseInt(document.getElementById('fslider-'+f.id)?.value||0)/100; });
  metadata?.resistance?.forEach(f => { rw[f.id] = parseInt(document.getElementById('fslider-'+f.id)?.value||0)/100; });
  return { ...config, metaWeights:{potential:pot,resistance:1-pot}, potentialWeights:pw, resistanceWeights:rw,
    classification:{ invertibleMinBoost:parseInt(document.getElementById('c-inv-min').value)/100, apalancadoMinBoost:parseInt(document.getElementById('c-apl-min').value)/100,
      invertibleMaxMarketCap:parseInt(document.getElementById('c-mcap').value)*1e6, invertibleMinAtlProx:0.60, invertibleMinVolSurge:1.20, invertibleMinSocial:0.50 },
    prediction:{ invertibleTarget:parseInt(document.getElementById('c-target').value), apalancadoTarget:parseInt(document.getElementById('c-apl-target').value),
      magnitudeTolerance:parseInt(document.getElementById('c-tol').value), directionOnly:false }};
}
// Modelo que se estÃ¡ editando en la pestaÃ±a config (puede ser distinto al modo de anÃ¡lisis)
let configEditMode = 'normal';

function switchConfigModel(mode) {
  configEditMode = mode;
  // Actualizar botones
  ['normal','speculative'].forEach(m => {
    const btn = document.getElementById('cfgbtn-' + m);
    if (!btn) return;
    const active = m === mode;
    btn.className = 'cfg-model-btn px-3 py-1.5 rounded-lg text-sm font-semibold ' +
      (active ? (m==='normal' ? 'bg-blue-700 text-white' : 'bg-yellow-700 text-white') : 'bg-gray-700 text-gray-300');
  });
  // Actualizar banner
  const banner = document.getElementById('config-model-banner');
  const desc   = document.getElementById('config-model-desc');
  if (banner) banner.className = 'border rounded-xl p-3 mb-4 ' + (mode==='speculative' ? 'bg-yellow-950 border-yellow-800' : 'bg-blue-950 border-blue-800');
  if (desc)   desc.className   = 'text-sm font-semibold ' + (mode==='speculative' ? 'text-yellow-300' : 'text-blue-300');
  if (desc)   desc.textContent = mode==='speculative'
    ? 'ğŸ¯ Modelo Especulativo â€” micro/small-caps con alto potencial y alta volatilidad'
    : 'ğŸ“Š Modelo Generalista â€” activos de alta capitalizaciÃ³n y liquidez';
  // Cargar config del modelo seleccionado
  loadConfigForModel(mode);
}

async function loadConfigForModel(mode) {
  try {
    const r = await fetch(`/api/config?mode=${mode}`);
    const d = await r.json();
    if (d.success) { config = d.config; applyConfigToUI(); buildFactorSliders(); }
  } catch(e) { console.error('loadConfigForModel:', e); }
}

async function saveConfig() {
  const msg = document.getElementById('config-msg');
  msg.innerHTML = '<span class="text-gray-400">Guardando...</span>';
  try {
    const builtCfg = { ...buildConfigFromUI(), modelType: configEditMode };
    const r = await fetch(`/api/config?mode=${configEditMode}`, {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ config: builtCfg })
    });
    const d = await r.json();
    if (d.success) {
      config = d.config;
      msg.innerHTML = `<span class="text-green-400">âœ… Modelo '${configEditMode}' guardado</span>`;
    } else {
      msg.innerHTML = `<span class="text-red-400">âŒ ${(d.errors||[d.error]).join(', ')}</span>`;
    }
    setTimeout(()=>{ if(msg) msg.innerHTML=''; }, 3000);
  } catch(e) { msg.innerHTML=`<span class="text-red-400">âŒ ${e.message}</span>`; }
}

async function resetConfig() {
  if (!confirm(`Â¿Resetear el modelo '${configEditMode}' a sus valores por defecto?`)) return;
  try {
    const r = await fetch(`/api/config/reset?mode=${configEditMode}`, { method: 'POST' });
    const d = await r.json();
    if (d.success) { config=d.config; applyConfigToUI(); buildFactorSliders();
      document.getElementById('config-msg').innerHTML = `<span class="text-yellow-400">ğŸ”„ Modelo '${configEditMode}' reseteado</span>`;
      setTimeout(()=>{ document.getElementById('config-msg').innerHTML=''; }, 3000);
    }
  } catch(e) { console.error('resetConfig:', e); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CICLOS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openCycleModal() {
  document.getElementById('dur-assets').textContent  = Math.min(cryptos.length,20);
  document.getElementById('modal-mode-label').textContent = currentMode==='speculative'?'ğŸ¯ Especulativo':'ğŸ“Š Normal';
  updateDurBadge(selectedDuration);
  showModal('modal-cycle');
}
function setDur(ms) {
  selectedDuration = ms;
  document.querySelectorAll('.dur-btn').forEach(b => b.classList.replace('bg-blue-700','bg-gray-700'));
  event.currentTarget.classList.replace('bg-gray-700','bg-blue-700');
  document.getElementById('dur-custom').value = '';
  document.getElementById('dur-label').textContent = fmtDur(ms);
  updateDurBadge(ms);
}
function setDurMin(v) {
  const min = parseInt(v); if(isNaN(min)||min<1) return;
  selectedDuration = min*60000;
  document.getElementById('dur-label').textContent = fmtDur(selectedDuration);
  updateDurBadge(selectedDuration);
}
function updateDurBadge(ms) {
  const sig = ms >= SIGNIFICANT_MS;
  const b = document.getElementById('dur-sig-badge');
  b.textContent = sig ? 'â­â­ Significativo' : 'âš—ï¸ Testing';
  b.className = 'ml-3 pill ' + (sig ? 'bg-green-900 text-green-300' : 'bg-gray-800 text-gray-400');
  document.getElementById('modal-sig-note').textContent = sig
    ? 'âœ“ Este ciclo calibrarÃ¡ el algoritmo al completarse.'
    : 'âš ï¸ Ciclo <6h â€” solo valida tendencia, no calibra pesos.';
}
async function confirmCycle() {
  closeModal('modal-cycle');
  setTab('validation');
  document.getElementById('active-cycles').innerHTML = '<p class="text-blue-400 text-sm">â³ Iniciando ciclo...</p>';
  try {
    if (!cryptos || cryptos.length === 0) {
      document.getElementById('active-cycles').innerHTML = '<p class="text-red-400 text-sm">âŒ Carga activos en el Monitor antes de iniciar un ciclo</p>';
      return;
    }
    const snapshot = cryptos.slice(0, 20);
    const r = await fetch('/api/cycles/start', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ snapshot, durationMs: selectedDuration, mode: currentMode })
    });
    const d = await r.json();
    if (!d.success) {
      document.getElementById('active-cycles').innerHTML = `<p class="text-red-400 text-sm">âŒ ${d.error}</p>`;
      return;
    }
    await loadValidation();

    // Auto-ejecutar mÃ³dulo de inversiÃ³n si estÃ¡ configurado y el ciclo es â‰¥12h
    if (investConfig?.mode && (selectedDuration >= 12 * 3600000)) {
      try {
        const cycId = d.cycle?.id;
        if (cycId) {
          await fetch('/api/invest/execute', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ snapshot, cycleId: cycId })
          });
        }
      } catch(_) {}
    }
  } catch(e) {
    document.getElementById('active-cycles').innerHTML = `<p class="text-red-400 text-sm">âŒ ${e.message}</p>`;
  }
}

async function loadValidation() {
  await Promise.all([loadActiveCycles(), loadCompletedCycles(), loadGlobalStats()]);
}

async function loadActiveCycles() {
  const div = document.getElementById('active-cycles');
  try {
    const r = await fetch('/api/cycles/active'); const d=await r.json();
    if(!d.success||d.cycles.length===0){div.innerHTML='<p class="text-gray-500 text-sm">Sin ciclos activos</p>';return;}
    div.innerHTML='';
    d.cycles.forEach(c => {
      const el = document.createElement('div');
      el.id = 'acard-'+c.id;
      el.className = 'bg-gray-900 rounded-xl border border-gray-800 p-4 mb-2';
      div.appendChild(el);
      renderActiveCycleCard(c);
      if(cycleTimers[c.id]) clearInterval(cycleTimers[c.id]);
      cycleTimers[c.id] = setInterval(()=>tickCycle(c),1000);
    });
  } catch(e){ div.innerHTML=`<p class="text-red-400 text-sm">Error: ${e.message}</p>`; }
}

function renderActiveCycleCard(c) {
  const card = document.getElementById('acard-'+c.id); if(!card) return;
  const now=Date.now(), total=c.durationMs||(c.endTime-c.startTime);
  const remaining=Math.max(0,c.endTime-now), pct=Math.min(100,Math.round((now-c.startTime)/total*100));
  const ready=remaining===0, sig=total>=SIGNIFICANT_MS;

  // â”€â”€ Badges de info del ciclo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const isSpec = c.mode === 'speculative';
  const modeBadge = isSpec
    ? '<span class="pill bg-orange-900 text-orange-300">ğŸ¯ Especulativo</span>'
    : '<span class="pill bg-blue-900 text-blue-300">ğŸ“Š Generalista</span>';
  const scaleBadge = c.predictionScaleFactor
    ? `<span class="text-xs text-gray-400">Escala: <span class="text-white mono">Ã—${parseFloat(c.predictionScaleFactor).toFixed(2)}</span></span>`
    : '';
  const startedAt = c.startTime
    ? `<span class="text-xs text-gray-500">Iniciado: ${new Date(c.startTime).toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'})}</span>`
    : '';

  // â”€â”€ Vista de activos del ciclo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const assets = c.snapshot || [];
  const CAT_COLORS = { INVERTIBLE:'text-green-400', APALANCADO:'text-yellow-400', RUIDOSO:'text-red-400' };
  const assetsRows = assets.map(a => {
    const cat = (typeof a.classification === 'object' ? (a.classification?.category || 'RUIDOSO') : (a.classification || 'RUIDOSO')).toUpperCase();
    const catColor = CAT_COLORS[cat] || 'text-gray-400';
    const bp = a.boostPowerPercent ?? Math.round((a.boostPower||0)*100);
    const pred = typeof a.predictedChange === 'number'
      ? `<span class="${a.predictedChange>=0?'text-green-400':'text-red-400'}">${a.predictedChange>=0?'+':''}${a.predictedChange.toFixed(1)}%</span>`
      : '<span class="text-gray-500">â€”</span>';
    const manual = a.manuallyAdded ? '<span class="pill bg-purple-900 text-purple-300 ml-1">PUMP</span>' : '';
    return `
      <div class="flex items-center justify-between py-1.5 border-b border-gray-800 last:border-0 text-xs">
        <div class="flex items-center gap-2 min-w-0">
          <span class="font-bold text-white mono w-16 shrink-0">${(a.symbol||'').toUpperCase()}</span>
          <span class="${catColor} shrink-0">${cat}</span>
          ${manual}
        </div>
        <div class="flex items-center gap-3 shrink-0 ml-2">
          <span class="text-gray-400">BP: <span class="text-white font-semibold">${bp}%</span></span>
          <span class="text-gray-400">Pred: ${pred}</span>
          <span class="text-gray-500 mono">$${(a.current_price||0)<0.01?(a.current_price||0).toFixed(6):(a.current_price||0).toFixed(2)}</span>
        </div>
      </div>`;
  }).join('');

  card.innerHTML = `
    <div class="flex justify-between items-center mb-3">
      <div>
        <p class="font-semibold text-sm">${ready?'âœ… Listo para validar':'ğŸ”„ Ciclo activo'} Â· ${assets.length} activos Â· ${fmtDur(total)}</p>
        <div class="flex items-center gap-2 mt-0.5 flex-wrap">
          ${modeBadge}
          <span class="pill ${sig?'bg-green-900 text-green-300':'bg-gray-800 text-gray-400'}">${sig?'â­â­ Significativo':'âš—ï¸ Testing'}</span>
          ${scaleBadge}
          ${startedAt}
          <span class="text-xs text-gray-700 mono">${c.id}</span>
        </div>
      </div>
      <div class="text-right flex flex-col items-end gap-1">
        ${ready
          ? `<button onclick="completeCycle('${c.id}')" class="bg-green-700 hover:bg-green-600 px-4 py-2 rounded-lg text-sm font-bold">Validar</button>`
          : `<div class="text-xl font-bold text-blue-400 mono" id="cd-${c.id}">${fmtCountdown(remaining)}</div><div class="text-xs text-gray-500">restante</div>`
        }
      </div>
    </div>
    <div class="w-full bg-gray-800 rounded-full h-1.5 mb-2"><div class="bar bg-blue-600 h-1.5 rounded-full" style="width:${pct}%"></div></div>
    ${!ready?`<div class="text-right mb-2"><button onclick="completeCycle('${c.id}')" class="text-xs text-gray-600 hover:text-yellow-400">Completar manualmente</button></div>`:''}

    <!-- Activos expandibles -->
    <div>
      <button onclick="toggleCycleAssets('${c.id}')" class="flex items-center gap-1 text-xs text-gray-400 hover:text-white transition-colors w-full text-left py-1">
        <span id="cycle-assets-arrow-${c.id}" class="mono">â–¶</span>
        <span>Ver activos del ciclo (${assets.length})</span>
      </button>
      <div id="cycle-assets-${c.id}" class="hidden mt-2 bg-gray-950 rounded-lg px-3 py-1 max-h-64 overflow-y-auto">
        ${assetsRows || '<p class="text-gray-600 text-xs py-2">Sin activos en el snapshot</p>'}
      </div>
    </div>`;
}

function toggleCycleAssets(cycleId) {
  const panel = document.getElementById('cycle-assets-'+cycleId);
  const arrow = document.getElementById('cycle-assets-arrow-'+cycleId);
  if (!panel) return;
  const open = panel.classList.toggle('hidden');
  arrow.textContent = open ? 'â–¶' : 'â–¼';
}

function tickCycle(c) {
  const rem=Math.max(0,c.endTime-Date.now());
  const el=document.getElementById('cd-'+c.id); if(el) el.textContent=fmtCountdown(rem);
  if(rem===0){clearInterval(cycleTimers[c.id]);renderActiveCycleCard(c);}
}
async function completeCycle(cycleId) {
  try {
    const r=await fetch(`/api/cycles/${cycleId}/complete`,{method:'POST'}); const d=await r.json();
    if(d.success){clearInterval(cycleTimers[cycleId]);await loadValidation();}
    else alert('âŒ '+d.error);
  } catch(e){alert('âŒ '+e.message);}
}

async function loadCompletedCycles() {
  const div = document.getElementById('completed-cycles');
  try {
    const r=await fetch(`/api/cycles/history?mode=${currentMode}`); const d=await r.json();
    if(!d.success||d.cycles.length===0){div.innerHTML='<p class="text-gray-500 text-sm">Sin ciclos completados.</p>';return;}
    div.innerHTML='';
    d.cycles.slice(0,10).forEach(c => {
      const excl=(c.excludedResults||[]).length, sig=(c.durationMs||0)>=SIGNIFICANT_MS;
      const card=document.createElement('div');
      card.className='bg-gray-900 rounded-xl border border-gray-800 p-4 mb-2';
      card.innerHTML=`
        <div class="flex justify-between items-center">
          <div>
            <p class="font-semibold text-sm">${new Date(c.completedAt).toLocaleString()}</p>
            <div class="flex items-center gap-2 mt-0.5">
              <span class="pill ${sig?'bg-green-900 text-green-300':'bg-gray-800 text-gray-400'}">${sig?'â­â­ Significativo':'âš—ï¸ Testing'}</span>
              <span class="text-xs text-gray-500">${c.snapshot?.length||0} activos Â· ${fmtDur(c.durationMs||0)} ${excl?`Â· <span class="text-yellow-400">${excl} excl.</span>`:''}</span>
            </div>
          </div>
          <div class="flex items-center gap-3">
            <div class="text-right">
              <div class="text-2xl font-bold ${parseFloat(c.metrics?.successRate||0)>60?'text-green-400':parseFloat(c.metrics?.successRate||0)>40?'text-yellow-400':'text-red-400'}">${c.metrics?.successRate??'?'}%</div>
              <div class="text-xs text-gray-500">${c.metrics?.correct??'?'}/${c.metrics?.total??'?'}</div>
            </div>
            <button onclick="toggleDetail('${c.id}')" class="bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded text-xs">ğŸ“‹ Ver</button>
            <button onclick="downloadReport('${c.id}')" class="bg-blue-900 hover:bg-blue-800 px-3 py-1 rounded text-xs">ğŸ“„ Word</button>
            ${sig ? `<button onclick="downloadEnhancedReport('${c.id}')" class="bg-green-900 hover:bg-green-800 px-3 py-1 rounded text-xs" title="Informe con anÃ¡lisis de oportunidades perdidas">ğŸ“Š Mejorado</button>` : ''}
          </div>
        </div>
        <div id="cdetail-${c.id}" class="hidden mt-3 border-t border-gray-800 pt-3">
          <p class="text-xs text-gray-500 mb-2">Click para excluir/incluir de las estadÃ­sticas</p>
          <div class="space-y-1.5">${(c.results||[]).map(r=>renderResultCard(r,c)).join('')}</div>
        </div>`;
      div.appendChild(card);
    });
  } catch(e){div.innerHTML=`<p class="text-red-400 text-sm">Error: ${e.message}</p>`;}
}

function renderResultCard(result, cycle) {
  const excl=(cycle.excludedResults||[]).includes(result.id);
  const ok=result.correct;
  const border=excl?'border-gray-700':ok?'border-green-700':'border-red-700';
  const op=excl?'opacity-40':'';
  return `<div class="result-card ${op} bg-gray-800 rounded-lg p-2.5 border-l-4 ${border} flex justify-between items-center text-sm"
    onclick="toggleExclude('${cycle.id}','${result.id}',this)" title="${excl?'Click para incluir':'Click para excluir'}">
    <div class="flex items-center gap-2">
      <span class="font-semibold">${result.name}</span>
      <span class="text-gray-500 mono text-xs">${result.classification}</span>
    </div>
    <div class="flex items-center gap-3 text-xs mono">
      <span class="text-gray-400">Pred: <span class="text-white">${result.predictedChange}%</span></span>
      <span class="text-gray-400">Real: <span class="${parseFloat(result.actualChange)>=0?'text-green-400':'text-red-400'}">${parseFloat(result.actualChange)>0?'+':''}${result.actualChange}%</span></span>
      <span class="text-gray-500">Î”${result.error}%</span>
      <span class="${excl?'text-gray-500':ok?'text-green-400':'text-red-400'} font-bold text-base">${excl?'âŠ˜':ok?'âœ“':'âœ—'}</span>
    </div>
  </div>`;
}
function toggleDetail(id) { document.getElementById('cdetail-'+id)?.classList.toggle('hidden'); }
async function toggleExclude(cycleId, assetId) {
  try {
    const r=await fetch(`/api/cycles/${cycleId}/results/${assetId}/toggle-exclude`,{method:'POST'}); const d=await r.json();
    if(d.success) {
      await loadCompletedCycles();
      await loadGlobalStats();
      // Si la pestaÃ±a anÃ¡lisis estÃ¡ abierta, recargarla tambiÃ©n
      if (document.getElementById('content-analysis')?.style.display !== 'none') {
        await loadAnalysis();
      }
    }
  } catch(e){}
}
async function loadGlobalStats() {
  const div=document.getElementById('global-stats');
  try {
    const r=await fetch(`/api/cycles/stats/global?mode=${currentMode}`); const d=await r.json();
    if(!d.success) return;
    const s=d.stats;
    div.innerHTML=`<div class="grid grid-cols-3 gap-3">
      <div class="bg-gray-900 border border-gray-800 rounded-xl p-4 text-center"><div class="text-2xl font-bold text-blue-400">${s.totalCycles}</div><div class="text-xs text-gray-500 mt-1">Ciclos</div></div>
      <div class="bg-gray-900 border border-gray-800 rounded-xl p-4 text-center"><div class="text-2xl font-bold text-green-400">${s.avgSuccessRate}%</div><div class="text-xs text-gray-500 mt-1">Accuracy Promedio</div></div>
      <div class="bg-gray-900 border border-gray-800 rounded-xl p-4 text-center"><div class="text-2xl font-bold text-purple-400">${s.totalPredictions}</div><div class="text-xs text-gray-500 mt-1">Predicciones</div></div>
    </div>`;
  } catch(e){}
}
function downloadReport(id) { window.location.href='/api/cycles/'+id+'/report'; }
function downloadEnhancedReport(id) { window.location.href='/api/cycles/'+id+'/enhanced-report'; }

// Auto-completar ciclos pendientes
setInterval(async ()=>{
  try {
    const r=await fetch('/api/cycles/pending'); const d=await r.json();
    if(d.success&&d.cycles.length>0){
      for(const c of d.cycles){await fetch(`/api/cycles/${c.id}/complete`,{method:'POST'});clearInterval(cycleTimers[c.id]);}
      if(document.getElementById('content-validation').style.display!=='none') await loadValidation();
    }
  } catch(_){}
}, 30000);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ANÃLISIS DE SIMULACIONES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function switchAnalysisMode(mode) {
  currentMode = mode;
  const label = document.getElementById('analysis-mode-label');
  const info  = document.getElementById('analysis-mode-info');
  if (mode === 'speculative') {
    label.textContent = 'Especulativo';
    info.className = 'bg-yellow-950 border border-yellow-800 rounded-lg p-3 mb-4';
    info.querySelector('p').className = 'text-sm text-yellow-300';
  } else {
    label.textContent = 'Generalista';
    info.className = 'bg-blue-950 border border-blue-800 rounded-lg p-3 mb-4';
    info.querySelector('p').className = 'text-sm text-blue-300';
  }
  document.getElementById('analysis-mode-select').value = mode;
}

async function loadAnalysis() {
  const div = document.getElementById('analysis-content');
  div.innerHTML = '<p class="text-gray-400 text-sm">â³ Analizando simulaciones...</p>';
  try {
    const r = await fetch(`/api/simulations/analysis?mode=${currentMode}`); const d = await r.json();
    if (!d.success) throw new Error(d.error);
    renderAnalysis(d);
  } catch(e) { div.innerHTML = `<p class="text-red-400 text-sm">âŒ ${e.message}</p>`; }
}

function renderAnalysis(d) {
  const div = document.getElementById('analysis-content');
  if (!d.hasSignificant) {
    div.innerHTML = `
      <div class="bg-gray-900 border border-gray-700 rounded-xl p-5">
        <p class="text-yellow-400 font-semibold mb-2">âš ï¸ Sin simulaciones significativas</p>
        <p class="text-gray-400 text-sm">${d.message}</p>
        ${d.testingCount > 0 ? `<p class="text-gray-500 text-sm mt-2">${d.testingCount} simulaciÃ³n(es) de testing (&lt;6h) no pueden calibrar el algoritmo.</p>` : ''}
      </div>`;
    return;
  }

  const accColor = parseFloat(d.overallAccuracy) > 60 ? 'text-green-400' : parseFloat(d.overallAccuracy) > 40 ? 'text-yellow-400' : 'text-red-400';
  const modeLabel = d.mode === 'speculative' ? 'Especulativo' : 'Generalista';
  const modeColor = d.mode === 'speculative' ? 'yellow' : 'blue';
  
  let html = `
    <div class="bg-gray-900 border border-${modeColor}-900 rounded-xl p-4 mb-4">
      <p class="text-sm text-gray-400 mb-2">ğŸ“‹ Fuente de datos</p>
      <p class="text-sm text-${modeColor}-300"><span class="font-bold">${d.cyclesThisMode || 0}</span> ciclos completados del modelo <span class="font-bold">${modeLabel}</span> (${d.significantCount} significativos, ${d.testingCount} de testing)</p>
      <p class="text-xs text-gray-500 mt-1">${d.note || ''}</p>
    </div>
    <div class="grid grid-cols-3 gap-3 mb-5">
      <div class="bg-gray-900 border border-gray-800 rounded-xl p-4 text-center"><div class="text-2xl font-bold ${accColor}">${d.overallAccuracy}%</div><div class="text-xs text-gray-500 mt-1">Accuracy Global</div></div>
      <div class="bg-gray-900 border border-gray-800 rounded-xl p-4 text-center"><div class="text-2xl font-bold text-${modeColor}-400">${d.significantCount}</div><div class="text-xs text-gray-500 mt-1">Significativas (â‰¥6h)</div></div>
      <div class="bg-gray-900 border border-gray-800 rounded-xl p-4 text-center"><div class="text-2xl font-bold text-gray-400">${d.testingCount}</div><div class="text-xs text-gray-500 mt-1">Testing (&lt;6h)</div></div>
    </div>
    <div class="grid grid-cols-3 gap-3 mb-5">`;

  ['INVERTIBLE','APALANCADO','RUIDOSO'].forEach(cat => {
    const a = d.analysis?.[cat]; if (!a) return;
    const col = cat==='INVERTIBLE'?'green':cat==='APALANCADO'?'yellow':'gray';
    const ac = parseFloat(a.accuracy) > 60 ? 'text-green-400' : parseFloat(a.accuracy) > 40 ? 'text-yellow-400' : 'text-red-400';
    html += `<div class="bg-gray-900 border border-${col}-900 rounded-xl p-4">
      <p class="text-xs font-semibold text-${col}-400 mb-2">${cat}</p>
      <div class="text-2xl font-bold ${ac} mono">${a.accuracy}%</div>
      <p class="text-xs text-gray-500 mt-1">${a.correct}/${a.total} correctas</p>
      <p class="text-xs text-gray-600">Error prom: ${a.avgError}% Â· mÃ¡x: ${a.maxError}%</p>
    </div>`;
  });

  html += `</div>
    <div class="mb-5">
      <p class="text-sm font-semibold mb-3">ğŸ’¡ Recomendaciones de ajuste</p>
      <div class="space-y-2">`;

  d.recommendations.forEach(rec => {
    const col = rec.priority==='HIGH'?'red':rec.priority==='MEDIUM'?'yellow':'green';
    html += `<div class="bg-gray-900 border border-${col}-900 rounded-xl p-4">
      <div class="flex items-start gap-3">
        <span class="pill bg-${col}-950 text-${col}-400 flex-shrink-0">${rec.priority}</span>
        <div>
          <p class="text-sm font-medium text-gray-200">${rec.category}: ${rec.issue}</p>
          <p class="text-xs text-gray-400 mt-1">â†’ ${rec.suggestion}</p>
        </div>
      </div>
    </div>`;
  });

  html += `</div></div>
    <div class="bg-gray-900 border border-blue-900 rounded-xl p-5">
      <div class="flex justify-between items-center mb-3">
        <p class="text-sm font-semibold text-blue-400">âš™ï¸ ConfiguraciÃ³n sugerida</p>
        <button onclick="applySuggestion()" class="bg-blue-700 hover:bg-blue-600 px-4 py-2 rounded-lg text-sm font-semibold">Aplicar ajuste</button>
      </div>
      <pre class="text-xs mono bg-gray-950 p-3 rounded-lg overflow-auto max-h-48 text-gray-400">${JSON.stringify({classification:d.suggestedConfig?.classification,prediction:d.suggestedConfig?.prediction},null,2)}</pre>
      <p class="text-xs text-gray-600 mt-2">${d.note}</p>
    </div>`;

  div.innerHTML = html;
}

async function applySuggestion() {
  if (!confirm(`Â¿Aplicar la configuraciÃ³n sugerida al modelo ${currentMode === 'speculative' ? 'Especulativo' : 'Generalista'}?`)) return;
  try {
    const r = await fetch('/api/simulations/apply-suggestion', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ mode: currentMode })
    });
    const d = await r.json();
    if (d.success) { 
      config = d.applied; 
      applyConfigToUI(); 
      alert(`âœ… ConfiguraciÃ³n aplicada al modelo ${currentMode === 'speculative' ? 'Especulativo' : 'Generalista'}`); 
      loadAnalysis(); 
    } else {
      alert('âŒ ' + d.error);
    }
  } catch(e) { 
    alert('âŒ ' + e.message); 
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ESTADO APIs
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadAPIStatus() {
  ['apis-free','apis-freemium','apis-paid','apis-premium'].forEach(id => {
    document.getElementById(id).innerHTML = '<p class="text-gray-600 text-sm">Verificando...</p>';
  });
  // Cargar estado de agentes LLM en paralelo
  renderLLMAgentsStatus();
  try {
    const r=await fetch('/api/status/complete'); const d=await r.json();
    if(!d.success) throw new Error(d.error);
    const s=d.summary;
    document.getElementById('api-summary').innerHTML=`
      <div class="bg-gray-900 border border-gray-800 rounded-xl p-4 text-center"><div class="text-2xl font-bold text-blue-400">${s.total}</div><div class="text-xs text-gray-500">Total</div></div>
      <div class="bg-green-950 border border-green-900 rounded-xl p-4 text-center"><div class="text-2xl font-bold text-green-400">${s.available}</div><div class="text-xs text-gray-500">Operacionales</div></div>
      <div class="bg-yellow-950 border border-yellow-900 rounded-xl p-4 text-center"><div class="text-2xl font-bold text-yellow-400">${s.configured}</div><div class="text-xs text-gray-500">Configuradas</div></div>
      <div class="bg-red-950 border border-red-900 rounded-xl p-4 text-center"><div class="text-2xl font-bold text-red-400">${s.errors}</div><div class="text-xs text-gray-500">Con errores</div></div>`;
    const groups={free:[],freemium:[],paid:[],premium:[]};
    Object.entries(d.apis).forEach(([k,api])=>{ if(groups[api.tier]) groups[api.tier].push({key:k,...api}); });
    ['free','freemium','paid','premium'].forEach(tier=>{
      document.getElementById('apis-'+tier).innerHTML = groups[tier].length
        ? groups[tier].map(api=>buildAPICard(api)).join('')
        : '<p class="text-gray-700 text-sm">â€”</p>';
    });
  } catch(e){ document.getElementById('api-summary').innerHTML=`<div class="col-span-4 text-red-400 text-sm">âŒ ${e.message}</div>`; }
}

async function renderLLMAgentsStatus() {
  const grid = document.getElementById('llm-agents-status-grid');
  const globalBadge = document.getElementById('llm-global-badge');
  if (!grid) return;

  try {
    const r = await fetch('/api/insights/keys-status');
    if (!r.ok) throw new Error('HTTP ' + r.status);
    const d = await r.json();
    if (!d.success) throw new Error(d.error);

    const n = d.configured;
    const total = d.total || 7;
    if (globalBadge) {
      globalBadge.innerHTML = n >= 2
        ? `<span class="text-green-400 font-semibold">âœ… ${n}/${total} activos</span>`
        : `<span class="text-yellow-400">âš ï¸ ${n}/${total} â€” necesitas â‰¥2</span>`;
    }

    const docsUrls = {
      gemini:   'https://aistudio.google.com/apikey',
      claude:   'https://console.anthropic.com/settings/keys',
      openai:   'https://platform.openai.com/api-keys',
      groq:     'https://console.groq.com/keys',
      mistral:  'https://console.mistral.ai/api-keys',
      cohere:   'https://dashboard.cohere.com/api-keys',
      cerebras: 'https://cloud.cerebras.ai/',
    };

    grid.innerHTML = LLM_AGENTS_CATALOG.map(agent => {
      const ok = d.keys[agent.key];
      const border = ok ? 'border-green-800' : 'border-gray-800';
      const badgeHtml = ok
        ? `<span class="inline-flex items-center gap-1 text-xs text-green-300 bg-green-950 px-2 py-0.5 rounded-full font-semibold">
             <span class="w-1.5 h-1.5 rounded-full bg-green-400 animate-pulse inline-block"></span> Conectado
           </span>`
        : `<span class="text-xs text-gray-600 bg-gray-800 px-2 py-0.5 rounded-full">âšª Sin key</span>`;

      return `
        <div class="bg-gray-800 border ${border} rounded-xl p-3">
          <div class="flex items-center justify-between mb-1">
            <div class="flex items-center gap-2">
              <span>${agent.icon}</span>
              <span class="text-sm font-semibold">${agent.name}</span>
              <span class="text-xs px-1.5 py-0.5 rounded ${agent.tierCss}">${agent.tier}</span>
            </div>
            ${badgeHtml}
          </div>
          ${!ok ? `<div class="mt-1.5">
            <a href="${docsUrls[agent.key]}" target="_blank"
              class="text-xs text-blue-400 hover:text-blue-300 underline underline-offset-2">
              â†’ Obtener key gratis
            </a>
          </div>` : ''}
        </div>`;
    }).join('');

  } catch(e) {
    grid.innerHTML = `<p class="text-red-400 text-xs col-span-3">âŒ Error al verificar agentes: ${e.message}</p>`;
  }
}

async function loadLLMStatus() {
  try {
    const r = await fetch('/api/insights/keys-status');
    if (!r.ok) return;
    const d = await r.json();
    if (!d.success) return;
    // Actualizar badges en los cards de configuraciÃ³n
    const ids = ['gemini','claude','openai','groq','mistral','cohere','cerebras'];
    ids.forEach(id => {
      const badge = document.getElementById('llm-badge-' + id);
      if (!badge) return;
      badge.innerHTML = d.keys[id]
        ? `<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-green-900 text-green-300 text-xs font-semibold">
             <span class="w-1.5 h-1.5 rounded-full bg-green-400 animate-pulse inline-block"></span> Conectado
           </span>`
        : `<span class="px-2 py-0.5 rounded-full bg-gray-800 text-gray-500 text-xs">âšª Sin configurar</span>`;
    });
    const gb = document.getElementById('llm-global-badge');
    if (gb) gb.innerHTML = d.configured >= 2
      ? `<span class="text-green-400 text-xs font-semibold">âœ… ${d.configured}/${d.total||7} agentes activos</span>`
      : `<span class="text-yellow-400 text-xs">âš ï¸ ${d.configured}/${d.total||7} â€” necesitas al menos 2</span>`;
    // Actualizar tambiÃ©n el grid de status si estÃ¡ visible
    renderLLMAgentsStatus();
  } catch(e) { console.warn('[loadLLMStatus]', e.message); }
}

function buildAPICard(api) {
  const icons={operational:'âœ…',error:'âŒ',not_configured:'âšª',limited:'âš ï¸',unknown:'â“'};
  const borders={operational:'border-green-800',error:'border-red-800',not_configured:'border-gray-700',limited:'border-yellow-800'};
  const info=API_INFO[api.key]||{};
  const envMap={cryptocompare:'CRYPTOCOMPARE_API_KEY',newsapi:'NEWSAPI_KEY',github:'GITHUB_TOKEN',telegram:'TELEGRAM_BOT_TOKEN',
    serpapi:'SERPAPI_KEY',twitter:'TWITTER_BEARER_TOKEN',glassnode:'GLASSNODE_API_KEY',cryptoquant:'CRYPTOQUANT_API_KEY',
    whaleAlert:'WHALE_ALERT_API_KEY',lunarcrush:'LUNARCRUSH_API_KEY',santiment:'SANTIMENT_API_KEY',
    coindesk:'',cointelegraph:''};
  const envName=envMap[api.key];
  return `<div class="bg-gray-900 rounded-xl border-l-4 ${borders[api.status]||'border-gray-700'} border border-gray-800 p-4">
    <div class="flex justify-between items-start">
      <div class="flex gap-3 items-start flex-1">
        <span class="text-xl mt-0.5">${icons[api.status]||'â“'}</span>
        <div class="flex-1">
          <div class="flex flex-wrap items-center gap-2 mb-1">
            <span class="font-semibold">${api.name}</span>
            ${api.cost?`<span class="text-xs text-orange-400 mono">${api.cost}</span>`:''}
            ${api.configured?'<span class="text-xs text-green-500">âœ“ configurada</span>':''}
          </div>
          <p class="text-xs text-gray-400 mb-1">${api.message}</p>
          ${api.currentValue?`<p class="text-xs text-blue-300 mb-1">${api.currentValue}</p>`:''}
          ${info.extract?`<div class="mt-2 pt-2 border-t border-gray-800 space-y-0.5">
            <p class="text-xs text-gray-600"><span class="text-gray-500">ğŸ“¤ Extrae:</span> ${info.extract}</p>
            <p class="text-xs text-gray-600"><span class="text-gray-500">ğŸ“ Construye:</span> ${info.indicators}</p>
            <p class="text-xs text-gray-600"><span class="text-gray-500">âš–ï¸ Peso:</span> ${info.weight}</p>
          </div>`:''}
        </div>
      </div>
      ${envName?`<button onclick="openAPIKeyModal('${envName}')" class="ml-3 bg-gray-700 hover:bg-gray-600 text-xs px-2 py-1 rounded flex-shrink-0">âš™ï¸ ${api.configured?'Cambiar':'Config'}</button>`:''}
    </div>
  </div>`;
}

function openAPIKeyModal(name) {
  currentApiKeyName = name;
  document.getElementById('apikey-name').textContent = name;
  document.getElementById('apikey-input').value = '';
  document.getElementById('apikey-msg').innerHTML = '';
  showModal('modal-apikey');
}
async function saveAPIKey() {
  const key=document.getElementById('apikey-input').value.trim();
  const msg=document.getElementById('apikey-msg');
  if(!key){msg.innerHTML='<span class="text-red-400">Introduce una key vÃ¡lida</span>';return;}
  try {
    const r=await fetch('/api/config/api-key',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({apiName:currentApiKeyName,apiKey:key})});
    const d=await r.json();
    if(d.success){msg.innerHTML='<span class="text-green-400">âœ… Guardada</span>';setTimeout(()=>{closeModal('modal-apikey');loadAPIStatus();},1500);}
    else msg.innerHTML=`<span class="text-red-400">âŒ ${d.error}</span>`;
  } catch(e){msg.innerHTML=`<span class="text-red-400">âŒ ${e.message}</span>`;}
}

async function runDebug() {
  const panel=document.getElementById('debug-panel'); panel.classList.remove('hidden');
  panel.innerHTML='<p class="text-gray-400">Ejecutando...</p>';
  try {
    const [r1,r2]=await Promise.all([fetch('/api/debug/redis'),fetch('/api/debug/cycles')]);
    const [d1,d2]=await Promise.all([r1.json(),r2.json()]);
    panel.innerHTML=`<p class="font-bold text-yellow-400 mb-2">ğŸ”§ DiagnÃ³stico Redis</p>
      <p class="${d1.success?'text-green-400':'text-red-400'}">Redis: ${d1.success?'âœ… conectado':'âŒ '+d1.error}</p>
      <p>KV_URL: ${d1.env?.hasUrl?'âœ…':'âŒ'} Â· KV_TOKEN: ${d1.env?.hasToken?'âœ…':'âŒ'}</p>
      <p>Ciclos activos: ${JSON.stringify(d2.activeIds||[])}</p>
      ${d2.firstCycle?`<p class="text-green-400">âœ… ${d2.firstCycle.id} Â· ${d2.firstCycle.status} Â· ${d2.firstCycle.assetsCount} activos</p>`:'<p class="text-gray-500">Sin ciclos en Redis</p>'}`;
  } catch(e){panel.innerHTML=`<p class="text-red-400">âŒ ${e.message}</p>`;}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODALES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showModal(id)  { document.getElementById(id).classList.remove('hidden'); }
function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fmt(n) {
  if (n == null) return 'â€”';
  if (n >= 1000)  return n.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
  if (n >= 1)     return n.toFixed(4);
  if (n >= 0.01)  return n.toFixed(6);
  return n.toFixed(8);
}
function fmtLarge(n) {
  if (!n) return 'â€”';
  if (n >= 1e12) return (n/1e12).toFixed(2)+'T';
  if (n >= 1e9)  return (n/1e9).toFixed(2)+'B';
  if (n >= 1e6)  return (n/1e6).toFixed(1)+'M';
  if (n >= 1e3)  return (n/1e3).toFixed(0)+'K';
  return n.toFixed(0);
}
function fmtDur(ms) {
  if (!ms) return 'â€”';
  const h=Math.floor(ms/3600000), m=Math.floor((ms%3600000)/60000);
  if (h===0) return m+'min'; if (m===0) return h+'h'; return h+'h '+m+'min';
}
function fmtCountdown(ms) {
  if (ms<=0) return '00:00:00';
  const h=Math.floor(ms/3600000), m=Math.floor((ms%3600000)/60000), s=Math.floor((ms%60000)/1000);
  return String(h).padStart(2,'0')+':'+String(m).padStart(2,'0')+':'+String(s).padStart(2,'0');
}
function timeAgo(iso) {
  const d=Math.floor((Date.now()-new Date(iso).getTime())/60000);
  if (d<60) return d+'min'; if (d<1440) return Math.floor(d/60)+'h'; return Math.floor(d/1440)+'d';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MÃ“DULO DE INVERSIÃ“N v4
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let investConfig  = null;
let investCurrentSubtab = 'inv-overview';

// â”€â”€ NavegaciÃ³n sub-tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openTab(tab) {
  document.querySelectorAll('.inv-subtab').forEach(el => el.classList.add('hidden'));
  document.querySelectorAll('.invtab').forEach(el => {
    el.classList.remove('bg-gray-800','text-white');
    el.classList.add('text-gray-400');
  });
  const el = document.getElementById(tab);
  if (el) el.classList.remove('hidden');
  const btn = document.getElementById('invtab-' + tab);
  if (btn) { btn.classList.add('bg-gray-800','text-white'); btn.classList.remove('text-gray-400'); }
  investCurrentSubtab = tab;
  if (tab === 'inv-overview')    loadInvestOverview();
  if (tab === 'inv-positions')   loadInvestPositions();
  if (tab === 'inv-performance') { loadInvestPerformance(); loadCalibrationStatus(); }
  if (tab === 'inv-log')         loadInvestLog();
  if (tab === 'inv-rounds')      loadInvestRounds();
}

// â”€â”€ Carga inicial del mÃ³dulo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadInvestData() {
  try {
    const r = await fetch('/api/invest/config');
    const d = await r.json();
    if (d.success) { investConfig = d.config; applyInvestConfigToUI(); }
  } catch(_) {}
  openTab(investCurrentSubtab);
}

function applyInvestConfigToUI() {
  if (!investConfig) return;
  const c = investConfig;
  // Mode buttons
  ['simulated','testnet','real'].forEach(m => {
    const btn = document.getElementById('imode-' + m);
    if (btn) { btn.classList.toggle('bg-blue-700', m === c.mode); btn.classList.toggle('bg-gray-700', m !== c.mode); btn.classList.toggle('text-white', m === c.mode); }
  });
  // Exchange buttons
  ['binance','coinbase'].forEach(ex => {
    const btn = document.getElementById('iex-' + ex);
    if (btn) { btn.classList.toggle('bg-yellow-700', ex === 'binance' && c.exchange === ex); btn.classList.toggle('bg-blue-700', ex === 'coinbase' && c.exchange === ex); btn.classList.toggle('bg-gray-700', c.exchange !== ex); btn.classList.toggle('text-white', c.exchange === ex); }
  });
  // Sliders/inputs
  const set = (id, val, lbId, fmt) => { const el=document.getElementById(id); const lb=document.getElementById(lbId); if(el) el.value=val; if(lb) lb.textContent=fmt(val); };
  set('ic-capital',  c.capitalTotal,                 'ic-capital-v',  v => '$'+v);
  set('ic-percycle', Math.round((c.capitalPerCycle||0.3)*100), 'ic-percycle-v', v => v+'%');
  set('ic-maxpos',   c.maxPositions,                 'ic-maxpos-v',   v => v);
  set('ic-minsig',   c.minSignals,                   'ic-minsig-v',   v => v);
  set('ic-tp',       c.takeProfitPct,                'ic-tp-v',       v => '+'+v+'%');
  set('ic-sl',       c.stopLossPct,                  'ic-sl-v',       v => 'âˆ’'+v+'%');
  set('ic-hold',     c.maxHoldCycles,                'ic-hold-v',     v => v);
  set('ic-bp',       Math.round((c.minBoostPower||0.65)*100), 'ic-bp-v', v => v+'%');
  // Mode badge
  const badge = document.getElementById('inv-mode-badge');
  if (badge) { badge.textContent = c.mode === 'simulated' ? 'âš—ï¸ Simulado' : c.mode === 'testnet' ? 'ğŸ§ª Testnet' : 'ğŸ’µ Real'; badge.className = 'pill ' + (c.mode==='real'?'bg-red-900 text-red-300':c.mode==='testnet'?'bg-yellow-900 text-yellow-300':'bg-blue-900 text-blue-300'); }
  const exBadge = document.getElementById('inv-exchange-badge');
  if (exBadge) exBadge.textContent = (c.exchange||'binance').charAt(0).toUpperCase()+(c.exchange||'binance').slice(1);
  document.getElementById('inv-real-warning')?.classList.toggle('hidden', c.mode !== 'real');
}

function setInvestMode(mode) {
  investConfig = { ...(investConfig||{}), mode };
  applyInvestConfigToUI();
}
function setInvestExchange(exchange) {
  investConfig = { ...(investConfig||{}), exchange };
  applyInvestConfigToUI();
}

// â”€â”€ Resumen / Overview â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadInvestOverview() {
  try {
    const r = await fetch('/api/invest/positions');
    const d = await r.json();
    if (!d.success) return;
    const s = d.summary;
    document.getElementById('inv-capital-grid').innerHTML = `
      <div class="bg-gray-900 border border-gray-800 rounded-xl p-4 text-center">
        <p class="text-xs text-gray-500">Capital Total</p><p class="text-2xl font-bold text-white mono">$${s.capitalTotal.toFixed(0)}</p>
        <p class="text-xs text-gray-600 mt-1">${(investConfig?.mode||'simulated')==='simulated'?'âš—ï¸ Simulado':'ğŸ’µ Real'}</p>
      </div>
      <div class="bg-green-950 border border-green-900 rounded-xl p-4 text-center">
        <p class="text-xs text-gray-500">Disponible</p><p class="text-2xl font-bold text-green-400 mono">$${s.capitalAvailable.toFixed(2)}</p>
        <p class="text-xs text-gray-600 mt-1">${((s.capitalAvailable/s.capitalTotal)*100).toFixed(0)}% libre</p>
      </div>
      <div class="bg-blue-950 border border-blue-900 rounded-xl p-4 text-center">
        <p class="text-xs text-gray-500">En posiciones</p><p class="text-2xl font-bold text-blue-400 mono">$${s.capitalInvested.toFixed(2)}</p>
        <p class="text-xs text-gray-600 mt-1">${s.openPositions} abierta${s.openPositions!==1?'s':''}</p>
      </div>
      <div class="${s.totalUnrealizedPnL>=0?'bg-green-950 border-green-900':'bg-red-950 border-red-900'} border rounded-xl p-4 text-center">
        <p class="text-xs text-gray-500">P&L No Realizado</p>
        <p class="text-2xl font-bold ${s.totalUnrealizedPnL>=0?'text-green-400':'text-red-400'} mono">${s.totalUnrealizedPnL>=0?'+':''}$${s.totalUnrealizedPnL.toFixed(2)}</p>
        <p class="text-xs text-gray-600 mt-1">Posiciones abiertas</p>
      </div>`;

    // Posiciones abiertas en resumen
    const openDiv = document.getElementById('inv-open-summary');
    if (d.open.length === 0) {
      openDiv.innerHTML = '<p class="text-gray-500 text-sm">Sin posiciones abiertas.</p>';
    } else {
      // Limpiar timers anteriores antes de re-renderizar
    Object.keys(positionCycleTimers).forEach(id => { clearInterval(positionCycleTimers[id]); delete positionCycleTimers[id]; });
    openDiv.innerHTML = d.open.map(p => renderPositionCard(p, true)).join('');
    }
  } catch(e) { console.error(e); }
}

// â”€â”€ Decidir inversiÃ³n â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// AcciÃ³n rÃ¡pida: bajar minPredictedChange a 0 cuando es la causa del bloqueo
async function fixMinPredictedChange() {
  try {
    const r = await fetch('/api/invest/config', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ minPredictedChange: 0 })
    });
    const d = await r.json();
    if (d.success) {
      if (investConfig) investConfig.minPredictedChange = 0;
      document.getElementById('nr-min-pred') && (document.getElementById('nr-min-pred').value = '0');
      // Re-ejecutar el anÃ¡lisis automÃ¡ticamente
      await decideCycle();
    } else {
      alert('âŒ Error al actualizar: ' + (d.error || 'desconocido'));
    }
  } catch(e) { alert('âŒ ' + e.message); }
}

async function decideCycle() {
  if (!cryptos?.length) {
    document.getElementById('inv-decision').innerHTML = '<p class="text-yellow-400 text-sm">âš ï¸ Primero carga activos en el Monitor.</p>';
    return;
  }
  document.getElementById('inv-decision').innerHTML = '<p class="text-gray-400 text-sm">â³ Analizando...</p>';
  try {
    const r = await fetch('/api/invest/decide', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      // FIX: pasar currentMode para que el backend sincronice el umbral BP correcto
      body: JSON.stringify({ snapshot: cryptos, mode: currentMode })
    });
    const d = await r.json();
    renderDecision(d);
  } catch(e) { document.getElementById('inv-decision').innerHTML = `<p class="text-red-400 text-sm">âŒ ${e.message}</p>`; }
}

function renderDecision(d) {
  const div = document.getElementById('inv-decision');
  if (!d.shouldInvest) {
    const debug = d._debug || {};

    // Construir panel de diagnÃ³stico detallado
    let debugHtml = '';
    if (debug.snapshotTotal != null) {
      const predFilterBlocking = debug.invertiblesFailingPredFilter > 0 &&
        debug.invertiblesPassingAll < (debug.minSignalsRequired ?? 3);

      const filterRows = `
        <p>Activos en snapshot: <span class="text-gray-300">${debug.snapshotTotal}</span></p>
        <p>âœ… INVERTIBLEs (por Algo A): <span class="text-green-400">${debug.invertiblesInSnapshot ?? 'â€”'}</span></p>
        ${debug.minPredictedChange > 0 ? `
        <p class="${predFilterBlocking ? 'text-red-400' : 'text-gray-400'}">
          âŒ Descartados por pred &lt; ${debug.minPredictedChange}%:
          <span class="font-bold">${debug.invertiblesFailingPredFilter ?? 'â€”'}</span>
          ${predFilterBlocking ? ' â† <b>CAUSA DEL PROBLEMA</b>' : ''}
        </p>` : ''}
        <p>Pasan todos los filtros: <span class="${(debug.invertiblesPassingAll ?? 0) >= (debug.minSignalsRequired ?? 3) ? 'text-green-400' : 'text-red-400'} font-bold">${debug.invertiblesPassingAll ?? 'â€”'}</span>
          <span class="text-gray-500"> (mÃ­nimo: ${debug.minSignalsRequired ?? 3})</span></p>
        <p>BP mÃ­nimo (Algo A ${d.snapshotMode === 'speculative' ? 'espec.' : 'normal'}): <span class="text-blue-400">${debug.minBoostFromAlgoA != null ? (debug.minBoostFromAlgoA*100).toFixed(0)+'%' : 'â€”'}</span></p>
        <p>Modo snapshot: <span class="text-purple-400">${d.snapshotMode || d.mode || 'â€”'}</span></p>`;

      const topRows = debug.topInvertibles?.length ? `
        <p class="mt-2 text-gray-600 border-t border-gray-800 pt-2">Top INVERTIBLEs del snapshot:</p>
        ${debug.topInvertibles.map(a =>
          `<p class="ml-2 ${a.failsPred ? 'text-red-500' : 'text-gray-300'}">
            ${a.failsPred ? 'âœ—' : 'âœ“'} ${a.symbol}: BP=${(a.boostPower*100).toFixed(0)}%
            pred=+${a.predicted}%${a.failsPred ? ` (falla predâ‰¥${debug.minPredictedChange}%)` : ''}
          </p>`
        ).join('')}` : '';

      const quickFix = predFilterBlocking ? `
        <div class="mt-3 pt-3 border-t border-gray-800">
          <p class="text-yellow-400 mb-1">ğŸ’¡ SoluciÃ³n rÃ¡pida:</p>
          <p class="text-gray-400 mb-2">El filtro <b>pred â‰¥ ${debug.minPredictedChange}%</b> estÃ¡ descartando ${debug.invertiblesFailingPredFilter} INVERTIBLEs vÃ¡lidos.
          Los activos ya fueron validados por el Algoritmo A â€” el filtro pred es redundante.</p>
          <button onclick="fixMinPredictedChange()" class="bg-blue-700 hover:bg-blue-600 px-3 py-1.5 rounded-lg text-xs font-semibold">
            ğŸ”§ Bajar pred mÃ­nima a 0% (recomendado)
          </button>
        </div>` : '';

      debugHtml = `
        <details class="mt-3 text-xs text-gray-500" open>
          <summary class="cursor-pointer hover:text-gray-300 font-semibold">ğŸ” DiagnÃ³stico de filtrado</summary>
          <div class="mt-2 space-y-1 font-mono bg-gray-950 p-3 rounded-lg">
            ${filterRows}${topRows}${quickFix}
          </div>
        </details>`;
    }

    div.innerHTML = `
      <div class="bg-yellow-950 border border-yellow-800 rounded-xl p-4">
        <p class="text-yellow-400 font-semibold">â¸ï¸ No invertir en este ciclo</p>
        <p class="text-gray-400 text-sm mt-1">${d.reason}</p>
        <p class="text-gray-500 text-sm mt-1">Capital disponible: $${d.capitalAvailable?.toFixed(2)||'â€”'} â†’ se mantiene en ${investConfig?.stableCoin||'USDT'}</p>
        ${debugHtml}
      </div>`;
    return;
  }
  const cols = d.targets.map(t => `
    <div class="bg-gray-800 rounded-xl p-4 border-l-4 border-green-600">
      <div class="flex justify-between items-start mb-2">
        <div>
          <p class="font-bold">${t.name} <span class="text-gray-400 mono text-xs">${t.symbol.toUpperCase()}</span></p>
          <p class="text-xs text-gray-500">#${t.rank} Â· BP ${t.boostPowerPct}% Â· ${t.classification}</p>
        </div>
        <div class="text-right">
          <p class="text-green-400 font-bold">$${t.capitalUSD}</p>
          <p class="text-xs text-gray-500">${t.weight}% del ciclo</p>
        </div>
      </div>
      <div class="grid grid-cols-3 gap-2 text-xs mt-2">
        <div class="bg-gray-900 rounded p-1.5 text-center"><p class="text-gray-500">Entrada</p><p class="mono font-medium">$${fmt(t.entryPrice)}</p></div>
        <div class="bg-green-950 rounded p-1.5 text-center"><p class="text-gray-500">Take Profit</p><p class="text-green-400 mono font-medium">$${fmt(t.takeProfitPrice)}</p></div>
        <div class="bg-red-950 rounded p-1.5 text-center"><p class="text-gray-500">Stop Loss</p><p class="text-red-400 mono font-medium">$${fmt(t.stopLossPrice)}</p></div>
      </div>
      <p class="text-xs text-gray-500 mt-2">PredicciÃ³n: +${t.predictedChange}% Â· Fee est.: $${t.expectedFeeUSD}</p>
    </div>`).join('');

  div.innerHTML = `
    <div class="mb-3">
      <p class="text-green-400 font-semibold mb-1">âœ… ${d.targets.length} inversiÃ³n${d.targets.length!==1?'es':''} recomendada${d.targets.length!==1?'s':''}</p>
      <p class="text-gray-400 text-sm">${d.reason} Â· Capital del ciclo: $${d.cycleCapital} Â· Modo: ${d.mode}</p>
    </div>
    <div class="grid grid-cols-${Math.min(d.targets.length,3)} gap-3 mb-4">${cols}</div>
    <button onclick="executeInvestment()" class="w-full bg-green-700 hover:bg-green-600 py-3 rounded-xl font-bold text-lg">
      ${d.mode==='simulated'?'âš—ï¸ Ejecutar (Simulado)':'ğŸ’µ Ejecutar INVERSIÃ“N REAL'}
    </button>`;

  // Guardar targets para ejecutar
  window._pendingTargets = d;
}

async function executeInvestment() {
  if (!window._pendingTargets?.shouldInvest) return;
  const btn = event.currentTarget;
  btn.disabled = true; btn.textContent = 'â³ Ejecutando...';
  try {
    const r = await fetch('/api/invest/execute', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ snapshot: cryptos, cycleId: null })
    });
    const d = await r.json();
    if (d.success && d.invested) {
      document.getElementById('inv-decision').innerHTML = `
        <div class="bg-green-950 border border-green-800 rounded-xl p-4">
          <p class="text-green-400 font-bold">âœ… ${d.positionsOpened} posiciÃ³n${d.positionsOpened!==1?'es':''} ${d.mode==='simulated'?'simulada':'abierta'}${d.positionsOpened!==1?'s':''}</p>
          <p class="text-gray-400 text-sm mt-1">Total invertido: $${d.totalInvestedUSD} Â· Exchange: ${d.exchange} Â· Modo: ${d.mode}</p>
        </div>`;
      await loadInvestOverview();
    } else {
      document.getElementById('inv-decision').innerHTML = `<p class="text-red-400 text-sm">âŒ ${d.reason||d.error}</p>`;
      btn.disabled = false; btn.textContent = d.mode==='simulated'?'âš—ï¸ Ejecutar (Simulado)':'ğŸ’µ Ejecutar INVERSIÃ“N REAL';
    }
  } catch(e) { btn.disabled=false; btn.textContent='Error â€” Reintentar'; }
}

// â”€â”€ Posiciones â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadInvestPositions() {
  loadCurrentRoundBanner(); // update round banner (non-blocking)
  try {
    const r = await fetch('/api/invest/positions');
    const d = await r.json();
    if (!d.success) return;
    document.getElementById('inv-pos-open-list').innerHTML =
      d.open.length ? d.open.map(p => renderPositionCard(p, true)).join('') : '<p class="text-gray-500 text-sm">Sin posiciones abiertas</p>';
    document.getElementById('inv-pos-closed-list').innerHTML =
      d.closed.length ? d.closed.map(p => renderPositionCard(p, false)).join('') : '<p class="text-gray-500 text-sm">Sin posiciones cerradas</p>';
  } catch(e) {}
}

// Timers live de ciclo por posiciÃ³n
const positionCycleTimers = {};

function fmtDuration(ms) {
  if (!ms || ms <= 0) return '00:00:00';
  const h = Math.floor(ms / 3600000);
  const m = Math.floor((ms % 3600000) / 60000);
  const s = Math.floor((ms % 60000) / 1000);
  return h > 0
    ? `${h}h ${String(m).padStart(2,'0')}m ${String(s).padStart(2,'0')}s`
    : `${String(m).padStart(2,'0')}m ${String(s).padStart(2,'0')}s`;
}

function fmtDurationShort(ms) {
  if (!ms || ms <= 0) return 'â€”';
  const h = Math.floor(ms / 3600000);
  const m = Math.floor((ms % 3600000) / 60000);
  if (h > 0) return `${h}h ${m}m`;
  return `${m}m`;
}

function startPositionCycleTimer(posId, cycleInfo) {
  if (positionCycleTimers[posId]) clearInterval(positionCycleTimers[posId]);
  if (!cycleInfo) return;

  // Guardar tiempo de inicio del tick para calcular elapsed relativo
  const tickStart     = Date.now();
  const baseElapsed   = cycleInfo.elapsedMs || 0;
  const hasEndTime    = !!(cycleInfo.endTime && cycleInfo.durationMs);

  positionCycleTimers[posId] = setInterval(() => {
    const now        = Date.now();
    const elapsed    = baseElapsed + (now - tickStart);
    const elEl       = document.getElementById('pos-elapsed-'  + posId);
    const remEl      = document.getElementById('pos-remaining-' + posId);
    const barEl      = document.getElementById('pos-bar-'      + posId);
    const pctEl      = document.getElementById('pos-pct-'      + posId);

    if (elEl) elEl.textContent = fmtDuration(elapsed);

    if (hasEndTime) {
      const remaining = Math.max(0, cycleInfo.endTime - now);
      const pct       = Math.min(100, Math.round((now - cycleInfo.startTime) / cycleInfo.durationMs * 100));
      const barColor  = pct >= 100 ? 'bg-green-500' : pct >= 60 ? 'bg-yellow-500' : 'bg-blue-500';

      if (remEl) remEl.textContent = remaining > 0 ? fmtDuration(remaining) : 'âœ… Completado';
      if (pctEl) pctEl.textContent = pct + '%';
      if (barEl) { barEl.style.width = pct + '%'; barEl.className = 'h-full rounded-full transition-all ' + barColor; }
      if (remaining === 0) clearInterval(positionCycleTimers[posId]);
    }
  }, 1000);
}

function renderPositionCard(p, isOpen) {
  const pnl    = isOpen ? p.unrealizedPnL : p.realizedPnL;
  const pnlPct = isOpen ? p.unrealizedPnLPct : p.realizedPnLPct;
  const pnlPos = (pnl||0) >= 0;
  const border    = isOpen ? (pnlPos ? 'border-green-800' : 'border-red-800') : 'border-gray-800';
  const pnlColor  = pnlPos ? 'text-green-400' : 'text-red-400';
  const modeBadge = p.mode==='simulated'
    ? '<span class="pill bg-blue-950 text-blue-400 text-xs">âš—ï¸ SIM</span>'
    : p.mode==='testnet'
      ? '<span class="pill bg-yellow-950 text-yellow-400 text-xs">ğŸ§ª TEST</span>'
      : '<span class="pill bg-red-950 text-red-400 text-xs">ğŸ’µ REAL</span>';

  const ci = p.cycleInfo;

  // â”€â”€ Bloque de progreso del ciclo (posiciones abiertas) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const cycleBlock = (() => {
    if (!isOpen) return '';

    // Si no hay cycleInfo en absoluto â€” mostrar mensaje de diagnÃ³stico
    if (!ci) {
      return `<div class="mt-3 pt-3 border-t border-gray-800">
        <p class="text-xs text-gray-600">â³ Cargando datos del ciclo...</p>
      </div>`;
    }

    const iterColor  = ci.iterationsLeft <= 1 ? 'text-red-400' : ci.iterationsLeft <= 2 ? 'text-yellow-400' : 'text-gray-200';
    const elapsedStr = fmtDuration(ci.elapsedMs || 0);

    // â”€â”€ Caso A: tenemos el ciclo completo con endTime â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if (ci.endTime && ci.durationMs) {
      const pct        = ci.progressPct ?? 0;
      const remainMs   = ci.remainingMs ?? 0;
      const remainStr  = remainMs > 0 ? fmtDuration(remainMs) : 'âœ… Completado';
      const barColor   = pct >= 100 ? 'bg-green-500' : pct >= 60 ? 'bg-yellow-500' : 'bg-blue-500';
      const remColor   = remainMs === 0 ? 'text-green-400' : 'text-blue-300';
      const totalHuman = fmtDurationShort(ci.durationMs);

      return `
      <div class="mt-3 pt-3 border-t border-gray-700">
        <p class="text-xs font-semibold text-gray-400 mb-2 uppercase tracking-wide">Progreso del ciclo</p>

        <!-- MÃ©tricas principales -->
        <div class="grid grid-cols-4 gap-2 mb-3">
          <div class="bg-gray-800 rounded-lg p-2 text-center">
            <p class="text-xs text-gray-500">IteraciÃ³n</p>
            <p class="text-xl font-bold mono text-white">${ci.currentIteration}<span class="text-gray-600 text-xs">/${ci.totalIterations}</span></p>
          </div>
          <div class="bg-gray-800 rounded-lg p-2 text-center">
            <p class="text-xs text-gray-500">Hold restantes</p>
            <p class="text-xl font-bold mono ${iterColor}">${ci.iterationsLeft}</p>
          </div>
          <div class="bg-gray-800 rounded-lg p-2 text-center">
            <p class="text-xs text-gray-500">DuraciÃ³n</p>
            <p class="text-sm font-bold text-gray-300 mt-1">${totalHuman}</p>
          </div>
          <div class="bg-gray-800 rounded-lg p-2 text-center">
            <p class="text-xs text-gray-500">Completado</p>
            <p class="text-xl font-bold mono text-blue-400" id="pos-pct-${p.id}">${pct}%</p>
          </div>
        </div>

        <!-- Barra de progreso -->
        <div class="w-full bg-gray-800 rounded-full h-2.5 mb-3">
          <div id="pos-bar-${p.id}" class="h-full rounded-full transition-all ${barColor}" style="width:${pct}%"></div>
        </div>

        <!-- Tiempos transcurrido / restante -->
        <div class="grid grid-cols-2 gap-2">
          <div class="bg-gray-800/70 rounded-lg px-3 py-2">
            <p class="text-xs text-gray-500 mb-0.5">â± Transcurrido</p>
            <p class="text-sm font-bold mono text-white" id="pos-elapsed-${p.id}">${elapsedStr}</p>
          </div>
          <div class="bg-gray-800/70 rounded-lg px-3 py-2">
            <p class="text-xs text-gray-500 mb-0.5">â³ Restante</p>
            <p class="text-sm font-bold mono ${remColor}" id="pos-remaining-${p.id}">${remainStr}</p>
          </div>
        </div>
      </div>`;
    }

    // â”€â”€ Caso B: fallback â€” solo tenemos tiempo transcurrido (sin endTime) â”€â”€
    return `
    <div class="mt-3 pt-3 border-t border-gray-700">
      <p class="text-xs font-semibold text-gray-400 mb-2 uppercase tracking-wide">Progreso del ciclo</p>
      <div class="grid grid-cols-3 gap-2">
        <div class="bg-gray-800 rounded-lg p-2 text-center">
          <p class="text-xs text-gray-500">IteraciÃ³n</p>
          <p class="text-xl font-bold mono text-white">${ci.currentIteration}<span class="text-gray-600 text-xs">/${ci.totalIterations}</span></p>
        </div>
        <div class="bg-gray-800 rounded-lg p-2 text-center">
          <p class="text-xs text-gray-500">Hold restantes</p>
          <p class="text-xl font-bold mono ${iterColor}">${ci.iterationsLeft}</p>
        </div>
        <div class="bg-gray-800/70 rounded-lg p-2 text-center">
          <p class="text-xs text-gray-500">â± Abierta hace</p>
          <p class="text-sm font-bold mono text-white" id="pos-elapsed-${p.id}">${elapsedStr}</p>
        </div>
      </div>
    </div>`;
  })();

  const html = `
    <div class="bg-gray-900 rounded-xl border ${border} p-4 mb-3">
      <!-- Header: nombre + P&L -->
      <div class="flex justify-between items-start mb-3">
        <div>
          <div class="flex items-center gap-2 mb-1">
            <span class="font-bold text-base">${p.name}</span>
            <span class="text-gray-500 mono text-xs">${(p.symbol||'').toUpperCase()}</span>
            ${modeBadge}
            ${isOpen
              ? '<span class="pill bg-green-900 text-green-300 text-xs">â— ABIERTA</span>'
              : `<span class="pill bg-gray-800 text-gray-400 text-xs">${p.closeReason||'cerrada'}</span>`}
          </div>
          <div class="text-xs text-gray-500 space-y-0.5">
            <p>Entrada: <span class="mono text-white">$${fmt(p.entryPrice)}</span>
              Â· ${isOpen ? `Actual: <span class="mono text-white">$${fmt(p.currentPrice)}</span>` : `Cierre: <span class="mono text-white">$${fmt(p.currentPrice)}</span>`}
            </p>
            <p>Capital: <span class="mono text-white">$${p.capitalUSD}</span>
              Â· Fees: <span class="mono text-yellow-400">$${(p.totalFeesUSD||p.entryFeeUSD||0).toFixed(4)}</span>
              Â· ${p.exchange}
            </p>
            <p>TP: <span class="mono text-green-400">$${fmt(p.takeProfitPrice)}</span>
              Â· SL: <span class="mono text-red-400">$${fmt(p.stopLossPrice)}</span>
            </p>
            ${(p.predictedChange != null) ? `<p>
              PredicciÃ³n: <span class="mono font-semibold ${(p.predictedChange||0) >= 0 ? 'text-blue-400' : 'text-orange-400'}">${(p.predictedChange||0) >= 0 ? '+' : ''}${(p.predictedChange||0).toFixed(2)}%</span>
              ${(p.boostPower != null) ? `Â· BoostPower: <span class="mono text-purple-400">${(p.boostPower||0).toFixed(3)}</span>` : ''}
            </p>` : ''}
          </div>
        </div>
        <div class="text-right flex-shrink-0 ml-3">
          <p class="${pnlColor} text-2xl font-bold mono">${pnlPos?'+':''}${(pnlPct||0).toFixed(2)}%</p>
          <p class="${pnlColor} text-sm mono">${pnlPos?'+':''}$${(pnl||0).toFixed(4)}</p>
          ${isOpen ? `<button onclick="closePosition('${p.id}')" class="mt-2 bg-red-900 hover:bg-red-800 px-3 py-1 rounded text-xs text-red-300">âœ• Cerrar</button>` : ''}
        </div>
      </div>

      <!-- Bloque de progreso del ciclo -->
      ${cycleBlock}

      <!-- Feedback algoritmo -->
      ${p.algorithmFeedback && !p.algorithmFeedback.predictionCorrect ? `
        <div class="mt-3 pt-3 border-t border-gray-800 bg-red-950/30 rounded-lg p-2">
          <p class="text-xs text-red-400 font-semibold">âš ï¸ PredicciÃ³n incorrecta â€” retroalimentaciÃ³n al algoritmo</p>
          <p class="text-xs text-gray-400">Predicho: +${p.algorithmFeedback.predictedChange}% Â· Real: ${p.algorithmFeedback.actualChange}% Â· Error: ${p.algorithmFeedback.errorMagnitude}%</p>
          ${p.algorithmFeedback.suggestion ? `<p class="text-xs text-yellow-400 mt-0.5">â†’ ${p.algorithmFeedback.suggestion}</p>` : ''}
        </div>` : ''}
    </div>`;

  // Arrancar timer live para elapsed y countdown
  if (isOpen && ci) {
    setTimeout(() => startPositionCycleTimer(p.id, ci), 50);
  }

  return html;
}

async function closePosition(id) {
  if (!confirm('Â¿Cerrar esta posiciÃ³n manualmente?')) return;
  try {
    const r = await fetch(`/api/invest/positions/${id}/close`, { method:'POST' });
    const d = await r.json();
    if (d.success) { await loadInvestPositions(); await loadInvestOverview(); }
    else alert('âŒ ' + d.error);
  } catch(e) { alert('âŒ ' + e.message); }
}

// â”€â”€ Evaluar ciclo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function evaluateCycle() {
  try {
    const r = await fetch('/api/invest/evaluate', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ cycleId: null })
    });
    const d = await r.json();
    if (!d.success) { alert('âŒ ' + d.error); return; }
    const sells = d.evaluations.filter(e => e.sold).length;
    const holds = d.evaluations.filter(e => !e.sold).length;
    alert(`EvaluaciÃ³n completada:
âœ… Vendidas: ${sells}
â¸ï¸ Mantenidas: ${holds}
P&L neto: $${d.summary?.netReturnUSD??'â€”'} (${d.summary?.netReturnPct??'â€”'}%)`);
    await loadInvestPositions(); await loadInvestOverview();
  } catch(e) { alert('âŒ '+e.message); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RONDAS DE INVERSIÃ“N â€” JavaScript
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let _currentRoundData = null;

// â”€â”€ Cargar estado de ronda activa (actualiza banners en Posiciones) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadCurrentRoundBanner() {
  try {
    const r = await fetch('/api/invest/rounds');
    const d = await r.json();
    if (!d.success) return;
    _currentRoundData = d.current;
    const hasCurrent = d.current && d.current.status === 'active';
    document.getElementById('inv-round-banner')?.classList.toggle('hidden', !hasCurrent);
    document.getElementById('inv-no-round-banner')?.classList.toggle('hidden', hasCurrent);
    if (hasCurrent) {
      const rnd = d.current;
      document.getElementById('inv-round-label').textContent = `Ronda #${rnd.roundNumber} activa`;
      const since = rnd.openedAt ? ` Â· Iniciada ${_fmtRelTime(new Date(rnd.openedAt).getTime())}` : '';
      document.getElementById('inv-round-info').textContent = `Modo ${rnd.config?.mode || 'â€”'} Â· TP ${rnd.config?.takeProfitPct || 'â€”'}% / SL ${rnd.config?.stopLossPct || 'â€”'}%${since}`;
    }
  } catch(_) {}
}

function _fmtRelTime(ts) {
  const d = Date.now() - ts;
  const h = Math.floor(d / 3600000), m = Math.floor((d % 3600000) / 60000);
  if (h > 24) return `hace ${Math.floor(h/24)}d ${h%24}h`;
  return h > 0 ? `hace ${h}h ${m}m` : `hace ${m}m`;
}

// â”€â”€ Cargar tab Rondas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadInvestRounds() {
  const activeDiv  = document.getElementById('inv-rounds-active');
  const histDiv    = document.getElementById('inv-rounds-history');
  try {
    const r = await fetch('/api/invest/rounds');
    const d = await r.json();
    if (!d.success) { histDiv.innerHTML = `<p class="text-red-400 text-sm">âŒ ${d.error}</p>`; return; }

    // Ronda activa
    if (d.current && d.current.status === 'active') {
      const c = d.current;
      const since = c.openedAt ? _fmtRelTime(new Date(c.openedAt).getTime()) : 'â€”';

      // Cargar posiciones para calcular mÃ©tricas en vivo
      let openPositions = [], closedPositions = [];
      try {
        const pr = await fetch('/api/invest/positions');
        const pd = await pr.json();
        if (pd.success) {
          openPositions   = pd.open  || [];
          closedPositions = pd.closed || [];
          if (c.openedAt) {
            const roundStart = new Date(c.openedAt).getTime();
            closedPositions = closedPositions.filter(p => {
              const closedAt = p.closedAt ? new Date(p.closedAt).getTime() : 0;
              const openedAt = p.openedAt ? new Date(p.openedAt).getTime() : 0;
              return openedAt >= roundStart || closedAt >= roundStart;
            });
          }
        }
      } catch(_) {}

      // â”€â”€ MÃ©tricas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const totalClosed   = closedPositions.length;
      const wins          = closedPositions.filter(p => (p.realizedPnL || 0) > 0).length;
      const losses        = totalClosed - wins;
      const winRate       = totalClosed > 0 ? ((wins / totalClosed) * 100).toFixed(1) : null;
      const winRateColor  = winRate === null ? 'text-gray-500'
                            : parseFloat(winRate) >= 60 ? 'text-green-400'
                            : parseFloat(winRate) >= 45 ? 'text-yellow-400'
                            : 'text-red-400';

      const capitalOpen   = openPositions.reduce((s, p) => s + (p.capitalUSD || 0), 0);
      const capitalClosed = closedPositions.reduce((s, p) => s + (p.capitalUSD || 0), 0);
      const grossPnL      = closedPositions.reduce((s, p) => s + (p.realizedPnL || 0), 0);
      const totalFees     = closedPositions.reduce((s, p) => s + (p.totalFeesUSD || ((p.entryFeeUSD || 0) + (p.exitFeeUSD || 0) + (p.apiCostUSD || 0))), 0);
      const netResult     = grossPnL - totalFees;
      const netResultPct  = capitalClosed > 0 ? (netResult / capitalClosed * 100) : 0;
      const netColor      = netResult >= 0 ? 'text-green-400' : 'text-red-400';
      const netBg         = netResult >= 0 ? 'bg-green-950/50 border border-green-800' : 'bg-red-950/50 border border-red-900';
      const fmt2          = v => isNaN(v) ? '0.00' : Math.abs(v) < 0.001 ? '0.0000' : Math.abs(v) < 0.01 ? parseFloat(v).toFixed(4) : parseFloat(v).toFixed(2);

      // DuraciÃ³n de la ronda
      const roundStartMs  = c.openedAt ? new Date(c.openedAt).getTime() : null;
      const durationMs    = roundStartMs ? Date.now() - roundStartMs : null;
      const durStr        = durationMs ? (durationMs >= 86400000
                              ? Math.floor(durationMs/86400000)+'d ' + Math.floor((durationMs%86400000)/3600000)+'h'
                              : durationMs >= 3600000
                                ? Math.floor(durationMs/3600000)+'h ' + Math.floor((durationMs%3600000)/60000)+'m'
                                : Math.floor(durationMs/60000)+'m') : 'â€”';

      activeDiv.innerHTML = `
        <div class="bg-indigo-950/50 border border-indigo-700 rounded-xl p-4 mb-4">

          <!-- Header -->
          <div class="flex items-center justify-between mb-4">
            <div>
              <p class="font-semibold text-indigo-300">ğŸ¯ Ronda #${c.roundNumber} â€” Activa</p>
              <p class="text-xs text-gray-400 mt-0.5">Iniciada ${since} Â· â± ${durStr} Â· Modo <span class="text-white font-medium">${c.config?.mode || 'â€”'}</span></p>
            </div>
            <button onclick="openCloseRoundModal()" class="bg-red-800 hover:bg-red-700 px-4 py-2 rounded-lg text-sm font-bold">ğŸ Cerrar Ronda</button>
          </div>

          <!-- Config: TP / SL / Capital / Fee / MaxHold -->
          <div class="grid grid-cols-5 gap-2 text-xs mb-4">
            <div class="bg-gray-900 rounded-lg p-2 text-center">
              <p class="text-gray-500">Take Profit</p>
              <p class="font-bold text-green-400">+${c.config?.takeProfitPct || 'â€”'}%</p>
            </div>
            <div class="bg-gray-900 rounded-lg p-2 text-center">
              <p class="text-gray-500">Stop Loss</p>
              <p class="font-bold text-red-400">-${c.config?.stopLossPct || 'â€”'}%</p>
            </div>
            <div class="bg-gray-900 rounded-lg p-2 text-center">
              <p class="text-gray-500">Capital</p>
              <p class="font-bold text-white">$${c.config?.capitalTotal || 'â€”'}</p>
            </div>
            <div class="bg-gray-900 rounded-lg p-2 text-center">
              <p class="text-gray-500">Fee est.</p>
              <p class="font-bold text-orange-400">${c.config?.feePct || 'â€”'}%</p>
            </div>
            <div class="bg-gray-900 rounded-lg p-2 text-center">
              <p class="text-gray-500">Max hold</p>
              <p class="font-bold text-white">${c.config?.maxHoldCycles || 'â€”'} ciclos</p>
            </div>
          </div>

          <!-- TÃ­tulo mÃ©tricas -->
          <div class="flex items-center gap-2 mb-3">
            <p class="text-xs font-semibold text-gray-400 uppercase tracking-wide">ğŸ“Š MÃ©tricas en vivo</p>
            <button onclick="loadInvestRounds()" class="text-gray-600 hover:text-gray-300 text-xs transition-colors">ğŸ”„</button>
          </div>

          <!-- Fila 1: Tasa acierto + posiciones abiertas + posiciones cerradas -->
          <div class="grid grid-cols-3 gap-2 text-xs mb-2">
            <div class="bg-gray-900 rounded-xl p-3 text-center">
              <p class="text-gray-500 mb-1">Tasa de Acierto</p>
              <p class="font-bold text-2xl ${winRateColor}">${winRate !== null ? winRate + '%' : 'â€”'}</p>
              <p class="text-gray-600 mt-0.5">${wins} âœ… Â· ${losses} âŒ de ${totalClosed}</p>
            </div>
            <div class="bg-gray-900 rounded-xl p-3 text-center">
              <p class="text-gray-500 mb-1">En Posiciones Abiertas</p>
              <p class="font-bold text-xl text-blue-400">${openPositions.length} pos.</p>
              <p class="text-blue-300/70 font-mono mt-0.5">$${fmt2(capitalOpen)}</p>
            </div>
            <div class="bg-gray-900 rounded-xl p-3 text-center">
              <p class="text-gray-500 mb-1">Posiciones Cerradas</p>
              <p class="font-bold text-xl text-gray-300">${totalClosed} pos.</p>
              <p class="text-gray-500 font-mono mt-0.5">$${fmt2(capitalClosed)} mov.</p>
            </div>
          </div>

          <!-- Fila 2: P&L bruto + fees + resultado neto -->
          <div class="grid grid-cols-3 gap-2 text-xs">
            <div class="bg-gray-900 rounded-xl p-3 text-center">
              <p class="text-gray-500 mb-1">P&L Bruto</p>
              <p class="font-bold text-base mono ${grossPnL >= 0 ? 'text-green-400' : 'text-red-400'}">${grossPnL >= 0 ? '+' : ''}$${fmt2(grossPnL)}</p>
              <p class="text-gray-600 mt-0.5">antes de fees</p>
            </div>
            <div class="bg-gray-900 rounded-xl p-3 text-center">
              <p class="text-gray-500 mb-1">Fees Gastados</p>
              <p class="font-bold text-base mono text-orange-400">-$${fmt2(totalFees)}</p>
              <p class="text-gray-600 mt-0.5">entrada + salida</p>
            </div>
            <div class="${netBg} rounded-xl p-3 text-center">
              <p class="text-gray-400 mb-1 font-semibold">Resultado Neto</p>
              <p class="font-bold text-base mono ${netColor}">${netResult >= 0 ? '+' : ''}$${fmt2(netResult)}</p>
              <p class="${netColor} opacity-80 font-mono mt-0.5">${netResultPct >= 0 ? '+' : ''}${netResultPct.toFixed(2)}%</p>
            </div>
          </div>

          ${openPositions.length > 0 ? `
          <p class="text-xs text-gray-600 text-center mt-2">âš¡ Las posiciones abiertas no se contabilizan en el P&L hasta cerrarse</p>
          ` : ''}
        </div>`;
    } else {
      activeDiv.innerHTML = `
        <div class="bg-gray-900 border border-gray-700 border-dashed rounded-xl p-4 mb-4 text-center">
          <p class="text-gray-500 mb-3">Sin ronda activa</p>
          <button onclick="openNewRoundWizard()" class="bg-indigo-700 hover:bg-indigo-600 px-5 py-2.5 rounded-lg text-sm font-bold">ğŸš€ Abrir Nueva Ronda de InversiÃ³n</button>
        </div>`;
    }

    // Historial
    if (!d.rounds || d.rounds.length === 0) {
      histDiv.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">Sin rondas cerradas aÃºn.</p>';
      return;
    }

    histDiv.innerHTML = `
      <p class="text-xs font-semibold text-gray-400 uppercase tracking-wide mb-3">Historial de Rondas Cerradas (${d.rounds.length})</p>
      <div class="space-y-3">
        ${d.rounds.map(rnd => _renderRoundCard(rnd)).join('')}
      </div>`;
  } catch(e) {
    histDiv.innerHTML = `<p class="text-red-400 text-sm">âŒ ${e.message}</p>`;
  }
}

function _renderRoundCard(rnd) {
  const rep = rnd.report || {};
  const net = rep.netReturnPct || 0;
  const netColor = net >= 0 ? 'text-green-400' : 'text-red-400';
  const borderColor = net >= 1.5 ? 'border-green-800' : net >= 0 ? 'border-gray-700' : 'border-red-900';
  const since = rnd.openedAt ? new Date(rnd.openedAt).toLocaleDateString('es-ES', {day:'2-digit', month:'short', year:'2-digit'}) : 'â€”';
  const dur = rep.durationHrs ? `${rep.durationHrs >= 24 ? Math.round(rep.durationHrs/24)+'d' : rep.durationHrs.toFixed(1)+'h'}` : 'â€”';
  return `
    <div class="bg-gray-900 border ${borderColor} rounded-xl p-4">
      <div class="flex items-center justify-between mb-3">
        <div>
          <span class="font-semibold">Ronda #${rnd.roundNumber}</span>
          <span class="text-xs text-gray-500 ml-2">${since} Â· ${dur}</span>
        </div>
        <div class="flex items-center gap-3">
          <span class="text-lg font-bold mono ${netColor}">${net >= 0?'+':''}${net.toFixed(2)}%</span>
          <button onclick="showRoundReport(${JSON.stringify(rnd).replace(/"/g,'&quot;')})" class="text-xs bg-gray-800 hover:bg-gray-700 px-3 py-1.5 rounded-lg">ğŸ“Š Informe</button>
        </div>
      </div>
      <div class="grid grid-cols-4 gap-2 text-xs">
        <div class="text-center"><p class="text-gray-500">Operaciones</p><p class="font-semibold">${rep.totalOperations || 0}</p></div>
        <div class="text-center"><p class="text-gray-500">Win Rate</p><p class="font-semibold ${rep.winRate >= 50 ? 'text-blue-400' : 'text-gray-300'}">${rep.winRate != null ? rep.winRate+'%' : 'â€”'}</p></div>
        <div class="text-center"><p class="text-gray-500">P&L Neto</p><p class="font-semibold mono ${netColor}">${rep.netReturnUSD >= 0 ? '+' : ''}$${(rep.netReturnUSD||0).toFixed(2)}</p></div>
        <div class="text-center"><p class="text-gray-500">Fees</p><p class="font-semibold text-orange-400">$${(rep.totalFeesUSD||0).toFixed(3)}</p></div>
      </div>
    </div>`;
}

// â”€â”€ Modal: Informe de Ronda â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showRoundReport(rnd) {
  document.getElementById('round-report-modal')?.remove();
  const rep = rnd.report || {};
  const net = rep.netReturnPct || 0;
  const netColor = net >= 0 ? 'text-green-400' : 'text-red-400';
  const since = rep.openedAt ? new Date(rep.openedAt).toLocaleString('es-ES') : 'â€”';
  const until = rep.closedAt ? new Date(rep.closedAt).toLocaleString('es-ES') : 'â€”';
  const dur   = rep.durationHrs ? `${rep.durationHrs >= 24 ? (rep.durationHrs/24).toFixed(1)+'d' : rep.durationHrs.toFixed(1)+'h'}` : 'â€”';

  const top5WinsHTML = (rep.top5Wins || []).map(p => `
    <div class="flex justify-between items-center bg-green-950/30 rounded-lg px-3 py-2 text-xs">
      <span class="font-semibold">${p.symbol}</span>
      <span class="text-gray-400">${p.closeReason || 'â€”'}</span>
      <span class="text-green-400 font-bold mono">+${(p.pnlPct||0).toFixed(2)}%</span>
      <span class="text-green-300 mono">+$${(p.pnlUSD||0).toFixed(2)}</span>
    </div>`).join('') || '<p class="text-gray-500 text-xs">â€”</p>';

  const top5LossesHTML = (rep.top5Losses || []).map(p => `
    <div class="flex justify-between items-center bg-red-950/30 rounded-lg px-3 py-2 text-xs">
      <span class="font-semibold">${p.symbol}</span>
      <span class="text-gray-400">${p.closeReason || 'â€”'}</span>
      <span class="text-red-400 font-bold mono">${(p.pnlPct||0).toFixed(2)}%</span>
      <span class="text-red-300 mono">$${(p.pnlUSD||0).toFixed(2)}</span>
    </div>`).join('') || '<p class="text-gray-500 text-xs">â€”</p>';

  const closeReasons = rep.closeReasonBreakdown || {};
  const crHTML = Object.entries(closeReasons).map(([k,v]) => `
    <div class="flex justify-between text-xs bg-gray-800 rounded px-2 py-1.5">
      <span class="text-gray-400">${k}</span><span class="font-semibold">${v}</span>
    </div>`).join('');

  const tc = rep.tradingConfig || {};
  const ac = rep.algoConfig   || {};

  const modal = document.createElement('div');
  modal.id = 'round-report-modal';
  modal.className = 'fixed inset-0 z-50 flex items-center justify-center p-4';
  modal.style.background = 'rgba(0,0,0,0.8)';
  modal.innerHTML = `
    <div class="cycle-modal-enter bg-gray-950 border border-gray-800 rounded-2xl w-full max-w-2xl max-h-[92vh] flex flex-col shadow-2xl">
      <!-- Header -->
      <div class="flex items-center justify-between p-4 border-b border-gray-800 shrink-0">
        <div>
          <h2 class="text-base font-bold">ğŸ“Š Informe â€” Ronda #${rnd.roundNumber}</h2>
          <p class="text-xs text-gray-500 mt-0.5">${since} â†’ ${until} Â· ${dur}</p>
        </div>
        <button onclick="document.getElementById('round-report-modal').remove()" class="text-gray-500 hover:text-white text-xl p-1">âœ•</button>
      </div>

      <div class="overflow-y-auto p-4 flex-1 space-y-5">

        <!-- KPIs principales -->
        <div class="grid grid-cols-4 gap-2">
          <div class="bg-gray-900 border border-gray-800 rounded-xl p-3 text-center">
            <p class="text-xs text-gray-500">Retorno Neto</p>
            <p class="text-2xl font-bold mono ${netColor}">${net >= 0?'+':''}${net.toFixed(2)}%</p>
            <p class="text-sm ${netColor} mono">${(rep.netReturnUSD||0) >= 0?'+':''}$${(rep.netReturnUSD||0).toFixed(2)}</p>
          </div>
          <div class="bg-gray-900 border border-gray-800 rounded-xl p-3 text-center">
            <p class="text-xs text-gray-500">Operaciones</p>
            <p class="text-2xl font-bold">${rep.totalOperations || 0}</p>
            <p class="text-xs text-gray-500">${rep.winsCount||0}W / ${rep.lossesCount||0}L</p>
          </div>
          <div class="bg-gray-900 border border-gray-800 rounded-xl p-3 text-center">
            <p class="text-xs text-gray-500">Win Rate</p>
            <p class="text-2xl font-bold text-blue-400">${rep.winRate != null ? rep.winRate+'%' : 'â€”'}</p>
            <p class="text-xs text-gray-500">de acierto</p>
          </div>
          <div class="bg-gray-900 border border-gray-800 rounded-xl p-3 text-center">
            <p class="text-xs text-gray-500">Total Fees</p>
            <p class="text-2xl font-bold text-orange-400">$${(rep.totalFeesUSD||0).toFixed(3)}</p>
            <p class="text-xs text-gray-500">comisiones</p>
          </div>
        </div>

        <!-- Desglose de fees -->
        <div class="bg-gray-900 border border-gray-800 rounded-xl p-3">
          <p class="text-xs font-semibold text-gray-400 uppercase tracking-wide mb-2">ğŸ’¸ Desglose de Comisiones</p>
          <div class="grid grid-cols-3 gap-2 text-xs">
            <div class="text-center"><p class="text-gray-500">Entrada</p><p class="font-semibold mono">$${(rep.feeBreakdown?.entryFees||0).toFixed(4)}</p></div>
            <div class="text-center"><p class="text-gray-500">Salida</p><p class="font-semibold mono">$${(rep.feeBreakdown?.exitFees||0).toFixed(4)}</p></div>
            <div class="text-center"><p class="text-gray-500">API</p><p class="font-semibold mono">$${(rep.feeBreakdown?.apiCosts||0).toFixed(4)}</p></div>
          </div>
        </div>

        <!-- Top 5 ganancias y pÃ©rdidas -->
        <div class="grid grid-cols-2 gap-3">
          <div>
            <p class="text-xs font-semibold text-green-400 mb-2">ğŸ† Top 5 Ganancias</p>
            <div class="space-y-1">${top5WinsHTML}</div>
          </div>
          <div>
            <p class="text-xs font-semibold text-red-400 mb-2">ğŸ“‰ Top 5 PÃ©rdidas</p>
            <div class="space-y-1">${top5LossesHTML}</div>
          </div>
        </div>

        <!-- Razones de cierre -->
        ${crHTML ? `<div class="bg-gray-900 border border-gray-800 rounded-xl p-3">
          <p class="text-xs font-semibold text-gray-400 uppercase tracking-wide mb-2">ğŸ”¢ Razones de Cierre</p>
          <div class="space-y-1">${crHTML}</div>
        </div>` : ''}

        <!-- Configuraciones usadas -->
        <div class="grid grid-cols-2 gap-3">
          <div class="bg-gray-900 border border-gray-800 rounded-xl p-3">
            <p class="text-xs font-semibold text-gray-400 uppercase tracking-wide mb-2">âš™ï¸ Config Compraventa</p>
            <div class="space-y-1 text-xs">
              <div class="flex justify-between"><span class="text-gray-500">Take Profit</span><span class="text-green-400 font-bold">+${tc.takeProfitPct||'â€”'}%</span></div>
              <div class="flex justify-between"><span class="text-gray-500">Stop Loss</span><span class="text-red-400 font-bold">-${tc.stopLossPct||'â€”'}%</span></div>
              <div class="flex justify-between"><span class="text-gray-500">Max Hold</span><span class="font-semibold">${tc.maxHoldCycles||'â€”'} ciclos</span></div>
              <div class="flex justify-between"><span class="text-gray-500">Capital total</span><span class="font-semibold mono">$${tc.capitalTotal||'â€”'}</span></div>
              <div class="flex justify-between"><span class="text-gray-500">Por ciclo</span><span class="font-semibold">${((tc.capitalPerCycle||0)*100).toFixed(0)}%</span></div>
              <div class="flex justify-between"><span class="text-gray-500">Modo</span><span class="font-semibold">${tc.mode||'â€”'}</span></div>
              <div class="flex justify-between"><span class="text-gray-500">Exchange</span><span class="font-semibold">${tc.exchange||'â€”'}</span></div>
            </div>
          </div>
          <div class="bg-gray-900 border border-gray-800 rounded-xl p-3">
            <p class="text-xs font-semibold text-gray-400 uppercase tracking-wide mb-2">ğŸ§  Config Algoritmo</p>
            <div class="space-y-1 text-xs">
              <div class="flex justify-between"><span class="text-gray-500">Min Boost</span><span class="font-semibold">${ac.invertibleMinBoost != null ? (ac.invertibleMinBoost*100).toFixed(0)+'%' : 'â€”'}</span></div>
              <div class="flex justify-between"><span class="text-gray-500">Target Invertible</span><span class="font-semibold">${ac.invertibleTarget != null ? ac.invertibleTarget+'%' : 'â€”'}</span></div>
              <div class="flex justify-between"><span class="text-gray-500">Meta potencial</span><span class="font-semibold">${ac.metaWeights?.potential != null ? (ac.metaWeights.potential*100).toFixed(0)+'%' : 'â€”'}</span></div>
              <div class="flex justify-between"><span class="text-gray-500">Meta resistencia</span><span class="font-semibold">${ac.metaWeights?.resistance != null ? (ac.metaWeights.resistance*100).toFixed(0)+'%' : 'â€”'}</span></div>
            </div>
          </div>
        </div>

        <!-- Contexto de mercado -->
        <div class="bg-gray-900 border border-gray-800 rounded-xl p-3">
          <p class="text-xs font-semibold text-gray-400 uppercase tracking-wide mb-2">ğŸŒ Contexto de Mercado</p>
          <div class="flex gap-4 text-xs">
            <span class="text-gray-500">Movimiento medio: <span class="font-bold ${(rep.marketContext?.avgMarketPnl||0) >= 0 ? 'text-green-400':'text-red-400'}">${(rep.marketContext?.avgMarketPnl||0) >= 0?'+':''}${(rep.marketContext?.avgMarketPnl||0).toFixed(2)}%</span></span>
            ${rep.marketContext?.bestSymbol  ? `<span class="text-gray-500">Mejor: <span class="text-green-400 font-bold">${rep.marketContext.bestSymbol}</span></span>` : ''}
            ${rep.marketContext?.worstSymbol ? `<span class="text-gray-500">Peor: <span class="text-red-400 font-bold">${rep.marketContext.worstSymbol}</span></span>` : ''}
          </div>
        </div>
      </div>

      <!-- Footer -->
      <div class="p-3 border-t border-gray-800 shrink-0 flex gap-2">
        <button onclick="document.getElementById('round-report-modal').remove()" class="flex-1 bg-gray-800 hover:bg-gray-700 px-4 py-2 rounded-lg text-sm font-semibold">Cerrar</button>
        <button onclick="document.getElementById('round-report-modal').remove(); openNewRoundWizard();" class="flex-1 bg-indigo-700 hover:bg-indigo-600 px-4 py-2 rounded-lg text-sm font-bold">ğŸš€ Nueva Ronda â†’</button>
      </div>
    </div>`;

  modal.addEventListener('click', e => { if (e.target === modal) modal.remove(); });
  document.body.appendChild(modal);
}

// â”€â”€ Modal: Confirmar cierre de ronda â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openCloseRoundModal() {
  document.getElementById('close-round-modal')?.remove();
  const modal = document.createElement('div');
  modal.id = 'close-round-modal';
  modal.className = 'fixed inset-0 z-50 flex items-center justify-center p-4';
  modal.style.background = 'rgba(0,0,0,0.8)';
  modal.innerHTML = `
    <div class="cycle-modal-enter bg-gray-950 border border-red-900 rounded-2xl w-full max-w-md shadow-2xl">
      <div class="p-5">
        <h2 class="text-base font-bold text-red-400 mb-1">ğŸ Cerrar Ronda de InversiÃ³n</h2>
        <p class="text-sm text-gray-400 mb-4">Se cerrarÃ¡n <strong class="text-white">todas las posiciones abiertas</strong> a precio de mercado actual y se generarÃ¡ el informe de la ronda.</p>
        <div class="bg-red-950/40 border border-red-900 rounded-lg p-3 mb-4 text-xs text-red-300">
          âš ï¸ Esta acciÃ³n no se puede deshacer. Las Ã³rdenes se ejecutarÃ¡n inmediatamente.
        </div>
        <div id="close-round-status" class="hidden text-sm text-gray-400 mb-3"></div>
        <div class="flex gap-2">
          <button onclick="document.getElementById('close-round-modal').remove()" class="flex-1 bg-gray-800 hover:bg-gray-700 px-4 py-2 rounded-lg text-sm font-semibold">Cancelar</button>
          <button id="btn-confirm-close-round" onclick="executeCloseRound()" class="flex-1 bg-red-700 hover:bg-red-600 px-4 py-2 rounded-lg text-sm font-bold">ğŸ Confirmar Cierre</button>
        </div>
      </div>
    </div>`;
  modal.addEventListener('click', e => { if (e.target === modal) modal.remove(); });
  document.body.appendChild(modal);
}

async function executeCloseRound() {
  const btn    = document.getElementById('btn-confirm-close-round');
  const status = document.getElementById('close-round-status');
  btn.disabled = true; btn.innerHTML = 'â³ Cerrando posiciones...';
  status.classList.remove('hidden'); status.textContent = 'Obteniendo precios actuales y ejecutando cierres...';
  try {
    const r = await fetch('/api/invest/rounds/close', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({}) });
    const d = await r.json();
    if (!d.success) { status.textContent = 'âŒ ' + d.error; btn.disabled = false; btn.innerHTML = 'ğŸ Confirmar Cierre'; return; }
    document.getElementById('close-round-modal').remove();
    // Recargar datos (capital ya actualizado en Redis)
    await loadInvestPositions();
    await loadInvestOverview();
    await loadInvestRounds();
    // Mostrar informe con capitalSnapshot
    showRoundReport({ roundNumber: d.report.roundNumber, report: d.report, id: d.report.roundId, capitalSnapshot: d.capitalSnapshot });
    await loadCurrentRoundBanner();
  } catch(e) {
    status.textContent = 'âŒ ' + e.message;
    btn.disabled = false; btn.innerHTML = 'ğŸ Confirmar Cierre';
  }
}

// â”€â”€ Wizard: Abrir nueva ronda â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function openNewRoundWizard() {
  document.getElementById('new-round-modal')?.remove();

  // Primero obtener recomendaciones
  let suggestions = {}, adjustments = [], currentConfig = {}, algoConfig = null, basedOnRounds = 0;
  try {
    const r = await fetch('/api/invest/rounds/recommendations', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({}) });
    const d = await r.json();
    if (d.success) { suggestions = d.suggestions; adjustments = d.reasonedAdjustments || []; currentConfig = d.currentConfig || {}; algoConfig = d.algoConfig; basedOnRounds = d.basedOnRounds || 0; }
  } catch(_) {}

  const s = { ...suggestions };
  const adjustmentsHTML = adjustments.length > 0
    ? `<div class="bg-amber-950/40 border border-amber-800 rounded-lg p-3 mb-3">
        <p class="text-xs font-semibold text-amber-400 mb-1.5">ğŸ’¡ Ajustes recomendados (basados en ${basedOnRounds} ronda${basedOnRounds!==1?'s':''})</p>
        ${adjustments.map(a => `<p class="text-xs text-gray-300 mb-1">â€¢ <span class="text-amber-300">${a.param}</span>: ${a.from} â†’ <span class="text-white font-bold">${a.to}</span> â€” ${a.reason}</p>`).join('')}
      </div>` : '';

  const algoHTML = algoConfig ? `
    <div class="bg-gray-900 border border-gray-800 rounded-lg p-3 mb-3">
      <p class="text-xs font-semibold text-gray-400 mb-1.5">ğŸ§  Algoritmo activo</p>
      <div class="flex gap-4 text-xs text-gray-400">
        <span>Min Boost: <span class="text-white">${algoConfig.invertibleMinBoost != null ? (algoConfig.invertibleMinBoost*100).toFixed(0)+'%' : 'â€”'}</span></span>
        <span>Target: <span class="text-white">${algoConfig.invertibleTarget != null ? algoConfig.invertibleTarget+'%' : 'â€”'}</span></span>
        <span>Potencial: <span class="text-white">${algoConfig.metaWeights?.potential != null ? (algoConfig.metaWeights.potential*100).toFixed(0)+'%' : 'â€”'}</span></span>
      </div>
    </div>` : '';

  const modal = document.createElement('div');
  modal.id = 'new-round-modal';
  modal.className = 'fixed inset-0 z-50 flex items-center justify-center p-4';
  modal.style.background = 'rgba(0,0,0,0.8)';
  modal.innerHTML = `
    <div class="cycle-modal-enter bg-gray-950 border border-indigo-900 rounded-2xl w-full max-w-lg max-h-[92vh] flex flex-col shadow-2xl">
      <div class="flex items-center justify-between p-4 border-b border-gray-800 shrink-0">
        <div>
          <h2 class="text-base font-bold text-indigo-300">ğŸš€ Nueva Ronda de InversiÃ³n</h2>
          <p class="text-xs text-gray-500 mt-0.5">Configura los parÃ¡metros para la siguiente ronda</p>
        </div>
        <button onclick="document.getElementById('new-round-modal').remove()" class="text-gray-500 hover:text-white text-xl p-1">âœ•</button>
      </div>

      <div class="overflow-y-auto p-4 flex-1">

        ${adjustmentsHTML}
        ${algoHTML}

        <!-- Formulario de config -->
        <div class="space-y-3">
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="text-xs text-gray-400 block mb-1">Capital Total (USD)</label>
              <input id="nr-capital" type="number" step="50" value="${s.capitalTotal || 1000}" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none">
            </div>
            <div>
              <label class="text-xs text-gray-400 block mb-1">Capital por Ciclo</label>
              <select id="nr-capital-pct" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none">
                ${[0.10,0.15,0.20,0.25,0.30,0.35,0.40,0.50].map(v => `<option value="${v}" ${Math.abs(v-(s.capitalPerCycle||0.3)) < 0.01 ? 'selected':''}>${(v*100).toFixed(0)}%</option>`).join('')}
              </select>
            </div>
          </div>

          <div class="grid grid-cols-3 gap-3">
            <div>
              <label class="text-xs text-gray-400 block mb-1">Take Profit %</label>
              <input id="nr-tp" type="number" step="0.5" min="1" max="50" value="${s.takeProfitPct || 10}" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none">
            </div>
            <div>
              <label class="text-xs text-gray-400 block mb-1">Stop Loss %</label>
              <input id="nr-sl" type="number" step="0.5" min="1" max="30" value="${s.stopLossPct || 5}" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none">
            </div>
            <div>
              <label class="text-xs text-gray-400 block mb-1">Max Hold Ciclos</label>
              <select id="nr-hold" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none">
                ${[1,2,3,4,5,6].map(v => `<option value="${v}" ${v === (s.maxHoldCycles||3) ? 'selected':''}>${v}</option>`).join('')}
              </select>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="text-xs text-gray-400 block mb-1">MÃ¡x posiciones</label>
              <select id="nr-maxpos" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none">
                ${[1,2,3,4,5].map(v => `<option value="${v}" ${v === (s.maxPositions||3) ? 'selected':''}>${v}</option>`).join('')}
              </select>
            </div>
            <div>
              <label class="text-xs text-gray-400 block mb-1">Min BoostPower</label>
              <select id="nr-boost" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none">
                ${[0.50,0.55,0.60,0.65,0.70,0.75,0.80,0.85].map(v => `<option value="${v}" ${Math.abs(v-(s.minBoostPower||0.65)) < 0.01 ? 'selected':''}>${(v*100).toFixed(0)}%</option>`).join('')}
              </select>
            </div>
          </div>

          <div class="grid grid-cols-1 gap-3">
            <div>
              <label class="text-xs text-gray-400 block mb-1">ğŸ“ˆ Subida mÃ­nima prevista <span class="text-gray-600">(filtra activos con predicciÃ³n baja; se priorizan los de mayor subida prevista)</span></label>
              <select id="nr-min-pred" class="w-full bg-gray-800 border border-indigo-900 rounded-lg px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none text-indigo-200">
                ${[0,1,2,3,5,7,10,15].map(v => `<option value="${v}" ${Math.abs(v-(s.minPredictedChange||0)) < 0.01 ? 'selected':''}>${v === 0 ? 'Sin filtro â€” cualquier subida prevista' : 'â‰¥ '+v+'%'}</option>`).join('')}
              </select>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="text-xs text-gray-400 block mb-1">Modo</label>
              <select id="nr-mode" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none">
                <option value="simulated" ${(s.mode||'simulated') === 'simulated' ? 'selected':''}>âš—ï¸ Simulado</option>
                <option value="real"      ${s.mode === 'real'      ? 'selected':''}>ğŸ’° Real</option>
              </select>
            </div>
            <div>
              <label class="text-xs text-gray-400 block mb-1">Exchange</label>
              <select id="nr-exchange" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none">
                <option value="binance"  ${(s.exchange||'binance') === 'binance'  ? 'selected':''}>Binance</option>
                <option value="coinbase" ${s.exchange === 'coinbase' ? 'selected':''}>Coinbase</option>
              </select>
            </div>
          </div>
        </div>

        <div id="nr-status" class="hidden mt-3 text-sm text-gray-400"></div>
      </div>

      <div class="p-3 border-t border-gray-800 shrink-0 flex gap-2">
        <button onclick="document.getElementById('new-round-modal').remove()" class="flex-1 bg-gray-800 hover:bg-gray-700 px-4 py-2 rounded-lg text-sm font-semibold">Cancelar</button>
        <button id="btn-open-round" onclick="submitNewRound()" class="flex-1 bg-indigo-700 hover:bg-indigo-600 px-4 py-2 rounded-lg text-sm font-bold">ğŸš€ Abrir Ronda</button>
      </div>
    </div>`;

  modal.addEventListener('click', e => { if (e.target === modal) modal.remove(); });
  document.body.appendChild(modal);
}

async function submitNewRound() {
  const btn    = document.getElementById('btn-open-round');
  const status = document.getElementById('nr-status');
  btn.disabled = true; btn.innerHTML = 'â³ Abriendo...';
  status.classList.remove('hidden'); status.textContent = 'Configurando nueva ronda...';
  try {
    const payload = {
      capitalTotal:       parseFloat(document.getElementById('nr-capital').value),
      capitalPerCycle:    parseFloat(document.getElementById('nr-capital-pct').value),
      takeProfitPct:      parseFloat(document.getElementById('nr-tp').value),
      stopLossPct:        parseFloat(document.getElementById('nr-sl').value),
      maxHoldCycles:      parseInt(document.getElementById('nr-hold').value),
      maxPositions:       parseInt(document.getElementById('nr-maxpos').value),
      minBoostPower:      parseFloat(document.getElementById('nr-boost').value),
      minPredictedChange: parseFloat(document.getElementById('nr-min-pred').value),
      mode:               document.getElementById('nr-mode').value,
      exchange:           document.getElementById('nr-exchange').value,
    };
    const r = await fetch('/api/invest/rounds/open', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
    const d = await r.json();
    if (!d.success) { status.textContent = 'âŒ ' + d.error; btn.disabled = false; btn.innerHTML = 'ğŸš€ Abrir Ronda'; return; }
    document.getElementById('new-round-modal').remove();
    await loadCurrentRoundBanner();
    await loadInvestPositions();
    await loadInvestOverview();
    if (typeof loadInvestRounds === 'function') loadInvestRounds();
    // Mostrar confirmaciÃ³n breve
    const toast = document.createElement('div');
    toast.className = 'fixed bottom-6 left-1/2 -translate-x-1/2 bg-indigo-800 border border-indigo-600 text-white px-5 py-3 rounded-xl shadow-2xl z-50 text-sm font-semibold cycle-modal-enter';
    toast.textContent = `âœ… Ronda #${d.round.roundNumber} abierta â€” Â¡A invertir!`;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3500);
  } catch(e) {
    status.textContent = 'âŒ ' + e.message;
    btn.disabled = false; btn.innerHTML = 'ğŸš€ Abrir Ronda';
  }
}

// â”€â”€ Cargar banner al entrar en Posiciones â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// â”€â”€ CalibraciÃ³n del modelo de predicciÃ³n â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadCalibrationStatus() {
  const div = document.getElementById('inv-calibration-content');
  div.innerHTML = '<p class="text-gray-500 text-xs">Cargando...</p>';
  try {
    const r = await fetch('/api/invest/prediction-calibration');
    const d = await r.json();
    if (!d.success) { div.innerHTML = `<p class="text-red-400 text-xs">âŒ ${d.error}</p>`; return; }
    const rep = d.report;
    if (rep.status === 'no_data') {
      div.innerHTML = '<p class="text-gray-500 text-xs">Sin datos aÃºn. La calibraciÃ³n se construirÃ¡ automÃ¡ticamente con cada posiciÃ³n cerrada.</p>';
      return;
    }
    const cats = rep.categories || {};
    const rows = Object.entries(cats).map(([cat, e]) => {
      const biasBadge = Math.abs(e.bias) > 5
        ? `<span class="pill ${e.bias > 0 ? 'bg-orange-900 text-orange-300' : 'bg-blue-900 text-blue-300'}">${e.bias > 0 ? 'â†“' : 'â†‘'} bias ${Math.abs(e.bias).toFixed(1)}%</span>`
        : '<span class="pill bg-green-900 text-green-300">âœ“ bias ok</span>';
      const qualityColor = e.quality === 'good' ? 'text-green-400' : e.quality === 'growing' ? 'text-yellow-400' : 'text-gray-500';
      return `
        <div class="bg-gray-800 rounded-lg p-3">
          <div class="flex justify-between items-center mb-2">
            <span class="text-xs font-semibold">${cat}</span>
            <div class="flex gap-1.5 items-center">
              ${biasBadge}
              <span class="text-xs ${qualityColor}">${e.samples} muestras</span>
            </div>
          </div>
          ${e.hasEnough ? `
            <div class="grid grid-cols-3 gap-2 text-xs mb-2">
              <div class="text-center"><p class="text-gray-500">Bias</p><p class="font-bold ${Math.abs(e.bias) > 5 ? 'text-orange-400' : 'text-gray-300'}">${e.bias > 0 ? '+' : ''}${e.bias.toFixed(1)}%</p></div>
              <div class="text-center"><p class="text-gray-500">Scale</p><p class="font-bold ${e.scale < 0.6 ? 'text-red-400' : e.scale > 1.4 ? 'text-blue-400' : 'text-gray-300'}">Ã—${e.scale.toFixed(2)}</p></div>
              <div class="text-center"><p class="text-gray-500">MAE</p><p class="font-bold ${e.maeEMA > 15 ? 'text-red-400' : 'text-gray-300'}">${e.maeEMA.toFixed(1)}%</p></div>
            </div>
            <p class="text-xs text-gray-500 italic">${e.diagnosis}</p>` : `
            <p class="text-gray-600 text-xs">Necesita ${3 - e.samples} operaciones mÃ¡s para calibrarse</p>`}
          ${e.recentHistory && e.recentHistory.length > 0 ? `
            <details class="mt-2">
              <summary class="text-xs text-gray-500 cursor-pointer hover:text-gray-300">Ãšltimas ${e.recentHistory.length} observaciones</summary>
              <div class="mt-1.5 space-y-1">
                ${e.recentHistory.map(h => `
                  <div class="flex justify-between text-xs bg-gray-900 rounded px-2 py-1">
                    <span class="text-gray-400">${h.symbol}</span>
                    <span class="text-blue-400">pred: +${h.predicted}%</span>
                    <span class="${h.actual >= 0 ? 'text-green-400' : 'text-red-400'}">real: ${h.actual >= 0 ? '+' : ''}${h.actual}%</span>
                    <span class="${Math.abs(h.error) < 5 ? 'text-gray-500' : 'text-orange-400'}">err: ${h.error > 0 ? '+' : ''}${h.error}%</span>
                  </div>`).join('')}
              </div>
            </details>` : ''}
        </div>`;
    });

    const updatedAt = rep.updatedAt ? new Date(rep.updatedAt).toLocaleString('es-ES') : 'Nunca';
    div.innerHTML = `
      <div class="grid grid-cols-2 gap-3 mb-3">${rows.join('')}</div>
      <p class="text-xs text-gray-600">Ãšltima actualizaciÃ³n: ${updatedAt}</p>`;
  } catch(e) {
    div.innerHTML = `<p class="text-red-400 text-xs">âŒ ${e.message}</p>`;
  }
}

async function rebuildCalibration() {
  const div = document.getElementById('inv-calibration-content');
  div.innerHTML = '<p class="text-gray-500 text-xs">â³ Recalibrando desde historial de posiciones...</p>';
  try {
    const r = await fetch('/api/invest/prediction-calibration/rebuild', { method: 'POST' });
    const d = await r.json();
    if (!d.success) { div.innerHTML = `<p class="text-red-400 text-xs">âŒ ${d.error}</p>`; return; }
    await loadCalibrationStatus();
  } catch(e) { div.innerHTML = `<p class="text-red-400 text-xs">âŒ ${e.message}</p>`; }
}

// â”€â”€ Rendimiento â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadInvestPerformance() {
  const div = document.getElementById('inv-perf-content');
  try {
    const r = await fetch('/api/invest/performance');
    const d = await r.json();
    if (!d.success) { div.innerHTML=`<p class="text-red-400 text-sm">âŒ ${d.error}</p>`; return; }
    const p = d.performance, cap = d.capital;
    const netColor = p.netReturnPct >= 0 ? 'text-green-400' : 'text-red-400';
    div.innerHTML = `
      <div class="grid grid-cols-3 gap-3 mb-5">
        <div class="bg-gray-900 border border-gray-800 rounded-xl p-4 text-center">
          <p class="text-xs text-gray-500">Retorno Neto Total</p>
          <p class="text-2xl font-bold ${netColor} mono">${p.netReturnPct>=0?'+':''}${p.netReturnPct}%</p>
          <p class="text-sm ${netColor} mono">${p.netReturnUSD>=0?'+':''}$${p.netReturnUSD}</p>
        </div>
        <div class="bg-gray-900 border border-gray-800 rounded-xl p-4 text-center">
          <p class="text-xs text-gray-500">Win Rate</p>
          <p class="text-2xl font-bold text-blue-400 mono">${p.winRate??'â€”'}%</p>
          <p class="text-xs text-gray-500">${p.totalOperations} operaciones</p>
        </div>
        <div class="bg-gray-900 border border-gray-800 rounded-xl p-4 text-center">
          <p class="text-xs text-gray-500">Capital Libre</p>
          <p class="text-2xl font-bold text-white mono">$${cap.available.toFixed(2)}</p>
          <p class="text-xs text-gray-500">de $${cap.total}</p>
        </div>
      </div>
      <div class="grid grid-cols-2 gap-3 mb-5">
        <div class="bg-gray-900 border border-gray-800 rounded-xl p-4">
          <p class="text-xs font-semibold text-green-400 mb-2">Ganancia promedio</p>
          <p class="text-xl font-bold text-green-400 mono">+${p.avgWinPct??'â€”'}%</p>
        </div>
        <div class="bg-gray-900 border border-gray-800 rounded-xl p-4">
          <p class="text-xs font-semibold text-red-400 mb-2">PÃ©rdida promedio</p>
          <p class="text-xl font-bold text-red-400 mono">${p.avgLossPct??'â€”'}%</p>
        </div>
        <div class="bg-gray-900 border border-gray-800 rounded-xl p-4">
          <p class="text-xs font-semibold text-yellow-400 mb-2">Fees totales</p>
          <p class="text-xl font-bold text-yellow-400 mono">$${p.totalFeesUSD}</p>
        </div>
        <div class="bg-gray-900 border border-gray-800 rounded-xl p-4">
          <p class="text-xs font-semibold text-red-400 mb-2">Predicciones malas</p>
          <p class="text-xl font-bold text-red-400 mono">${p.badPredictions} <span class="text-sm text-gray-400">(${p.badPredictionRate}%)</span></p>
        </div>
      </div>
      <div class="bg-gray-900 border border-gray-800 rounded-xl p-4">
        <p class="text-xs font-semibold mb-3">Razones de cierre</p>
        <div class="flex flex-wrap gap-2">${Object.entries(p.closeReasons||{}).map(([r,n])=>`<span class="pill bg-gray-800 text-gray-300">${r}: ${n}</span>`).join('')}</div>
      </div>`;
  } catch(e) { div.innerHTML=`<p class="text-red-400 text-sm">âŒ ${e.message}</p>`; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOG VERBOSO v2 â€” cards expandibles, filtros, export, Sabios
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let investLogData     = [];
let investLogFilter   = 'all';
let investLogExpanded = new Set();

async function loadInvestLog() {
  const div = document.getElementById('inv-log-content');
  div.innerHTML = '<p class="text-gray-500 text-sm animate-pulse">Cargando log...</p>';
  try {
    const r = await fetch('/api/invest/log');
    const d = await r.json();
    if (!d.success) { div.innerHTML = `<p class="text-red-400 text-sm">âŒ ${d.error}</p>`; return; }
    investLogData = d.log || [];
    renderInvestLog();
  } catch(e) { div.innerHTML = `<p class="text-red-400 text-sm">âŒ ${e.message}</p>`; }
}

function renderInvestLog() {
  const div = document.getElementById('inv-log-content');
  const filtered = investLogFilter === 'all' ? investLogData : investLogData.filter(e => e.type === investLogFilter);
  if (!filtered.length) { div.innerHTML = '<p class="text-gray-500 text-sm">Sin entradas para el filtro seleccionado.</p>'; return; }
  div.innerHTML = filtered.map((entry, idx) => buildLogCard(entry, idx)).join('');
}

function buildLogCard(entry, idx) {
  const id   = entry._logId || `log-${idx}`;
  const isEx = investLogExpanded.has(id);
  const TYPE_META = {
    invest:         { icon:'ğŸ’°', color:'green',  label:'INVERSIÃ“N EJECUTADA' },
    evaluate:       { icon:'âš–ï¸', color:'blue',   label:'EVALUACIÃ“N DE CICLO' },
    no_invest:      { icon:'â¸ï¸', color:'yellow', label:'SIN INVERSIÃ“N' },
    manual_close:   { icon:'ğŸ”’', color:'orange', label:'CIERRE MANUAL' },
    watchdog_close: { icon:'ğŸ””', color:'purple', label:'WATCHDOG CIERRE' },
    watchdog_scan:  { icon:'ğŸ”', color:'gray',   label:'WATCHDOG SCAN' },
  };
  const meta = TYPE_META[entry.type] || { icon:'ğŸ“‹', color:'gray', label:(entry.type||'EVENTO').toUpperCase() };
  const col  = meta.color;

  let summaryLine = '';
  if (entry.type === 'invest') {
    const exec = entry.execution || {};
    summaryLine = `${exec.positionsOpened||entry.positionsOpened||0} posiciones Â· $${(exec.totalInvestedUSD||entry.totalInvested||0).toFixed(2)} desplegados`;
    if (exec.totalFeesEstUSD) summaryLine += ` Â· fees est. $${exec.totalFeesEstUSD.toFixed(4)}`;
  } else if (entry.type === 'evaluate') {
    const sum = entry.summary || {};
    const pct = sum.netReturnPct ?? entry.netReturnPct ?? 0;
    summaryLine = `${sum.evaluated||entry.evaluations||0} evaluadas Â· ${sum.sells||entry.sells||0} ventas Â· ${sum.holds||entry.holds||0} mantenidas`;
    if (pct !== undefined) summaryLine += ` Â· <span class="${pct>=0?'text-green-400':'text-red-400'} font-bold">${pct>=0?'+':''}${pct}%</span>`;
  } else if (entry.type === 'no_invest') {
    const dec = entry.decision || {};
    summaryLine = dec.reason || entry.reason || 'â€”';
    if (dec.candidatesFound !== undefined) summaryLine += ` (${dec.candidatesFound} candidatos, mÃ­n. ${dec.minSignalsRequired})`;
  } else if (entry.type === 'manual_close') {
    const res = entry.result || {}; const pos = entry.position || {};
    summaryLine = `${pos.symbol||'â€”'} Â· <span class="${(res.pnlPct||0)>=0?'text-green-400':'text-red-400'} font-bold">${(res.pnlPct||0)>=0?'+':''}${(res.pnlPct||0).toFixed(2)}%</span> ($${(res.pnlUSD||0).toFixed(4)})`;
  } else if (entry.type === 'watchdog_close') {
    const pos  = entry.position  || {};
    const pred = entry.prediction || {};
    const hold = entry.holdInfo  || {};
    const isSL = (entry.subtype || entry.trigger || '').includes('stop');
    const trigger = isSL ? 'ğŸ”´ Stop Loss' : 'ğŸŸ¢ Take Profit';
    const pnlPct = pos.pnlPct ?? 0;
    const pnlColor = pnlPct >= 0 ? 'text-green-400' : 'text-red-400';
    const devPct = pred.deviationPct ?? null;
    const devBadge = devPct !== null
      ? ` Â· dev: <span class="${Math.abs(devPct) > 5 ? 'text-yellow-400' : 'text-gray-400'}">${devPct >= 0 ? '+' : ''}${devPct.toFixed(2)}%</span>`
      : '';
    const holdStr = hold.holdDurationHrs != null
      ? ` Â· â± ${hold.holdDurationHrs >= 24 ? (hold.holdDurationHrs/24).toFixed(1)+'d' : hold.holdDurationHrs.toFixed(1)+'h'}`
      : '';
    const originBadge = entry.origin === 'server_watchdog' ? ' Â· ğŸ–¥ï¸' : ' Â· ğŸ’»';
    summaryLine = `${trigger} Â· <b class="text-white">${pos.symbol||'â€”'}</b> Â· <span class="${pnlColor} font-bold">${pnlPct>=0?'+':''}${pnlPct.toFixed(2)}%</span> Â· net: <span class="${(pos.netPnL||0)>=0?'text-green-300':'text-red-300'}">${(pos.netPnL||0)>=0?'+':''}$${(pos.netPnL||0).toFixed(4)}</span>${devBadge}${holdStr}${originBadge}`;
  } else if (entry.type === 'watchdog_scan') {
    const s = entry.summary || {};
    const pnlColor = (s.scanPnlUSD || 0) >= 0 ? 'text-green-400' : 'text-red-400';
    const sellBadge = s.sells > 0
      ? `<span class="text-green-400 font-bold">ğŸ”” ${s.sells} venta${s.sells > 1 ? 's' : ''}</span> Â· `
      : '<span class="text-gray-500">sin ventas</span> Â· ';
    const pnlBadge = s.sells > 0 && s.scanPnlUSD !== undefined
      ? `<span class="${pnlColor} font-bold">${s.scanPnlUSD >= 0 ? '+' : ''}$${s.scanPnlUSD.toFixed(4)}</span> Â· `
      : '';
    const originLabel = entry.trigger === 'external_ping' ? 'ğŸŒ srv' : entry.trigger === 'frontend_timer' ? 'ğŸ’» cli' : (entry.trigger || 'â€”');
    summaryLine = `${sellBadge}${pnlBadge}${s.checked||0} revisadas Â· ${s.holds||0} hold Â· ${s.priceSource||'â€”'} Â· ${originLabel}`;
    if (s.staleCount) summaryLine += ` Â· <span class="text-yellow-400">âš  ${s.staleCount} stale</span>`;
    if (s.errors)     summaryLine += ` Â· <span class="text-red-400">âŒ ${s.errors} err</span>`;
  }

  const modeBadge = entry.config?.mode ? `<span class="pill text-xs ${entry.config.mode==='real'?'bg-red-900 text-red-300':'bg-gray-800 text-gray-400'}">${entry.config.mode}</span>` : '';
  const exchBadge = entry.config?.exchange ? `<span class="pill text-xs bg-gray-800 text-gray-400">${entry.config.exchange}</span>` : '';
  const expandedBlock = isEx ? `<div class="border-t border-gray-800 p-3 bg-gray-950">${buildExpandedDetails(entry)}</div>` : '';

  return `<div class="bg-gray-900 rounded-xl mb-2 border border-${col}-900 overflow-hidden">
    <div class="flex items-start justify-between p-3 cursor-pointer hover:bg-gray-800/50 transition-colors" onclick="toggleLogCard('${id}')">
      <div class="flex items-start gap-2 flex-1 min-w-0">
        <span class="text-lg flex-shrink-0 mt-0.5">${meta.icon}</span>
        <div class="min-w-0">
          <div class="flex flex-wrap items-center gap-1.5 mb-0.5">
            <span class="text-xs font-bold text-${col}-400">${meta.label}</span>
            ${modeBadge}${exchBadge}
            ${entry.cycleId ? `<span class="pill text-xs bg-gray-800 text-gray-500">ciclo: ${(entry.cycleId||'').slice(0,12)}</span>` : ''}
          </div>
          <p class="text-sm text-gray-300">${summaryLine}</p>
        </div>
      </div>
      <div class="flex-shrink-0 ml-2 text-right">
        <p class="text-xs text-gray-500">${timeAgo(entry.timestamp)}</p>
        <p class="text-xs text-gray-600">${new Date(entry.timestamp).toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'})}</p>
        <span class="text-gray-600 text-xs">${isEx?'â–²':'â–¼'}</span>
      </div>
    </div>
    ${expandedBlock}
  </div>`;
}

function buildExpandedDetails(entry) {
  if (entry.type === 'invest')         return buildInvestDetails(entry);
  if (entry.type === 'evaluate')       return buildEvaluateDetails(entry);
  if (entry.type === 'no_invest')      return buildNoInvestDetails(entry);
  if (entry.type === 'manual_close')   return buildManualCloseDetails(entry);
  if (entry.type === 'watchdog_close') return buildWatchdogDetails(entry);
  if (entry.type === 'watchdog_scan')  return buildWatchdogScanDetails(entry);
  return `<pre class="text-xs text-gray-400 overflow-x-auto">${JSON.stringify(entry,null,2)}</pre>`;
}

function buildWatchdogDetails(e) {
  const pos  = e.position   || {};
  const cfg  = e.config     || {};
  const hold = e.holdInfo   || {};
  const pred = e.prediction || {};
  const lvl  = e.levels     || {};
  const isSL = (e.subtype || e.trigger || '').includes('stop') || (e.reason || '').includes('stop');
  const triggerLabel = isSL ? 'ğŸ”´ Stop Loss activado' : 'ğŸŸ¢ Take Profit activado';
  const pnlPct  = pos.pnlPct  ?? 0;
  const pnlUSD  = pos.pnlUSD  ?? 0;
  const netPnL  = pos.netPnL  ?? 0;
  const pnlColor = pnlPct >= 0 ? 'text-green-400' : 'text-red-400';

  const predDev   = pred.deviationPct ?? null;
  const devColor  = predDev !== null && Math.abs(predDev) > 5 ? 'text-yellow-400' : 'text-gray-400';
  const predSign  = (pred.predictedChangePct || 0) >= 0 ? '+' : '';
  const actualSign= pnlPct >= 0 ? '+' : '';
  const devSign   = (predDev || 0) >= 0 ? '+' : '';

  const holdHrs = hold.holdDurationHrs;
  const holdStr = holdHrs != null
    ? holdHrs >= 24 ? `${(holdHrs/24).toFixed(1)}d (${holdHrs.toFixed(1)}h)` : `${holdHrs.toFixed(1)}h`
    : 'â€”';

  const originLabel = e.origin === 'server_watchdog' ? 'ğŸ–¥ï¸ Servidor' : 'ğŸ’» Frontend';

  return `
  <div class="space-y-2">
    <!-- Cabecera trigger -->
    <div class="bg-${isSL ? 'red' : 'green'}-950 border border-${isSL ? 'red' : 'green'}-800 rounded-lg p-3 flex items-center justify-between">
      <div>
        <p class="text-${isSL ? 'red' : 'green'}-300 font-bold text-sm">${triggerLabel}</p>
        <p class="text-xs text-gray-400 mt-0.5">${e.reason || 'â€”'}</p>
      </div>
      <span class="${pnlColor} font-bold text-2xl mono">${pnlPct >= 0 ? '+' : ''}${pnlPct.toFixed(2)}%</span>
    </div>

    <!-- Fila 1: Resultado econÃ³mico -->
    <div class="grid grid-cols-4 gap-2 text-xs">
      <div class="bg-gray-900 rounded-lg p-2 text-center">
        <p class="text-gray-500 mb-1">PnL bruto</p>
        <p class="${pnlColor} font-bold mono">${pnlPct >= 0 ? '+' : ''}${pnlPct.toFixed(2)}%</p>
        <p class="${pnlColor} mono text-xs">${pnlUSD >= 0 ? '+' : ''}$${pnlUSD.toFixed(4)}</p>
      </div>
      <div class="bg-gray-900 rounded-lg p-2 text-center">
        <p class="text-gray-500 mb-1">Net PnL</p>
        <p class="${netPnL >= 0 ? 'text-green-400' : 'text-red-400'} font-bold mono">${netPnL >= 0 ? '+' : ''}$${netPnL.toFixed(4)}</p>
        <p class="text-gray-600 text-xs">fees: $${(pos.exitFeeUSD || 0).toFixed(4)}</p>
      </div>
      <div class="bg-gray-900 rounded-lg p-2 text-center">
        <p class="text-gray-500 mb-1">Capital</p>
        <p class="text-white font-bold mono">$${(pos.capitalUSD ?? 0).toFixed(2)}</p>
        <p class="text-gray-500 text-xs">${(pos.units ?? 0).toFixed(6)} u.</p>
      </div>
      <div class="bg-gray-900 rounded-lg p-2 text-center">
        <p class="text-gray-500 mb-1">â± Hold</p>
        <p class="text-yellow-300 font-bold">${holdStr}</p>
        <p class="text-gray-600 text-xs">${hold.holdCycles || 0} ciclos</p>
      </div>
    </div>

    <!-- Fila 2: PredicciÃ³n vs Realidad -->
    <div class="grid grid-cols-2 gap-2 text-xs">
      <div class="bg-gray-900 rounded-lg p-2.5">
        <p class="text-gray-500 font-semibold mb-2 uppercase tracking-wide">ğŸ¯ PredicciÃ³n vs Real</p>
        <div class="space-y-1">
          <div class="flex justify-between">
            <span class="text-gray-500">Predicho:</span>
            <span class="text-blue-400 mono">${predSign}${(pred.predictedChangePct || 0).toFixed(2)}%</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-500">Real:</span>
            <span class="${pnlColor} mono font-bold">${actualSign}${pnlPct.toFixed(2)}%</span>
          </div>
          <div class="flex justify-between border-t border-gray-800 pt-1 mt-1">
            <span class="text-gray-500">DesviaciÃ³n:</span>
            <span class="${devColor} mono font-bold">${devSign}${(predDev ?? 0).toFixed(2)}%</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-500">DirecciÃ³n:</span>
            <span class="${pred.correct === true ? 'text-green-400' : pred.correct === false ? 'text-red-400' : 'text-gray-500'}">
              ${pred.correct === true ? 'âœ… AcertÃ³' : pred.correct === false ? 'âŒ FallÃ³' : 'â€”'}
            </span>
          </div>
          ${pred.boostPower != null ? `<div class="flex justify-between"><span class="text-gray-500">BoostPower:</span><span class="text-purple-400 mono">${pred.boostPower.toFixed(3)}</span></div>` : ''}
        </div>
      </div>

      <div class="bg-gray-900 rounded-lg p-2.5">
        <p class="text-gray-500 font-semibold mb-2 uppercase tracking-wide">ğŸ“ Niveles de precio</p>
        <div class="space-y-1">
          <div class="flex justify-between"><span class="text-gray-500">Entrada:</span><span class="text-gray-300 mono">$${fmtP(pos.entryPrice)}</span></div>
          <div class="flex justify-between"><span class="text-gray-500">Salida:</span><span class="text-white mono font-bold">$${fmtP(pos.exitPrice)}</span></div>
          <div class="flex justify-between"><span class="text-gray-500">TP fijado:</span><span class="text-green-400 mono">$${fmtP(pos.takeProfitPrice)} <span class="text-gray-600">(${(lvl.tpPct||0).toFixed(1)}%)</span></span></div>
          <div class="flex justify-between"><span class="text-gray-500">SL fijado:</span><span class="text-red-400 mono">$${fmtP(pos.stopLossPrice)} <span class="text-gray-600">(${(lvl.slPct||0).toFixed(1)}%)</span></span></div>
          ${lvl.distToTP != null ? `<div class="flex justify-between border-t border-gray-800 pt-1"><span class="text-gray-500">Î” vs TP:</span><span class="${lvl.distToTP >= 0 ? 'text-green-300' : 'text-yellow-400'} mono">${lvl.distToTP >= 0 ? '+' : ''}${lvl.distToTP.toFixed(2)}%</span></div>` : ''}
        </div>
      </div>
    </div>

    <!-- Fila 3: Timestamps + ejecuciÃ³n -->
    <div class="bg-gray-900 rounded-lg p-2.5 text-xs">
      <div class="grid grid-cols-4 gap-x-4 gap-y-1">
        <div><span class="text-gray-500">Abierta: </span><span class="text-gray-300">${hold.openedAt ? new Date(hold.openedAt).toLocaleString('es-ES',{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'}) : 'â€”'}</span></div>
        <div><span class="text-gray-500">Cerrada: </span><span class="text-gray-300">${hold.closedAt ? new Date(hold.closedAt).toLocaleString('es-ES',{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'}) : 'â€”'}</span></div>
        <div><span class="text-gray-500">Fuente precio: </span><span class="text-gray-400">${pos.priceSource || 'â€”'}</span></div>
        <div><span class="text-gray-500">Origen WD: </span><span class="text-gray-400">${originLabel}</span></div>
      </div>
    </div>

    <!-- Config -->
    <details>
      <summary class="text-xs text-gray-600 cursor-pointer hover:text-gray-400">âš™ Config activa en el cierre</summary>
      <div class="flex flex-wrap gap-1.5 mt-1.5">
        ${cfg.takeProfitPct !== undefined ? `<span class="pill text-xs bg-green-900/50 text-green-400">TP ${cfg.takeProfitPct}%</span>` : ''}
        ${cfg.stopLossPct   !== undefined ? `<span class="pill text-xs bg-red-900/50 text-red-400">SL ${cfg.stopLossPct}%</span>` : ''}
        ${cfg.mode     ? `<span class="pill text-xs bg-gray-800 text-gray-400">${cfg.mode}</span>` : ''}
        ${cfg.exchange ? `<span class="pill text-xs bg-gray-800 text-gray-400">${cfg.exchange}</span>` : ''}
      </div>
    </details>
  </div>`;
}

function buildWatchdogScanDetails(e) {
  const s    = e.summary      || {};
  const snap = e.holdSnapshot || [];
  const pnlColor = (s.scanPnlUSD || 0) >= 0 ? 'text-green-400' : 'text-red-400';
  const originLabel = e.trigger === 'external_ping' ? 'ğŸŒ Pinger externo'
                    : e.trigger === 'frontend_timer' ? 'ğŸ’» Frontend timer'
                    : e.trigger === 'local_interval' ? 'ğŸ–¥ï¸ Servidor local'
                    : e.trigger === 'local_startup'  ? 'ğŸ–¥ï¸ Servidor arranque'
                    : (e.trigger || 'â€”');

  const snapRows = snap.map(p => {
    const devColor = Math.abs(p.deviationPct || 0) > 5 ? 'text-yellow-400' : 'text-gray-400';
    const pnlC     = (p.pnlPct || 0) >= 0 ? 'text-green-400' : 'text-red-400';
    const tpDist   = p.distToTP != null ? `<span class="${p.distToTP > 5 ? 'text-green-300' : p.distToTP < 2 ? 'text-yellow-400' : 'text-gray-400'}">TP: ${p.distToTP > 0 ? '+' : ''}${p.distToTP.toFixed(1)}%</span>` : '<span class="text-gray-600">â€”</span>';
    const slDist   = p.distToSL != null ? `<span class="${p.distToSL > 5 ? 'text-gray-400' : 'text-red-400'}">SL: +${p.distToSL.toFixed(1)}%</span>` : '<span class="text-gray-600">â€”</span>';
    const stale    = p.isStale ? ' <span class="text-yellow-500 text-xs">âš </span>' : '';
    return `<tr class="border-t border-gray-800 hover:bg-gray-900/50 transition-colors">
      <td class="py-1 px-2 font-mono text-white text-xs">${p.symbol}${stale}</td>
      <td class="py-1 px-2 text-center ${pnlC} font-mono text-xs">${(p.pnlPct||0) >= 0 ? '+' : ''}${(p.pnlPct||0).toFixed(2)}%</td>
      <td class="py-1 px-2 text-center text-blue-400 font-mono text-xs">${(p.predictedPct||0) >= 0 ? '+' : ''}${(p.predictedPct||0).toFixed(2)}%</td>
      <td class="py-1 px-2 text-center ${devColor} font-mono text-xs">${(p.deviationPct||0) >= 0 ? '+' : ''}${(p.deviationPct||0).toFixed(2)}%</td>
      <td class="py-1 px-2 text-center text-xs space-x-1">${tpDist} ${slDist}</td>
      <td class="py-1 px-2 text-center text-gray-400 text-xs">${p.holdDurationHrs != null ? (p.holdDurationHrs >= 24 ? (p.holdDurationHrs/24).toFixed(1)+'d' : p.holdDurationHrs.toFixed(1)+'h') : 'â€”'}</td>
      <td class="py-1 px-2 text-center text-purple-400 text-xs">${p.boostPower != null ? p.boostPower.toFixed(3) : 'â€”'}</td>
    </tr>`;
  }).join('');

  return `
  <div class="space-y-3">
    <!-- KPIs del scan -->
    <div class="grid grid-cols-5 gap-2 text-xs">
      <div class="bg-gray-900 rounded-lg p-2 text-center">
        <p class="text-gray-500">Revisadas</p>
        <p class="text-white font-bold text-lg">${s.checked || 0}</p>
      </div>
      <div class="bg-gray-900 rounded-lg p-2 text-center">
        <p class="text-gray-500">Ventas</p>
        <p class="${s.sells > 0 ? 'text-green-400' : 'text-gray-500'} font-bold text-lg">${s.sells || 0}</p>
      </div>
      <div class="bg-gray-900 rounded-lg p-2 text-center">
        <p class="text-gray-500">Hold</p>
        <p class="text-gray-300 font-bold text-lg">${s.holds || 0}</p>
      </div>
      <div class="bg-gray-900 rounded-lg p-2 text-center">
        <p class="text-gray-500">PnL scan</p>
        <p class="${pnlColor} font-bold mono">${(s.scanPnlUSD || 0) >= 0 ? '+' : ''}$${(s.scanPnlUSD || 0).toFixed(4)}</p>
        <p class="text-gray-600 text-xs">net: ${(s.scanNetPnL||0) >= 0 ? '+' : ''}$${(s.scanNetPnL||0).toFixed(4)}</p>
      </div>
      <div class="bg-gray-900 rounded-lg p-2 text-center">
        <p class="text-gray-500">Fuente</p>
        <p class="text-gray-400 text-xs">${s.priceSource || 'â€”'}</p>
        ${s.staleCount ? `<p class="text-yellow-400 text-xs">âš  ${s.staleCount} stale</p>` : ''}
        ${s.errors ? `<p class="text-red-400 text-xs">âŒ ${s.errors} err</p>` : ''}
      </div>
    </div>
    <div class="text-xs text-gray-500">
      âš¡ Origen del trigger: <span class="text-gray-300">${originLabel}</span>
    </div>

    <!-- Tabla de posiciones en hold -->
    ${snap.length > 0 ? `
    <div>
      <p class="text-xs text-gray-400 font-semibold uppercase tracking-wide mb-2">ğŸ“‹ Posiciones en hold durante este scan</p>
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead>
            <tr class="text-gray-600 text-xs text-left border-b border-gray-800">
              <th class="py-1 px-2">SÃ­mbolo</th>
              <th class="py-1 px-2 text-center">PnL actual</th>
              <th class="py-1 px-2 text-center">Predicho</th>
              <th class="py-1 px-2 text-center">DesviaciÃ³n</th>
              <th class="py-1 px-2 text-center">Dist TP / SL</th>
              <th class="py-1 px-2 text-center">Hold</th>
              <th class="py-1 px-2 text-center">BoostPwr</th>
            </tr>
          </thead>
          <tbody>${snapRows}</tbody>
        </table>
      </div>
    </div>` : '<p class="text-gray-600 text-xs italic">Sin posiciones en hold en este scan.</p>'}
  </div>`;
}

function fmtP(v) {
  if (v===null||v===undefined) return 'â€”';
  const n=parseFloat(v); if (isNaN(n)) return 'â€”';
  return n<0.01?n.toFixed(8):n<1?n.toFixed(6):n<1000?n.toFixed(4):n.toFixed(2);
}

function buildConfigBadges(cfg) {
  if (!cfg||!Object.keys(cfg).length) return '';
  return `<details class="mt-2"><summary class="text-xs text-gray-600 cursor-pointer hover:text-gray-400">âš™ Config activa</summary>
  <div class="flex flex-wrap gap-1.5 mt-1.5">
    ${cfg.capitalTotal!==undefined?`<span class="pill text-xs bg-gray-800 text-gray-400">capital $${cfg.capitalTotal}</span>`:''}
    ${cfg.capitalPerCycle!==undefined?`<span class="pill text-xs bg-gray-800 text-gray-400">ciclo ${((cfg.capitalPerCycle||0)*100).toFixed(0)}%</span>`:''}
    ${cfg.takeProfitPct!==undefined?`<span class="pill text-xs bg-green-900/50 text-green-400">TP ${cfg.takeProfitPct}%</span>`:''}
    ${cfg.stopLossPct!==undefined?`<span class="pill text-xs bg-red-900/50 text-red-400">SL ${cfg.stopLossPct}%</span>`:''}
    ${cfg.minBoostPower!==undefined?`<span class="pill text-xs bg-yellow-900/50 text-yellow-400">BP mÃ­n ${((cfg.minBoostPower||0)*100).toFixed(0)}%</span>`:''}
    ${cfg.maxHoldCycles!==undefined?`<span class="pill text-xs bg-blue-900/50 text-blue-400">max ${cfg.maxHoldCycles} ciclos</span>`:''}
    ${cfg.maxPositions!==undefined?`<span class="pill text-xs bg-gray-800 text-gray-400">max ${cfg.maxPositions} pos.</span>`:''}
    ${cfg.minSignals!==undefined?`<span class="pill text-xs bg-gray-800 text-gray-400">mÃ­n ${cfg.minSignals} seÃ±ales</span>`:''}
  </div></details>`;
}

function buildInvestDetails(e) {
  const exec=e.execution||{}, cap=e.capital||{}, snap=e.snapshot||{}, cfg=e.config||{}, positions=e.positions||[];
  const posRows = positions.map(p=>`
    <div class="bg-gray-900 rounded-lg p-2.5 border border-green-900/50 mb-2">
      <div class="flex justify-between items-start mb-1.5">
        <div><span class="font-bold text-sm text-white">${p.symbol}</span><span class="text-xs text-gray-400 ml-1">${p.name||''}</span><span class="pill text-xs bg-green-900 text-green-300 ml-1">rank #${p.selectionRank||'â€”'}</span></div>
        <span class="text-sm font-bold text-green-400">$${(p.capitalUSD||0).toFixed(2)}</span>
      </div>
      <div class="grid grid-cols-2 gap-x-4 gap-y-0.5 text-xs text-gray-400">
        <span>Entrada: <span class="mono text-white">$${fmtP(p.entryPrice)}</span></span>
        <span>Unidades: <span class="mono text-white">${p.units}</span></span>
        <span>BoostPower: <span class="mono text-yellow-300">${(p.boostPowerPct||0).toFixed(1)}%</span></span>
        <span>PredicciÃ³n: <span class="mono text-blue-300">+${(p.predictedChange||0).toFixed(2)}%</span></span>
        <span>Take Profit: <span class="mono text-green-400">$${fmtP(p.takeProfitPrice)}</span></span>
        <span>Stop Loss: <span class="mono text-red-400">$${fmtP(p.stopLossPrice)}</span></span>
        <span>Fee entrada: <span class="mono text-yellow-500">$${(p.entryFeeUSD||0).toFixed(4)}</span></span>
        <span>Max ciclos: <span class="mono text-gray-300">${p.maxHoldCycles||'â€”'}</span></span>
      </div>
    </div>`).join('');
  return `
  <div class="grid grid-cols-3 gap-2 mb-3 text-xs">
    <div class="bg-gray-900 rounded-lg p-2"><p class="text-gray-500 mb-1">Capital antes</p><p class="text-white font-bold mono">$${(cap.before?.available||0).toFixed(2)} disp.</p><p class="text-gray-400 mono">$${(cap.before?.invested||0).toFixed(2)} inv.</p></div>
    <div class="bg-green-950 rounded-lg p-2 text-center border border-green-800"><p class="text-green-400 mb-1 font-semibold">Desplegado</p><p class="text-green-300 font-bold text-lg mono">$${(cap.deployedThisCycle||0).toFixed(2)}</p><p class="text-gray-400 mono text-xs">${(cap.utilizationPct||0).toFixed(1)}% utilizaciÃ³n</p></div>
    <div class="bg-gray-900 rounded-lg p-2"><p class="text-gray-500 mb-1">Capital despuÃ©s</p><p class="text-white font-bold mono">$${(cap.after?.available||0).toFixed(2)} disp.</p><p class="text-gray-400 mono">$${(cap.after?.invested||0).toFixed(2)} inv.</p></div>
  </div>
  <div class="bg-gray-900 rounded-lg p-2 mb-3 text-xs"><p class="text-gray-500 mb-1.5 font-semibold">Snapshot evaluado</p>
    <div class="flex flex-wrap gap-2">
      <span class="pill bg-gray-800">Total: <b class="text-white">${snap.totalAssets||'â€”'}</b></span>
      <span class="pill bg-green-900/60 text-green-300">INVERTIBLE: ${snap.invertibles||0}</span>
      <span class="pill bg-yellow-900/60 text-yellow-300">APALANCADO: ${snap.apalancados||0}</span>
      <span class="pill bg-gray-700 text-gray-400">RUIDOSO: ${snap.ruidosos||0}</span>
    </div>
  </div>
  <div class="bg-gray-900 rounded-lg p-2 mb-3 text-xs"><p class="text-gray-500 mb-1.5 font-semibold">EjecuciÃ³n</p>
    <div class="flex flex-wrap gap-2">
      <span class="pill bg-gray-800">Posiciones: <b class="text-green-300">${exec.positionsOpened||0}</b></span>
      <span class="pill bg-gray-800">Fees est: <b class="text-yellow-400">$${(exec.totalFeesEstUSD||0).toFixed(4)}</b></span>
      <span class="pill ${exec.allOrdersOk!==false?'bg-green-900/60 text-green-300':'bg-red-900/60 text-red-300'}">${exec.allOrdersOk!==false?'âœ“ Ã“rdenes OK':'âš  AlgÃºn fallo'}</span>
    </div>
    <p class="text-gray-500 mt-1.5">Motivo: <span class="text-gray-300">${e.decisionReason||'â€”'}</span></p>
  </div>
  ${positions.length?`<p class="text-xs font-semibold text-gray-400 mb-2">Posiciones abiertas (${positions.length})</p><div>${posRows}</div>`:''}
  ${buildConfigBadges(cfg)}`;
}

function buildEvaluateDetails(e) {
  const sum=e.summary||{}, cap=e.capital||{}, cfg=e.config||{}, evals=e.evaluations||[], fb=e.algorithmFeedback||[];
  const evalRows = evals.map(ev=>{
    const pnlColor=(ev.pnlPct||0)>=0?'text-green-400':'text-red-400';
    const decIcon=ev.sold?(((ev.pnlPct||0)>=0)?'âœ…':'ğŸ”´'):'â¸ï¸';
    return `<div class="bg-gray-900 rounded-lg p-2.5 border ${ev.sold?(ev.pnlPct>=0?'border-green-900/50':'border-red-900/50'):'border-gray-800'} mb-2">
      <div class="flex justify-between items-start mb-1">
        <div class="flex items-center gap-1.5"><span>${decIcon}</span><span class="font-bold text-sm text-white">${ev.symbol}</span><span class="pill text-xs ${ev.sold?'bg-green-900 text-green-300':'bg-gray-800 text-gray-400'}">${ev.sold?'VENDIDA':'MANTENIDA'}</span></div>
        <span class="font-bold ${pnlColor} mono">${(ev.pnlPct||0)>=0?'+':''}${(ev.pnlPct||0).toFixed(2)}%</span>
      </div>
      <div class="grid grid-cols-2 gap-x-4 gap-y-0.5 text-xs text-gray-400">
        <span>Entrada: <span class="mono text-white">$${fmtP(ev.entryPrice)}</span></span>
        <span>Precio actual: <span class="mono text-white">$${fmtP(ev.currentPrice)}</span></span>
        <span>P&L USD: <span class="mono ${pnlColor}">$${(ev.pnlUSD||0).toFixed(4)}</span></span>
        <span>Neto (âˆ’fee): <span class="mono ${pnlColor}">$${(ev.netPnL||0).toFixed(4)}</span></span>
        <span>Ciclos: <span class="mono text-gray-300">${ev.holdCycles||0}/${ev.maxHoldCycles||'â€”'}</span></span>
        <span>BP: <span class="mono text-yellow-300">${((ev.boostPower||0)*100).toFixed(1)}%</span></span>
      </div>
      <p class="text-xs text-gray-500 mt-1.5">Motivo: <span class="text-gray-300">${ev.reason||'â€”'}</span></p>
      ${ev.algorithmFeedback&&!ev.predictionCorrect?`<div class="mt-1.5 bg-red-950/40 rounded p-1.5 text-xs"><span class="text-red-400 font-semibold">âš  PredicciÃ³n incorrecta</span><span class="text-gray-400 ml-2">Predicho +${ev.predictedChange?.toFixed(2)||'â€”'}% Â· Real ${ev.algorithmFeedback.actualChange?.toFixed(2)||'â€”'}% Â· Error ${ev.algorithmFeedback.errorMagnitude?.toFixed(2)||'â€”'}%</span>${ev.algorithmFeedback.suggestion?`<p class="text-yellow-400 mt-0.5">â†’ ${ev.algorithmFeedback.suggestion}</p>`:''}</div>`:ev.predictionCorrect===true?`<p class="text-xs text-green-500 mt-1">âœ“ PredicciÃ³n correcta</p>`:''}
    </div>`;
  }).join('');
  const winPct=sum.winRate!==null&&sum.winRate!==undefined?sum.winRate:'â€”';
  return `
  <div class="grid grid-cols-4 gap-2 mb-3">
    <div class="bg-gray-900 rounded-lg p-2 text-center text-xs"><p class="text-gray-500">Evaluadas</p><p class="text-white font-bold text-lg">${sum.evaluated||evals.length||0}</p></div>
    <div class="bg-green-950 rounded-lg p-2 text-center text-xs border border-green-900/50"><p class="text-green-400">Vendidas</p><p class="text-green-300 font-bold text-lg">${sum.sells||0}</p><p class="text-gray-500">${sum.wins||0}âœ“ ${sum.losses||0}âœ—</p></div>
    <div class="bg-gray-900 rounded-lg p-2 text-center text-xs"><p class="text-gray-500">Mantenidas</p><p class="text-white font-bold text-lg">${sum.holds||0}</p></div>
    <div class="bg-gray-900 rounded-lg p-2 text-center text-xs"><p class="text-gray-500">Win Rate</p><p class="${winPct>=50?'text-green-400':'text-red-400'} font-bold text-lg">${winPct}%</p></div>
  </div>
  <div class="grid grid-cols-3 gap-2 mb-3 text-xs">
    <div class="bg-gray-900 rounded-lg p-2"><p class="text-gray-500">Retorno neto</p><p class="font-bold ${(sum.netReturnPct||0)>=0?'text-green-400':'text-red-400'} mono">${(sum.netReturnPct||0)>=0?'+':''}${sum.netReturnPct||0}%</p></div>
    <div class="bg-gray-900 rounded-lg p-2"><p class="text-gray-500">P&L bruto</p><p class="mono text-white font-bold">$${(sum.totalPnLUSD||0).toFixed(4)}</p></div>
    <div class="bg-gray-900 rounded-lg p-2"><p class="text-gray-500">Fees pagadas</p><p class="mono text-yellow-400 font-bold">$${(sum.totalFeesUSD||0).toFixed(4)}</p></div>
  </div>
  <div class="bg-gray-900 rounded-lg p-2 mb-3 text-xs flex gap-4">
    <span class="text-gray-500">Capital post-eval: <span class="text-white font-bold mono">$${(cap.available||0).toFixed(2)}</span></span>
    <span class="text-gray-500">Posiciones abiertas: <span class="text-white font-bold">${cap.openRemaining||0}</span></span>
  </div>
  ${evals.length?`<p class="text-xs font-semibold text-gray-400 mb-2">Detalle por posiciÃ³n</p>${evalRows}`:''}
  ${fb.length?`<div class="bg-red-950/30 rounded-lg p-2 mt-2 text-xs border border-red-900/40"><p class="text-red-400 font-semibold mb-1">âš  RetroalimentaciÃ³n algoritmo (${fb.length} predicciones fallidas)</p>${fb.map(f=>`<p class="text-gray-400">${f.symbol}: pred +${f.predictedChange?.toFixed(2)||'â€”'}% Â· real ${f.actualChange?.toFixed(2)||'â€”'}% Â· error ${f.errorMagnitude?.toFixed(2)||'â€”'}%${f.suggestion?` â†’ <span class="text-yellow-400">${f.suggestion}</span>`:''}</p>`).join('')}</div>`:''}
  ${buildConfigBadges(cfg)}`;
}

function buildNoInvestDetails(e) {
  const dec=e.decision||{}, cap=e.capital||{}, snap=e.snapshot||{}, cfg=e.config||{};
  const topCands=dec.topCandidates||[];
  return `
  <div class="grid grid-cols-3 gap-2 mb-3 text-xs">
    <div class="bg-gray-900 rounded-lg p-2"><p class="text-gray-500">Capital disp.</p><p class="text-white font-bold mono">$${(cap.available||0).toFixed(2)}</p></div>
    <div class="bg-gray-900 rounded-lg p-2"><p class="text-gray-500">Invertido</p><p class="text-white font-bold mono">$${(cap.invested||0).toFixed(2)}</p></div>
    <div class="bg-gray-900 rounded-lg p-2"><p class="text-gray-500">UtilizaciÃ³n</p><p class="text-white font-bold mono">${(cap.utilizationPct||0).toFixed(1)}%</p></div>
  </div>
  <div class="bg-yellow-950/40 rounded-lg p-2.5 mb-3 border border-yellow-900/50 text-xs">
    <p class="text-yellow-400 font-semibold mb-1">Motivo de la decisiÃ³n</p>
    <p class="text-gray-300">${dec.reason||e.reason||'â€”'}</p>
    ${dec.candidatesFound!==undefined?`<p class="text-gray-500 mt-1">Candidatos: <b class="text-white">${dec.candidatesFound}</b> Â· MÃ­n: <b class="text-white">${dec.minSignalsRequired}</b> Â· BP mÃ­n: <b class="text-white">${((dec.minBoostRequired||0)*100).toFixed(0)}%</b></p>`:''}
  </div>
  <div class="bg-gray-900 rounded-lg p-2 mb-3 text-xs"><p class="text-gray-500 mb-1.5 font-semibold">Snapshot evaluado</p>
    <div class="flex flex-wrap gap-2">
      <span class="pill bg-gray-800">Total: <b class="text-white">${snap.totalAssets||'â€”'}</b></span>
      <span class="pill bg-green-900/60 text-green-300">INVERTIBLE: ${snap.invertibles||0}</span>
      <span class="pill bg-yellow-900/60 text-yellow-300">APALANCADO: ${snap.apalancados||0}</span>
      <span class="pill bg-gray-700">RUIDOSO: ${snap.ruidosos||0}</span>
      ${snap.topBoostPower?`<span class="pill bg-blue-900/60 text-blue-300">Top BP: ${(parseFloat(snap.topBoostPower||0)*100).toFixed(1)}%</span>`:''}
    </div>
  </div>
  ${topCands.length?`<p class="text-xs font-semibold text-gray-400 mb-2">Mejores candidatos evaluados</p>
  <div class="space-y-1">${topCands.map(c=>`
    <div class="flex items-center justify-between bg-gray-900 rounded p-2 text-xs ${c.meetsThreshold?'border border-green-900/40':'opacity-60'}">
      <div class="flex items-center gap-2">${c.meetsThreshold?'<span class="text-green-400">âœ“</span>':'<span class="text-red-400">âœ—</span>'}<span class="font-bold text-white">${c.symbol}</span><span class="text-gray-500">${c.classification}</span></div>
      <div class="flex gap-3"><span>BP: <b class="mono ${c.meetsThreshold?'text-green-300':'text-red-400'}">${(c.boostPowerPct||0).toFixed(1)}%</b></span><span>Pred: <b class="mono text-blue-300">+${(c.predictedChange||0).toFixed(2)}%</b></span>${!c.meetsThreshold?'<span class="text-red-500 text-xs">< umbral</span>':''}</div>
    </div>`).join('')}</div>`:''} 
  ${buildConfigBadges(cfg)}`;
}

function buildManualCloseDetails(e) {
  const pos=e.position||{}, res=e.result||{}, cfg=e.config||{};
  const pnlColor=(res.pnlPct||0)>=0?'text-green-400':'text-red-400';
  return `
  <div class="grid grid-cols-3 gap-2 mb-3">
    <div class="bg-gray-900 rounded-lg p-3 text-center text-xs border ${(res.pnlPct||0)>=0?'border-green-900/50':'border-red-900/50'}"><p class="text-gray-500 mb-1">P&L %</p><p class="font-bold text-2xl ${pnlColor} mono">${(res.pnlPct||0)>=0?'+':''}${(res.pnlPct||0).toFixed(2)}%</p></div>
    <div class="bg-gray-900 rounded-lg p-3 text-center text-xs"><p class="text-gray-500 mb-1">P&L USD bruto</p><p class="font-bold text-xl ${pnlColor} mono">${(res.pnlUSD||0)>=0?'+':''}$${(res.pnlUSD||0).toFixed(4)}</p></div>
    <div class="bg-gray-900 rounded-lg p-3 text-center text-xs"><p class="text-gray-500 mb-1">Neto (âˆ’fees)</p><p class="font-bold text-xl ${pnlColor} mono">${(res.netPnL||0)>=0?'+':''}$${(res.netPnL||0).toFixed(4)}</p></div>
  </div>
  <div class="bg-gray-900 rounded-lg p-2.5 mb-3 text-xs">
    <p class="text-gray-500 font-semibold mb-2">${pos.symbol||'â€”'} â€” ${pos.name||''}</p>
    <div class="grid grid-cols-2 gap-x-4 gap-y-0.5 text-gray-400">
      <span>Capital: <span class="mono text-white">$${(pos.capitalUSD||0).toFixed(2)}</span></span>
      <span>Unidades: <span class="mono text-white">${pos.units||'â€”'}</span></span>
      <span>Precio entrada: <span class="mono text-white">$${fmtP(pos.entryPrice)}</span></span>
      <span>Precio cierre: <span class="mono text-white">$${fmtP(pos.exitPrice)}</span></span>
      <span>TP configurado: <span class="mono text-green-400">$${fmtP(pos.takeProfitPrice)}</span></span>
      <span>SL configurado: <span class="mono text-red-400">$${fmtP(pos.stopLossPrice)}</span></span>
      <span>Ciclos mantenida: <span class="mono text-gray-300">${pos.holdCycles||0}</span></span>
      <span>DuraciÃ³n: <span class="mono text-gray-300">${pos.holdDurationHrs?pos.holdDurationHrs+'h':'â€”'}</span></span>
      <span>BP entrada: <span class="mono text-yellow-300">${((pos.boostPower||0)*100).toFixed(1)}%</span></span>
      <span>PredicciÃ³n: <span class="mono text-blue-300">+${(pos.predictedChange||0).toFixed(2)}%</span></span>
    </div>
  </div>
  <div class="bg-gray-900 rounded-lg p-2 mb-3 text-xs flex gap-4">
    <span class="text-gray-500">Fee salida: <span class="mono text-yellow-400">$${(res.exitFeeUSD||0).toFixed(4)}</span></span>
    <span class="text-gray-500">Fees totales: <span class="mono text-yellow-400">$${(res.totalFees||0).toFixed(4)}</span></span>
    <span class="${res.predictionCorrect?'text-green-400':'text-red-400'}">${res.predictionCorrect?'âœ“ PredicciÃ³n correcta':'âœ— PredicciÃ³n incorrecta'}</span>
  </div>
  ${res.algorithmFeedback&&!res.predictionCorrect?`<div class="bg-red-950/30 rounded-lg p-2 mb-3 border border-red-900/40 text-xs"><p class="text-red-400 font-semibold">âš  RetroalimentaciÃ³n al algoritmo</p><p class="text-gray-400">Predicho: +${res.algorithmFeedback.predictedChange?.toFixed(2)||'â€”'}% Â· Real: ${res.algorithmFeedback.actualChange?.toFixed(2)||'â€”'}% Â· Error: ${res.algorithmFeedback.errorMagnitude?.toFixed(2)||'â€”'}%</p>${res.algorithmFeedback.suggestion?`<p class="text-yellow-400 mt-1">â†’ ${res.algorithmFeedback.suggestion}</p>`:''}</div>`:''}
  ${buildConfigBadges(cfg)}`;
}

function toggleLogCard(id) {
  if (investLogExpanded.has(id)) investLogExpanded.delete(id);
  else investLogExpanded.add(id);
  renderInvestLog();
}

function setLogFilter(type) {
  investLogFilter = type;
  document.querySelectorAll('.log-filter-btn').forEach(btn => {
    const active = btn.dataset.filter === type;
    btn.classList.toggle('bg-gray-700', active);
    btn.classList.toggle('text-white', active);
    btn.classList.toggle('text-gray-500', !active);
    btn.classList.toggle('bg-transparent', !active);
  });
  renderInvestLog();
}

async function exportInvestLog() {
  try {
    const r = await fetch('/api/invest/log/export');
    const blob = await r.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `invest-log-${new Date().toISOString().slice(0,10)}.json`; a.click();
    URL.revokeObjectURL(url);
  } catch(e) { alert('âŒ Error exportando: ' + e.message); }
}

async function analyzeLogWithSabios() {
  const btn = document.getElementById('btn-analyze-sabios');
  const res = document.getElementById('inv-log-sabios-result');
  if (!btn || !res) return;
  btn.disabled = true; btn.textContent = 'ğŸ”„ Analizando...';
  res.innerHTML = `<div class="bg-gray-900 rounded-xl p-4 border border-purple-900/50 mt-3"><p class="text-purple-400 animate-pulse">ğŸ§  Los Sabios estÃ¡n analizando tu historial...</p><p class="text-gray-500 text-xs mt-1">Esto puede tardar 10-30 segundos.</p></div>`;
  try {
    const r = await fetch('/api/invest/log/analyze', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({limit:50}) });
    const d = await r.json();
    if (!d.success) { res.innerHTML=`<div class="bg-red-950/40 rounded-xl p-3 border border-red-900/50 mt-3"><p class="text-red-400">âŒ ${d.error}</p></div>`; return; }

    const llms = d.llmResults || {}, cons = d.consensus || {};
    const LLM_COLORS = { Gemini:'blue', Claude:'purple', OpenAI:'green', Llama:'orange', Mistral:'pink', Cohere:'teal', Cerebras:'cyan' };

    const cards = Object.entries(llms).map(([key, llm]) => {
      if (!llm.success) return `<div class="bg-gray-900 rounded-xl p-3 border border-gray-800"><p class="text-xs font-semibold text-gray-400 mb-1">${llm.model||key}</p><p class="text-xs text-red-400">âŒ ${llm.error||'Sin respuesta'}</p></div>`;
      const a = llm.data || {};
      const col = LLM_COLORS[llm.model||key] || 'gray';
      return `<div class="bg-gray-900 rounded-xl border border-${col}-900/50 overflow-hidden">
        <div class="bg-${col}-950 px-3 py-2 flex justify-between"><span class="text-xs font-bold text-${col}-400">${llm.model||key} ${llm.modelUsed?`<span class="text-gray-500">(${llm.modelUsed})</span>`:''}</span><span class="pill text-xs bg-${col}-900 text-${col}-300">âœ“</span></div>
        <div class="p-3 space-y-2 text-xs">
          ${a.overallAssessment?`<div><p class="text-gray-500 font-semibold mb-1">EvaluaciÃ³n general</p><p class="text-gray-300 leading-relaxed">${a.overallAssessment}</p></div>`:''}
          ${a.strengths?.length?`<div><p class="text-green-400 font-semibold mb-1">âœ… Fortalezas</p>${a.strengths.map(s=>`<p class="text-gray-400 ml-2">â€¢ ${s}</p>`).join('')}</div>`:''}
          ${a.weaknesses?.length?`<div><p class="text-red-400 font-semibold mb-1">âš  Debilidades</p>${a.weaknesses.map(w=>`<p class="text-gray-400 ml-2">â€¢ ${w}</p>`).join('')}</div>`:''}
          ${a.keyFindings?.length?`<div><p class="text-blue-400 font-semibold mb-1">ğŸ” Hallazgos clave</p>${a.keyFindings.map(f=>`<div class="bg-gray-800 rounded p-1.5 mb-1"><span class="pill text-xs ${f.impact==='high'?'bg-red-900 text-red-300':f.impact==='medium'?'bg-yellow-900 text-yellow-300':'bg-gray-700 text-gray-400'} mr-1">${f.impact||'?'}</span><span class="text-gray-300">${f.finding}</span>${f.evidence?`<p class="text-gray-500 mt-0.5 ml-1">${f.evidence}</p>`:''}</div>`).join('')}</div>`:''}
          ${a.parameterRecommendations?`<div><p class="text-yellow-400 font-semibold mb-1">âš™ Recomendaciones</p>${Object.entries(a.parameterRecommendations).filter(([,v])=>v?.suggested!==null&&v?.suggested!==undefined).map(([param,rec])=>`<div class="flex justify-between bg-gray-800 rounded p-1 mb-0.5"><span class="text-gray-400">${param}</span><span><span class="text-gray-500">${rec.current} â†’</span><span class="text-yellow-300 font-bold ml-1">${rec.suggested}</span></span></div>`).join('')}</div>`:''}
          ${a.actionPlan?.length?`<div><p class="text-purple-400 font-semibold mb-1">ğŸ¯ Plan de acciÃ³n</p>${a.actionPlan.map((ac,i)=>`<p class="text-gray-400 ml-2">${i+1}. ${ac}</p>`).join('')}</div>`:''}
          ${a.summary?`<p class="text-gray-500 italic border-t border-gray-800 pt-2 mt-2">${a.summary}</p>`:''}
        </div>
      </div>`;
    }).join('');

    const paramCons = cons.parameterRecommendations && Object.keys(cons.parameterRecommendations).length
      ? `<div class="bg-gray-900 rounded-xl p-3 border border-yellow-900/50 mb-3"><p class="text-xs font-semibold text-yellow-400 mb-2">âš™ Consenso (${cons.respondedCount}/${cons.totalCalled} LLMs)</p><div class="space-y-1">${Object.entries(cons.parameterRecommendations).map(([param,c])=>`<div class="flex justify-between text-xs bg-gray-800 rounded p-1.5"><span class="text-gray-400">${param}</span><div class="flex items-center gap-2"><span class="text-gray-500">${c.suggestions.join(', ')}</span><span class="text-yellow-300 font-bold">avg: ${c.avg}</span>${c.agree?'<span class="pill bg-green-900 text-green-300">Consenso âœ“</span>':'<span class="pill bg-gray-700 text-gray-500">Divergente</span>'}</div></div>`).join('')}</div></div>` : '';

    res.innerHTML = `<div class="mt-3 space-y-3">
      <div class="flex items-center justify-between"><p class="text-sm font-semibold text-purple-400">ğŸ§  AnÃ¡lisis de los Sabios â€” ${d.analyzedEntries} entradas</p><p class="text-xs text-gray-500">${new Date(d.generatedAt).toLocaleString('es-ES')}</p></div>
      ${paramCons}
      <div class="grid grid-cols-1 gap-3">${cards}</div>
    </div>`;
  } catch(err) {
    res.innerHTML = `<div class="bg-red-950/40 rounded-xl p-3 border border-red-900/50 mt-3"><p class="text-red-400">âŒ ${err.message}</p></div>`;
  } finally {
    btn.disabled = false; btn.textContent = 'ğŸ§  Analizar con Sabios';
  }
}

// â”€â”€ Guardar config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function saveInvestConfig() {
  const cfg = {
    mode:           investConfig?.mode || 'simulated',
    exchange:       investConfig?.exchange || 'binance',
    capitalTotal:   parseFloat(document.getElementById('ic-capital')?.value || 1000),
    capitalPerCycle: parseInt(document.getElementById('ic-percycle')?.value || 30) / 100,
    maxPositions:   parseInt(document.getElementById('ic-maxpos')?.value || 3),
    minSignals:     parseInt(document.getElementById('ic-minsig')?.value || 2),
    takeProfitPct:  parseInt(document.getElementById('ic-tp')?.value || 10),
    stopLossPct:    parseInt(document.getElementById('ic-sl')?.value || 5),
    maxHoldCycles:  parseInt(document.getElementById('ic-hold')?.value || 3),
    minBoostPower:  parseInt(document.getElementById('ic-bp')?.value || 65) / 100,
    stableCoin:     'USDT',
    diversification: true,
    feePct:         0.10,
    apiCostPerCycle: 0.02
  };
  const msg = document.getElementById('inv-config-msg');
  try {
    const r = await fetch('/api/invest/config', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(cfg) });
    const d = await r.json();
    if (d.success) { investConfig=d.config; applyInvestConfigToUI(); msg.innerHTML='<span class="text-green-400">âœ… Guardado</span>'; }
    else msg.innerHTML=`<span class="text-red-400">âŒ ${d.error}</span>`;
  } catch(e) { msg.innerHTML=`<span class="text-red-400">âŒ ${e.message}</span>`; }
  setTimeout(()=>{ if(msg) msg.innerHTML=''; }, 3000);
}

// â”€â”€ Guardar API key de exchange â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function saveExchangeKey(keyName, inputId) {
  const keyValue = document.getElementById(inputId)?.value?.trim();
  const msg = document.getElementById('exchange-key-msg');
  if (!keyValue) { msg.innerHTML='<span class="text-red-400">Introduce una key vÃ¡lida</span>'; return; }
  try {
    const r = await fetch('/api/invest/api-key', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({keyName, keyValue}) });
    const d = await r.json();
    if (d.success) { document.getElementById(inputId).value=''; msg.innerHTML=`<span class="text-green-400">âœ… ${keyName} guardada</span>`; }
    else msg.innerHTML=`<span class="text-red-400">âŒ ${d.error}</span>`;
  } catch(e) { msg.innerHTML=`<span class="text-red-400">âŒ ${e.message}</span>`; }
  setTimeout(()=>{ if(msg) msg.innerHTML=''; }, 3000);
}

// â”€â”€ Test de exchange â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function pingExchange() {
  try {
    const r = await fetch('/api/invest/exchange/ping');
    const d = await r.json();
    const msg = d.connected
      ? `âœ… ${d.exchange} conectado Â· ${d.mode==='simulated'?'Modo simulado':'Modo '+(d.testnet?'testnet':'REAL')} Â· USDT: $${(d.usdtBalance||d.usdBalance||0).toFixed(2)}`
      : `âŒ ${d.exchange}: ${d.error}`;
    alert(msg);
  } catch(e) { alert('âŒ ' + e.message); }
}

// [override eliminado â€” lÃ³gica integrada en confirmCycle original]

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DETECTOR DE PUMP COORDINADO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let pumpSettings = null;
let pumpDetectorEnabled = true;
let currentPumpSubtab = 'pump-results';

// â”€â”€ Tab del detector â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Override setTab para cargar datos al entrar
// [override setTab eliminado â€” lÃ³gica consolidada en setTab original]

function openPumpTab(tab) {
  document.querySelectorAll('.pumptab-content').forEach(el => el.classList.add('hidden'));
  document.querySelectorAll('.pumptab').forEach(el => {
    el.classList.remove('bg-gray-800','text-white'); el.classList.add('text-gray-400');
  });
  const el = document.getElementById(tab); if (el) el.classList.remove('hidden');
  const btn = document.getElementById('pumptab-' + tab);
  if (btn) { btn.classList.add('bg-gray-800','text-white'); btn.classList.remove('text-gray-400'); }
  currentPumpSubtab = tab;
  if (tab === 'pump-history') loadPumpHistory();
}

// â”€â”€ Cargar Ãºltimo escaneo guardado â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadPumpScan() {
  try {
    const r = await fetch('/api/pump/scan');
    const d = await r.json();
    if (!d.success) return;
    if (!d.cached) {
      document.getElementById('pump-detections-list').innerHTML =
        '<div class="text-center py-10"><p class="text-gray-500 text-sm mb-3">Sin escaneo previo.</p><button onclick="runPumpScan()" class="bg-red-700 hover:bg-red-600 px-6 py-2 rounded-lg text-sm font-semibold">ğŸ” Iniciar primer escaneo</button></div>';
      return;
    }
    renderPumpScanMeta(d);
    renderPumpDetections(d.detections || []);
  } catch(e) { console.error('loadPumpScan:', e); }
}

// â”€â”€ Ejecutar escaneo sÃ­ncrono â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function runPumpScan() {
  const btn = document.getElementById('btn-pump-scan');
  btn.disabled = true; btn.textContent = 'â³ Escaneando... (~30s)';
  btn.className = btn.className.replace('bg-red-700','bg-gray-600');
  document.getElementById('pump-detections-list').innerHTML =
    '<div class="text-center py-12"><div class="text-4xl mb-4">ğŸ”</div><p class="text-gray-400 text-sm">Analizando small-caps en busca de patrones de pump coordinado...</p><p class="text-gray-600 text-xs mt-2">Reddit Â· CoinGecko Â· LunarCrush Â· Noticias Â· Glassnode</p></div>';
  try {
    const r = await fetch('/api/pump/scan-sync', { method: 'POST' });
    const d = await r.json();
    if (!d.success) throw new Error(d.error);
    renderPumpScanMeta(d);
    renderPumpDetections(d.detections || []);
    openPumpTab('pump-results');
  } catch(e) {
    document.getElementById('pump-detections-list').innerHTML = `<p class="text-red-400 text-sm">âŒ ${e.message}</p>`;
  }
  btn.disabled = false;
  btn.textContent = 'ğŸ” Escanear ahora';
  btn.className = btn.className.replace('bg-gray-600','bg-red-700');
}

function renderPumpScanMeta(d) {
  const meta = document.getElementById('pump-scan-meta');
  meta.classList.remove('hidden');
  document.getElementById('pump-scan-time').textContent = `Ãšltimo escaneo: ${new Date(d.scannedAt).toLocaleString('es-ES')}`;
  const count = d.detectionsCount || d.detections?.length || 0;
  const col   = count === 0 ? 'text-green-400' : count < 3 ? 'text-yellow-400' : 'text-red-400';
  document.getElementById('pump-scan-count').innerHTML =
    `<span class="${col} font-semibold">${count} detecciÃ³n${count!==1?'es':''}</span> <span class="text-gray-500">de ${d.scannedCount||0} analizados</span>`;
}

function renderPumpDetections(detections) {
  const div = document.getElementById('pump-detections-list');
  if (detections.length === 0) {
    div.innerHTML = '<div class="text-center py-10"><p class="text-5xl mb-3">âœ…</p><p class="text-green-400 font-semibold">Sin anomalÃ­as detectadas</p><p class="text-gray-500 text-sm mt-1">No se observan patrones de pump coordinado en small-caps</p></div>';
    return;
  }
  // Guardar datos de cada detecciÃ³n para uso posterior (compra manual)
  detections.forEach(d => { if (d.assetId) pumpDetectionMap[d.assetId] = d; });
  div.innerHTML = detections.map(d => renderDetectionCard(d)).join('');
  // Cargar scoring del algoritmo para cada detecciÃ³n de forma asÃ­ncrona
  detections.forEach(d => { if (d.assetId) _loadPumpAlgoScore(d.assetId); });
}

function renderDetectionCard(d) {
  const colors = { red:'red', orange:'orange', green:'green' };
  const c = colors[d.riskColor] || 'gray';
  const breakdownBars = Object.entries(d.breakdown || {}).map(([key, val]) => {
    const names = { socialSpike:'ğŸ“± Spike Social', volumeAnomaly:'ğŸ“Š Volumen', vacuousNews:'ğŸ“° Noticias', whaleActivity:'ğŸ‹ Ballenas', lunarCrush:'ğŸŒ™ LunarCrush', timingSync:'â±ï¸ Timing' };
    const pct = val.max > 0 ? Math.round(val.score / val.max * 100) : 0;
    const barColor = pct >= 80 ? 'bg-red-500' : pct >= 50 ? 'bg-orange-500' : 'bg-green-600';
    return `<div>
      <div class="flex justify-between text-xs mb-0.5"><span class="text-gray-400">${names[key]||key}</span><span class="mono font-medium text-gray-300">${val.score}/${val.max}</span></div>
      <div class="w-full bg-gray-800 rounded-full h-1.5"><div class="h-1.5 rounded-full ${barColor} transition-all" style="width:${pct}%"></div></div>
    </div>`;
  }).join('');

  const evidenceHTML = (d.evidence || []).map(e =>
    `<p class="text-xs text-gray-400 flex items-start gap-1.5 py-0.5"><span class="text-yellow-500 flex-shrink-0 mt-0.5">âš¡</span>${e}</p>`
  ).join('');

  const newsHTML = (d.flaggedNews || []).slice(0,3).map(n =>
    `<p class="text-xs text-yellow-400 flex items-start gap-1.5 py-0.5"><span>ğŸ“°</span><span>${n.title.slice(0,80)}... <em class="text-gray-500">(${n.source||'â€”'})</em></span></p>`
  ).join('');

  const clonesHTML = (d.clonedSignals || []).flatMap(s => s.clones||[]).slice(0,2).map(cl =>
    `<div class="bg-gray-900 rounded p-2 text-xs mono text-gray-400"><span class="text-orange-400">A:</span> "${cl.a}"<br/><span class="text-orange-400">B:</span> "${cl.b}" <span class="text-gray-600">(sim: ${cl.sim})</span></div>`
  ).join('');

  return `
    <div class="bg-gray-900 rounded-xl border border-gray-800 border-l-4 border-${c}-600 p-5 mb-4">
      <!-- Header del activo -->
      <div class="flex justify-between items-start mb-4">
        <div>
          <div class="flex items-center gap-3 mb-1">
            <h3 class="text-lg font-bold">${d.name}</h3>
            <span class="text-gray-400 mono text-sm">${d.symbol}</span>
            <span class="pill bg-${c}-950 text-${c}-400 font-bold">${d.riskEmoji} ${d.riskLevel}</span>
          </div>
          <p class="text-xs text-gray-500">Market Cap: $${(d.market_cap/1e6).toFixed(1)}M Â· Vol 24h: $${(d.total_volume/1e6).toFixed(1)}M Â· ${new Date(d.detectedAt).toLocaleString('es-ES')}</p>
        </div>
        <div class="text-right flex-shrink-0 ml-4">
          <div class="text-4xl font-bold mono text-${c}-400">${d.totalScore}</div>
          <div class="text-xs text-gray-500">/ 10 score</div>
        </div>
      </div>

      <!-- Score breakdown -->
      <div class="grid grid-cols-3 gap-3 mb-4">
        ${breakdownBars}
      </div>

      <!-- Evidencias -->
      ${evidenceHTML ? `<div class="bg-gray-800/50 rounded-lg p-3 mb-3"><p class="text-xs font-semibold text-gray-400 mb-2">Evidencias detectadas</p>${evidenceHTML}</div>` : ''}

      <!-- Noticias sospechosas -->
      ${newsHTML ? `<div class="bg-yellow-950/30 border border-yellow-900 rounded-lg p-3 mb-3"><p class="text-xs font-semibold text-yellow-400 mb-2">Noticias con lenguaje sospechoso</p>${newsHTML}</div>` : ''}

      <!-- Mensajes clonados -->
      ${clonesHTML ? `<div class="bg-orange-950/30 border border-orange-900 rounded-lg p-3 mb-3"><p class="text-xs font-semibold text-orange-400 mb-2">Mensajes clonados detectados</p><div class="space-y-1">${clonesHTML}</div></div>` : ''}

      <!-- Scoring del Algoritmo (cargado async) -->
      <div class="bg-gray-800/60 border border-indigo-900/50 rounded-lg p-3 mb-3">
        <p class="text-xs font-semibold text-indigo-400 mb-2">ğŸ§  Scoring del Algoritmo</p>
        <div id="algo-score-${d.assetId}" class="text-xs text-gray-500 flex items-center gap-2">
          <span class="animate-spin inline-block">â³</span> Calculando boostPower y clasificaciÃ³n...
        </div>
      </div>

      <!-- Botones de acciÃ³n -->
      <div class="flex gap-2 mt-4 flex-wrap">
        <button onclick="viewPumpAssetDetail('${d.assetId}')" class="flex-1 bg-blue-700 hover:bg-blue-600 px-4 py-2 rounded-lg text-sm font-semibold transition-colors">
          ğŸ” Ver anÃ¡lisis
        </button>
        <button id="btn-ciclo-${d.assetId}" onclick="addPumpAssetToCycle('${d.assetId}', '${d.symbol}')" class="flex-1 bg-indigo-800 hover:bg-indigo-700 px-4 py-2 rounded-lg text-sm font-semibold transition-colors">
          ğŸ“ˆ Ciclo inversiÃ³n
        </button>
        <button onclick="openPumpBuyModal('${d.assetId}', '${d.symbol}', ${d.current_price || 0}, null)" class="flex-1 bg-emerald-700 hover:bg-emerald-600 px-4 py-2 rounded-lg text-sm font-bold transition-colors">
          ğŸ’° Comprar
        </button>
      </div>
    </div>`;
}

// â”€â”€ Scoring del algoritmo para detecciones pump (lazy load) â”€â”€â”€â”€â”€â”€â”€
async function _loadPumpAlgoScore(assetId) {
  const block = document.getElementById(`algo-score-${assetId}`);
  if (!block) return;
  try {
    // Reutilizar cachÃ© si disponible (< 5 min)
    const cached = pumpAssetCache[assetId];
    const now = Date.now();
    let asset;
    if (cached && (now - cached.ts) < 5 * 60 * 1000) {
      asset = cached.data;
    } else {
      const r = await fetch(`/api/pump/asset/${assetId}?mode=speculative`);
      const d = await r.json();
      if (!d.success) throw new Error(d.error);
      asset = d.asset;
      pumpAssetCache[assetId] = { data: asset, ts: now };
    }

    const bp  = Math.round((asset.boostPower || 0) * 100);
    const cl  = asset.classification || {};
    const cat = typeof cl === 'object' ? (cl.category || 'RUIDOSO') : (cl || 'RUIDOSO');
    const pred = asset.predictedChange || 0;
    const predStr = `${pred >= 0 ? '+' : ''}${pred.toFixed(1)}%`;
    const catColors = { INVERTIBLE: 'text-green-400', APALANCADO: 'text-yellow-400', RUIDOSO: 'text-gray-400', PUMP: 'text-red-400' };
    const catEmoji  = { INVERTIBLE: 'ğŸŸ¢', APALANCADO: 'ğŸŸ¡', RUIDOSO: 'âšª', PUMP: 'ğŸš¨' };
    const bpColor = bp >= 65 ? 'bg-green-500' : bp >= 40 ? 'bg-yellow-500' : 'bg-gray-600';

    block.innerHTML = `
      <div class="space-y-2">
        <div class="flex items-center gap-3">
          <div class="flex-1">
            <div class="flex justify-between text-xs mb-1"><span class="text-gray-400">âš¡ BoostPower</span><span class="font-bold ${catColors[cat] || 'text-gray-400'}">${bp}%</span></div>
            <div class="w-full bg-gray-700 rounded-full h-2"><div class="h-2 rounded-full ${bpColor} transition-all" style="width:${bp}%"></div></div>
          </div>
          <span class="pill border border-gray-700 ${catColors[cat] || 'text-gray-400'} text-xs font-bold whitespace-nowrap">${catEmoji[cat] || 'âšª'} ${cat}</span>
        </div>
        <div class="flex gap-4 text-xs">
          <span class="${pred >= 0 ? 'text-green-400' : 'text-red-400'} font-semibold">ğŸ“ˆ PredicciÃ³n: ${predStr}</span>
          ${cl.confidence ? `<span class="text-gray-500">Confianza: ${cl.confidence}</span>` : ''}
        </div>
        ${cl.reason ? `<p class="text-xs text-gray-500 leading-relaxed">ğŸ’¬ ${cl.reason}</p>` : ''}
      </div>`;

    // Colorear botÃ³n de ciclo segÃºn clasificaciÃ³n
    const btn = document.getElementById(`btn-ciclo-${assetId}`);
    if (btn && cat === 'INVERTIBLE') { btn.className = btn.className.replace('bg-indigo-800 hover:bg-indigo-700', 'bg-green-800 hover:bg-green-700'); }
    if (btn && cat === 'APALANCADO') { btn.className = btn.className.replace('bg-indigo-800 hover:bg-indigo-700', 'bg-yellow-800 hover:bg-yellow-700'); }

  } catch(e) {
    if (block) block.innerHTML = `<span class="text-red-400">âŒ ${e.message}</span>`;
  }
}

// â”€â”€ Historial â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadPumpHistory() {
  const div = document.getElementById('pump-history-list');
  div.innerHTML = '<p class="text-gray-400 text-sm">Cargando...</p>';
  try {
    const r = await fetch('/api/pump/history');
    const d = await r.json();
    if (!d.success || !d.history.length) {
      div.innerHTML = '<p class="text-gray-500 text-sm">Sin historial de detecciones previas.</p>'; return;
    }
    div.innerHTML = d.history.map(entry => `
      <div class="bg-gray-900 border border-gray-800 rounded-xl p-4 mb-3">
        <div class="flex justify-between items-center mb-2">
          <p class="text-sm font-semibold">${new Date(entry.scannedAt).toLocaleString('es-ES')}</p>
          <span class="text-xs text-gray-500">${entry.detections?.length||0} detecciÃ³n${entry.detections?.length!==1?'es':''}</span>
        </div>
        <div class="flex flex-wrap gap-2">
          ${(entry.detections||[]).map(d => `
            <span class="pill bg-${d.riskColor==='red'?'red':'orange'}-950 text-${d.riskColor==='red'?'red':'orange'}-400">
              ${d.riskEmoji} ${d.symbol} (${d.totalScore}/10)
            </span>`).join('')}
        </div>
      </div>`).join('');
  } catch(e) { div.innerHTML = `<p class="text-red-400 text-sm">âŒ ${e.message}</p>`; }
}

// â”€â”€ Settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadPumpSettings() {
  try {
    const r = await fetch('/api/pump/settings');
    const d = await r.json();
    if (!d.success) return;
    pumpSettings = d.settings;
    const el_interval  = document.getElementById('pc-interval');
    const el_minscore  = document.getElementById('pc-minscore');
    const el_iv        = document.getElementById('pc-interval-v');
    const el_mv        = document.getElementById('pc-minscore-v');
    if (el_interval) { el_interval.value = d.settings.intervalHours || 6; }
    if (el_iv)       { el_iv.textContent = (d.settings.intervalHours||6) + 'h'; }
    if (el_minscore) { el_minscore.value = d.settings.minScoreAlert || 4; }
    if (el_mv)       { el_mv.textContent = d.settings.minScoreAlert || 4; }
    pumpDetectorEnabled = d.settings.enabled !== false;
    const toggleBtn = document.getElementById('btn-detector-toggle');
    if (toggleBtn) {
      toggleBtn.textContent = pumpDetectorEnabled ? 'âœ… Activado' : 'â¸ï¸ Desactivado';
      toggleBtn.className   = 'px-4 py-2 rounded-lg text-sm font-semibold ' + (pumpDetectorEnabled ? 'bg-green-700 hover:bg-green-600' : 'bg-gray-700 hover:bg-gray-600');
    }
    const schedulerBadge = document.getElementById('pump-scheduler-badge');
    if (schedulerBadge) {
      schedulerBadge.textContent = pumpDetectorEnabled ? `â° Cada ${d.settings.intervalHours||6}h` : 'â¸ï¸ Pausado';
      schedulerBadge.className = 'pill ' + (pumpDetectorEnabled ? 'bg-blue-900 text-blue-300' : 'bg-gray-800 text-gray-400') + ' text-xs';
    }
  } catch(e) {}
}

async function savePumpSettings() {
  const msg = document.getElementById('pump-settings-msg');
  try {
    const r = await fetch('/api/pump/settings', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
        enabled:       pumpDetectorEnabled,
        intervalHours: parseInt(document.getElementById('pc-interval')?.value || 6),
        minScoreAlert: parseInt(document.getElementById('pc-minscore')?.value || 4)
      })
    });
    const d = await r.json();
    if (d.success) { msg.innerHTML = '<span class="text-green-400">âœ… Guardado</span>'; await loadPumpSettings(); }
    else msg.innerHTML = `<span class="text-red-400">âŒ ${d.error}</span>`;
  } catch(e) { msg.innerHTML = `<span class="text-red-400">âŒ ${e.message}</span>`; }
  setTimeout(() => { if(msg) msg.innerHTML = ''; }, 3000);
}

function toggleDetector() {
  pumpDetectorEnabled = !pumpDetectorEnabled;
  const btn = document.getElementById('btn-detector-toggle');
  if (btn) {
    btn.textContent = pumpDetectorEnabled ? 'âœ… Activado' : 'â¸ï¸ Desactivado';
    btn.className   = 'px-4 py-2 rounded-lg text-sm font-semibold ' + (pumpDetectorEnabled ? 'bg-green-700 hover:bg-green-600' : 'bg-gray-700 hover:bg-gray-600');
  }
}

// â”€â”€ Email â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function savePumpEmail() {
  const msg = document.getElementById('pump-email-msg');
  const cfg = {
    host: document.getElementById('pe-host')?.value?.trim() || 'smtp.gmail.com',
    port: parseInt(document.getElementById('pe-port')?.value || 587),
    user: document.getElementById('pe-user')?.value?.trim(),
    pass: document.getElementById('pe-pass')?.value,
    to:   document.getElementById('pe-to')?.value?.trim()
  };
  if (!cfg.user || !cfg.to) { msg.innerHTML = '<span class="text-red-400">Usuario y destinatario son obligatorios</span>'; return; }
  try {
    const r = await fetch('/api/pump/email-config', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(cfg) });
    const d = await r.json();
    if (d.success) {
      msg.innerHTML = '<span class="text-green-400">âœ… Email guardado Â· Activa las alertas en los ajustes del detector</span>';
      document.getElementById('pe-pass').value = '';
    } else { msg.innerHTML = `<span class="text-red-400">âŒ ${d.error}</span>`; }
  } catch(e) { msg.innerHTML = `<span class="text-red-400">âŒ ${e.message}</span>`; }
  setTimeout(() => { if(msg) msg.innerHTML = ''; }, 4000);
}

async function testPumpEmail() {
  const msg = document.getElementById('pump-email-msg');
  msg.innerHTML = '<span class="text-gray-400">â³ Enviando email de prueba...</span>';
  try {
    const r = await fetch('/api/pump/test-email', { method: 'POST' });
    const d = await r.json();
    if (d.success) msg.innerHTML = '<span class="text-green-400">âœ… Email de prueba enviado correctamente</span>';
    else msg.innerHTML = `<span class="text-red-400">âŒ ${d.error}</span>`;
  } catch(e) { msg.innerHTML = `<span class="text-red-400">âŒ ${e.message}</span>`; }
  setTimeout(() => { if(msg) msg.innerHTML = ''; }, 5000);
}

window.onload = () => { init(); };

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FUNCIONES PARA ACTIVOS DETECTADOS EN PUMP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let currentPumpAssetDetail = null;
const pumpAssetCache = {}; // cachÃ© en memoria por assetId
const pumpDetectionMap = {}; // datos bÃ¡sicos de cada detecciÃ³n renderizada

async function viewPumpAssetDetail(assetId) {
  try {
    document.getElementById('pump-asset-detail-loading').classList.remove('hidden');
    document.getElementById('pump-asset-detail-content').classList.add('hidden');
    showModal('modal-pump-asset-detail');

    // Usar cachÃ© si ya fue cargado recientemente (< 5 min)
    const cached = pumpAssetCache[assetId];
    const now = Date.now();
    let asset;
    if (cached && (now - cached.ts) < 5 * 60 * 1000) {
      asset = cached.data;
    } else {
      const r = await fetch(`/api/pump/asset/${assetId}?mode=speculative`);
      const d = await r.json();
      if (!d.success) throw new Error(d.error);
      asset = d.asset;
      pumpAssetCache[assetId] = { data: asset, ts: now };
    }

    currentPumpAssetDetail = asset;
    renderPumpAssetDetail(asset);
    document.getElementById('pump-asset-detail-loading').classList.add('hidden');
    document.getElementById('pump-asset-detail-content').classList.remove('hidden');
  } catch(e) {
    alert('âŒ Error al cargar anÃ¡lisis: ' + e.message);
    closeModal('modal-pump-asset-detail');
  }
}

// Etiquetas legibles para cada factor del breakdown
const FACTOR_LABELS = {
  atlProximity:    'Proximidad ATL',
  volumeSurge:     'Volumen relativo',
  socialMomentum:  'Momentum social',
  trendMomentum:   'Tendencia de precio',
  marketCapTier:   'Tier de capitalizaciÃ³n',
  liquidityScore:  'Liquidez',
  volatilityRisk:  'Volatilidad',
  concentrationRisk:'ConcentraciÃ³n',
  drawdownRisk:    'Drawdown reciente',
  lowLiquidityRisk:'Riesgo de baja liquidez',
};

function renderPumpAssetDetail(asset) {
  const div = document.getElementById('pump-asset-detail-content');
  const p = asset.pumpAnalysis || {};
  const cl = asset.classification || {};
  const pumpColor = { red:'red', orange:'orange', green:'green' }[p.riskColor] || 'gray';

  // â”€â”€ FIX: leer correctamente la estructura anidada del breakdown â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // breakdown = { potential: { score, weighted, factors:{...} }, resistance: { score, weighted, factors:{...} }, indicators:{...} }
  const potFactors = asset.breakdown?.potential?.factors || {};
  const resFactors = asset.breakdown?.resistance?.factors || {};
  const potScore   = Math.round((asset.breakdown?.potential?.score  || 0) * 100);
  const resScore   = Math.round((asset.breakdown?.resistance?.score || 0) * 100);

  // Barra resumen: Potencial vs Resistencia
  const summaryBars = `
    <div class="mb-3">
      <div class="flex justify-between text-xs mb-1">
        <span class="text-green-400 font-semibold">â¬† Potencial</span>
        <span class="mono font-bold text-green-400">${potScore}%</span>
      </div>
      <div class="w-full bg-gray-700 rounded-full h-2.5">
        <div class="h-2.5 rounded-full ${potScore >= 70 ? 'bg-green-500' : potScore >= 40 ? 'bg-yellow-500' : 'bg-gray-500'}" style="width:${potScore}%"></div>
      </div>
    </div>
    <div class="mb-4">
      <div class="flex justify-between text-xs mb-1">
        <span class="text-red-400 font-semibold">â¬‡ Resistencia</span>
        <span class="mono font-bold text-red-400">${resScore}%</span>
      </div>
      <div class="w-full bg-gray-700 rounded-full h-2.5">
        <div class="h-2.5 rounded-full ${resScore >= 70 ? 'bg-red-500' : resScore >= 40 ? 'bg-orange-500' : 'bg-green-600'}" style="width:${resScore}%"></div>
      </div>
    </div>`;

  // Factores individuales de potencial
  const potBars = Object.entries(potFactors).map(([key, val]) => {
    const pct = Math.round((typeof val === 'number' ? val : 0) * 100);
    const barColor = pct >= 70 ? 'bg-green-500' : pct >= 40 ? 'bg-yellow-500' : 'bg-gray-600';
    return `<div class="mb-2">
      <div class="flex justify-between text-xs mb-0.5">
        <span class="text-gray-400">${FACTOR_LABELS[key] || key}</span>
        <span class="mono text-gray-300">${pct}%</span>
      </div>
      <div class="w-full bg-gray-700 rounded-full h-1.5">
        <div class="h-1.5 rounded-full ${barColor}" style="width:${pct}%"></div>
      </div>
    </div>`;
  }).join('');

  // Factores individuales de resistencia
  const resBars = Object.entries(resFactors).map(([key, val]) => {
    const pct = Math.round((typeof val === 'number' ? val : 0) * 100);
    const barColor = pct >= 70 ? 'bg-red-500' : pct >= 40 ? 'bg-orange-500' : 'bg-green-600';
    return `<div class="mb-2">
      <div class="flex justify-between text-xs mb-0.5">
        <span class="text-gray-400">${FACTOR_LABELS[key] || key}</span>
        <span class="mono text-gray-300">${pct}%</span>
      </div>
      <div class="w-full bg-gray-700 rounded-full h-1.5">
        <div class="h-1.5 rounded-full ${barColor}" style="width:${pct}%"></div>
      </div>
    </div>`;
  }).join('');

  const breakdownBars = summaryBars +
    (potBars ? `<p class="text-xs text-green-400 font-semibold mb-2 mt-1">Factores de Potencial</p>${potBars}` : '') +
    (resBars ? `<p class="text-xs text-red-400 font-semibold mb-2 mt-3">Factores de Resistencia</p>${resBars}` : '');

  // Breakdown del pump detector
  const pumpBreakdownBars = Object.entries(p.breakdown || {}).map(([key, val]) => {
    const pct = val.max > 0 ? Math.round(val.score / val.max * 100) : 0;
    const barColor = pct >= 80 ? 'bg-red-500' : pct >= 50 ? 'bg-orange-500' : 'bg-green-600';
    return `<div class="mb-2">
      <div class="flex justify-between text-xs mb-0.5">
        <span class="text-gray-400">${val.label}</span>
        <span class="mono font-medium">${val.score}/${val.max}</span>
      </div>
      <div class="w-full bg-gray-800 rounded-full h-1.5">
        <div class="h-1.5 rounded-full ${barColor}" style="width:${pct}%"></div>
      </div>
    </div>`;
  }).join('');

  div.innerHTML = `
    <div class="space-y-4">
      <!-- Header -->
      <div class="flex justify-between items-start">
        <div>
          <h3 class="text-2xl font-bold mb-1">${asset.name} <span class="text-gray-500 text-base">${asset.symbol?.toUpperCase()}</span></h3>
          <p class="text-sm text-gray-400">$${asset.current_price?.toFixed(6) || 'â€”'} Â· Cap: $${((asset.market_cap || 0)/1e6).toFixed(1)}M</p>
        </div>
        <div class="text-right">
          <p class="text-sm text-gray-500">Boost Power</p>
          <p class="text-3xl font-bold mono ${cl.color || 'text-gray-400'}">${asset.boostPowerPercent || 0}%</p>
        </div>
      </div>

      <!-- ClasificaciÃ³n + PredicciÃ³n -->
      <div class="grid grid-cols-2 gap-3">
        <div class="bg-gray-800 rounded-lg p-3">
          <p class="text-xs text-gray-500 mb-1">ClasificaciÃ³n</p>
          <p class="text-lg font-bold ${cl.color || 'text-gray-400'}">${cl.emoji || ''} ${cl.category || 'N/A'}</p>
        </div>
        <div class="bg-gray-800 rounded-lg p-3">
          <p class="text-xs text-gray-500 mb-1">PredicciÃ³n 12h</p>
          <p class="text-lg font-bold ${(asset.predictedChange || 0) > 0 ? 'text-green-400' : 'text-red-400'}">
            ${(asset.predictedChange || 0) > 0 ? '+' : ''}${(asset.predictedChange || 0).toFixed(1)}%
          </p>
        </div>
      </div>

      <!-- AnÃ¡lisis de Pump -->
      <div class="bg-${pumpColor}-950/30 border border-${pumpColor}-800 rounded-xl p-4">
        <div class="flex justify-between items-center mb-3">
          <h4 class="font-semibold text-${pumpColor}-400">ğŸš¨ AnÃ¡lisis de Pump Coordinado</h4>
          <div class="text-right">
            <p class="text-2xl font-bold mono text-${pumpColor}-400">${p.totalScore || 0}/10</p>
            <p class="text-xs text-gray-500">${p.riskEmoji || ''} ${p.riskLevel || 'Normal'}</p>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-2">
          ${pumpBreakdownBars}
        </div>
      </div>

      <!-- Breakdown algoritmo principal -->
      <div class="bg-gray-800 rounded-xl p-4">
        <h4 class="font-semibold text-blue-400 mb-3">ğŸ“Š Factores del Algoritmo</h4>
        ${breakdownBars}
      </div>

      <!-- Noticias -->
      ${asset.news?.count > 0 ? `
        <div class="bg-gray-800 rounded-xl p-4">
          <h4 class="font-semibold text-gray-300 mb-2">ğŸ“° Noticias (${asset.news.count})</h4>
          <p class="text-xs text-gray-500 mb-3">EspecÃ­ficas: ${asset.news.specificCount} Â· GenÃ©ricas: ${asset.news.genericCount} Â· Sentimiento: ${(asset.news.avgSentiment * 100).toFixed(0)}%</p>
          <div class="space-y-2">
            ${(asset.news.articles || []).slice(0, 5).map(a => `
              <div class="bg-gray-900 rounded p-2">
                <p class="text-xs text-white mb-0.5">${a.title}</p>
                <p class="text-xs text-gray-600">${a.source || 'â€”'} Â· ${new Date(a.publishedAt).toLocaleDateString('es-ES')}</p>
              </div>
            `).join('')}
          </div>
        </div>` : ''}

      <!-- Botones de acciÃ³n -->
      <div class="flex gap-3">
        <button onclick="addPumpAssetToCycleFromDetail()" class="flex-1 bg-gray-700 hover:bg-gray-600 py-3 rounded-lg font-semibold">
          â• AÃ±adir a ciclo
        </button>
        <button onclick="openPumpBuyModal(currentPumpAssetDetail.id, currentPumpAssetDetail.symbol, currentPumpAssetDetail.current_price, currentPumpAssetDetail)" class="flex-1 bg-emerald-700 hover:bg-emerald-600 py-3 rounded-lg font-bold text-lg">
          ğŸ’° Comprar ahora
        </button>
      </div>
    </div>
  `;
}

async function addPumpAssetToCycle(assetId, symbol, preloadedAsset) {
  if (!confirm(`Â¿AÃ±adir ${symbol} a un ciclo especulativo?\n\nSe aÃ±adirÃ¡ al ciclo activo o se crearÃ¡ uno nuevo de 12h.`)) return;
  try {
    const body = { assetId, mode: 'speculative' };
    // Si tenemos los datos ya cargados, los enviamos para evitar un re-fetch a CoinGecko
    if (preloadedAsset) body.assetData = preloadedAsset;

    const r = await fetch('/api/cycles/add-asset', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(body)
    });
    const d = await r.json();
    if (d.success) {
      alert(`âœ… ${d.message}`);
      if (d.newCycle) {
        if (document.getElementById('content-validation').style.display !== 'none') {
          await loadValidation();
        }
      }
    } else {
      alert(`âŒ ${d.error}`);
    }
  } catch(e) {
    alert('âŒ Error: ' + e.message);
  }
}

async function addPumpAssetToCycleFromDetail() {
  if (!currentPumpAssetDetail) return;
  // Pasamos el objeto completo para que el backend no tenga que re-fetchear CoinGecko
  await addPumpAssetToCycle(currentPumpAssetDetail.id, currentPumpAssetDetail.symbol, currentPumpAssetDetail);
  closeModal('modal-pump-asset-detail');
}


async function addPumpAssetToCycleFromDetail() {
  if (!currentPumpAssetDetail) return;
  // Pasamos el objeto completo para que el backend no tenga que re-fetchear CoinGecko
  await addPumpAssetToCycle(currentPumpAssetDetail.id, currentPumpAssetDetail.symbol, currentPumpAssetDetail);
  closeModal('modal-pump-asset-detail');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COMPRA MANUAL DESDE DETECTOR DE PUMP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let _pumpBuyAsset = null;

async function openPumpBuyModal(assetId, symbol, price, preloadedAsset) {
  // Prioridad: datos precargados > cachÃ© de detalle > mapa de detecciones > mÃ­nimo construido
  const fromDetectionMap = pumpDetectionMap[assetId];
  _pumpBuyAsset = preloadedAsset
    || pumpAssetCache[assetId]?.data
    || (fromDetectionMap ? {
        id:            fromDetectionMap.assetId,
        symbol:        fromDetectionMap.symbol,
        name:          fromDetectionMap.name || fromDetectionMap.symbol,
        current_price: fromDetectionMap.current_price || parseFloat(price) || 0,
        market_cap:    fromDetectionMap.market_cap || 0,
        boostPower:    0,
        boostPowerPercent: 0,
        predictedChange: 0,
        classification: 'PUMP',
       } : null)
    // Ãšltimo recurso: construir objeto mÃ­nimo con los parÃ¡metros del onclick
    || { id: assetId, symbol, name: symbol, current_price: parseFloat(price) || 0, classification: 'PUMP' };

  let cfg = null;
  try {
    const r = await fetch('/api/invest/config');
    const d = await r.json();
    if (d.success) cfg = d.config;
  } catch(_) {}

  const capitalTotal    = cfg?.capitalTotal    || 1000;
  const capitalPerCycle = cfg?.capitalPerCycle || 0.30;
  const maxPositions    = cfg?.maxPositions    || 3;
  const tpPct           = cfg?.takeProfitPct   || 10;
  const slPct           = cfg?.stopLossPct     || 5;
  const feePct          = cfg?.feePct          || 0.10;
  const mode            = cfg?.mode            || 'simulated';
  const defaultCapital  = parseFloat((capitalTotal * capitalPerCycle / maxPositions).toFixed(2));
  const currentPrice    = parseFloat(price) || _pumpBuyAsset?.current_price || 0;
  const tpPrice         = currentPrice > 0 ? (currentPrice * (1 + tpPct / 100)).toFixed(8) : 'â€”';
  const slPrice         = currentPrice > 0 ? (currentPrice * (1 - slPct / 100)).toFixed(8) : 'â€”';
  const symUpper        = (symbol || '').toUpperCase();

  const modeBadge = mode === 'simulated'
    ? '<span class="pill bg-blue-950 text-blue-400">âš—ï¸ SIMULADO</span>'
    : mode === 'testnet'
      ? '<span class="pill bg-yellow-950 text-yellow-400">ğŸ§ª TESTNET</span>'
      : '<span class="pill bg-red-950 text-red-400">ğŸ’µ REAL</span>';

  document.getElementById('pump-buy-modal-body').innerHTML = `
    <div class="space-y-4">
      <div class="flex justify-between items-center pb-3 border-b border-gray-800">
        <div>
          <p class="text-xl font-bold">${_pumpBuyAsset?.name || symUpper} <span class="text-gray-500 text-base">${symUpper}</span></p>
          <p class="text-sm text-gray-400 mono">Precio: <span class="text-white font-semibold">$${currentPrice < 0.01 ? currentPrice.toFixed(8) : currentPrice.toFixed(4)}</span></p>
        </div>
        <div>${modeBadge}</div>
      </div>

      <div>
        <label class="block text-xs text-gray-400 mb-1">Capital a invertir (USD)</label>
        <div class="flex gap-2 items-center">
          <input id="pump-buy-capital" type="number" min="1" step="1" value="${defaultCapital}"
            class="flex-1 bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white mono text-sm focus:border-emerald-500 focus:outline-none"
            oninput="updatePumpBuyPreview(${currentPrice}, ${tpPct}, ${slPct}, ${feePct})" />
          <span class="text-gray-500 text-sm">USD</span>
        </div>
        <p class="text-xs text-gray-500 mt-1">Capital por defecto: ${capitalPerCycle*100}% del total Ã· ${maxPositions} posiciones</p>
      </div>

      <div class="bg-gray-800 rounded-xl p-4 space-y-2 text-sm">
        <div class="flex justify-between">
          <span class="text-gray-400">Unidades estimadas</span>
          <span id="pbp-units" class="mono text-white font-semibold">${currentPrice > 0 ? (defaultCapital / currentPrice).toFixed(6) : 'â€”'}</span>
        </div>
        <div class="flex justify-between">
          <span class="text-green-400">ğŸ¯ Take Profit (+${tpPct}%)</span>
          <span id="pbp-tp" class="mono text-green-400 font-semibold">$${tpPrice}</span>
        </div>
        <div class="flex justify-between">
          <span class="text-red-400">ğŸ›‘ Stop Loss (-${slPct}%)</span>
          <span id="pbp-sl" class="mono text-red-400 font-semibold">$${slPrice}</span>
        </div>
        <div class="flex justify-between border-t border-gray-700 pt-2">
          <span class="text-gray-400">ComisiÃ³n estimada (${feePct.toFixed(2)}%)</span>
          <span id="pbp-fee" class="mono text-gray-400">$${(defaultCapital * feePct / 100).toFixed(4)}</span>
        </div>
      </div>

      ${mode === 'real' ? `
        <div class="bg-red-950 border border-red-700 rounded-lg p-3">
          <p class="text-red-300 text-xs font-semibold">âš ï¸ MODO REAL â€” Esto ejecutarÃ¡ una orden real con dinero real en el exchange.</p>
        </div>` : ''}

      <div class="flex gap-3 pt-2">
        <button onclick="closeModal('modal-pump-buy')" class="flex-1 bg-gray-800 hover:bg-gray-700 py-3 rounded-lg font-semibold">
          Cancelar
        </button>
        <button id="pump-buy-confirm-btn" onclick="confirmPumpBuy('${assetId}')"
          class="flex-1 ${mode === 'real' ? 'bg-red-700 hover:bg-red-600' : 'bg-emerald-700 hover:bg-emerald-600'} py-3 rounded-lg font-bold text-lg transition-colors">
          ğŸ’° Confirmar ${mode === 'real' ? 'orden REAL' : 'compra'}
        </button>
      </div>
      <div id="pump-buy-result" class="text-center text-sm mt-1 min-h-5"></div>
    </div>`;

  showModal('modal-pump-buy');
}

function updatePumpBuyPreview(price, tpPct, slPct, feePct) {
  const capital = parseFloat(document.getElementById('pump-buy-capital')?.value || 0);
  if (!capital || !price) return;
  const u = document.getElementById('pbp-units'); if(u) u.textContent = (capital / price).toFixed(6);
  const t = document.getElementById('pbp-tp');    if(t) t.textContent = `$${(price * (1 + tpPct / 100)).toFixed(8)}`;
  const s = document.getElementById('pbp-sl');    if(s) s.textContent = `$${(price * (1 - slPct / 100)).toFixed(8)}`;
  const f = document.getElementById('pbp-fee');   if(f) f.textContent = `$${(capital * feePct / 100).toFixed(4)}`;
}

async function confirmPumpBuy(assetId) {
  const capitalUSD = parseFloat(document.getElementById('pump-buy-capital')?.value || 0);
  const resultDiv  = document.getElementById('pump-buy-result');
  if (!capitalUSD || capitalUSD < 1) {
    resultDiv.innerHTML = '<span class="text-red-400">âŒ Capital mÃ­nimo $1</span>';
    return;
  }
  // _pumpBuyAsset siempre tiene id y symbol garantizados desde openPumpBuyModal
  const assetData = { ...(_pumpBuyAsset || {}) };
  assetData.id     = assetData.id     || assetData.assetId || assetId;
  assetData.symbol = assetData.symbol || assetId;

  resultDiv.innerHTML = '<span class="text-blue-400">â³ Enviando orden...</span>';
  document.querySelectorAll('#modal-pump-buy button').forEach(b => b.disabled = true);

  try {
    const r = await fetch('/api/invest/buy-manual', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ assetData, capitalUSD })
    });
    const d = await r.json();
    if (d.success) {
      resultDiv.innerHTML = `<span class="text-emerald-400 font-semibold">âœ… ${d.message}</span>`;
      setTimeout(() => {
        closeModal('modal-pump-buy');
        closeModal('modal-pump-asset-detail');
        if (document.getElementById('content-invest')?.style.display !== 'none') loadInvestData();
      }, 2200);
    } else {
      resultDiv.innerHTML = `<span class="text-red-400">âŒ ${d.error}</span>`;
      document.querySelectorAll('#modal-pump-buy button').forEach(b => b.disabled = false);
    }
  } catch(e) {
    resultDiv.innerHTML = `<span class="text-red-400">âŒ ${e.message}</span>`;
    document.querySelectorAll('#modal-pump-buy button').forEach(b => b.disabled = false);
  }
}



let selectedCyclesForInsights = [];
let currentInsightsResult = null;

async function openInsightsModal() {
  showModal('modal-insights');
  selectedCyclesForInsights = [];
  document.getElementById('btn-run-insights').disabled = true;
  
  // Verificar estado de APIs
  try {
    const r = await fetch('/api/insights/keys-status');
    const d = await r.json();
    const statusDiv = document.getElementById('insights-api-status');
    if (d.success) {
      const ALL_LLM_AGENTS = [
        { key: 'gemini',   icon: 'ğŸ”·', label: 'Gemini',   tier: 'PAID' },
        { key: 'claude',   icon: 'ğŸŸ£', label: 'Claude',   tier: 'PAID' },
        { key: 'openai',   icon: 'ğŸŸ¢', label: 'GPT-4',    tier: 'PAID' },
        { key: 'groq',     icon: 'ğŸŸ ', label: 'Llama',    tier: 'FREE' },
        { key: 'mistral',  icon: 'ğŸ”µ', label: 'Mistral',  tier: 'FREE' },
        { key: 'cohere',   icon: 'ğŸŸ¤', label: 'Cohere',   tier: 'FREE' },
        { key: 'cerebras', icon: 'âš¡', label: 'Cerebras', tier: 'FREE' },
      ];
      const total = d.total || 7;
      const configured = d.configured || 0;
      const badges = ALL_LLM_AGENTS.map(a =>
        `<span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-semibold ${d.keys[a.key] ? 'bg-green-900 text-green-300' : 'bg-gray-800 text-gray-500'}">
          ${a.icon} ${a.label}${d.keys[a.key] ? ' âœ“' : ''}
        </span>`
      ).join('');
      statusDiv.innerHTML = `
        <div class="flex items-center justify-between mb-2">
          <span class="font-semibold text-sm ${configured >= 2 ? 'text-green-400' : 'text-yellow-400'}">
            ${configured >= 2 ? 'âœ…' : 'âš ï¸'} ${configured}/${total} agentes configurados
          </span>
          ${configured < 2 ? '<span class="text-xs text-yellow-400">Se necesitan al menos 2 para consenso</span>' : `<span class="text-xs text-green-400">Listo para generar consenso</span>`}
        </div>
        <div class="flex flex-wrap gap-1.5">${badges}</div>
        ${configured < 2 ? '<p class="text-xs text-yellow-500 mt-2">â†’ Ve a la pestaÃ±a Config â†’ APIs para aÃ±adir keys gratuitas (Mistral, Cohere, Cerebras)</p>' : ''}
      `;
    }
  } catch(e) {
    console.error('Error verificando APIs:', e);
  }
  
  // Cargar ciclos significativos del modo actual
  await loadInsightsCycles();
}

async function loadInsightsCycles() {
  const div = document.getElementById('insights-cycles-list');
  try {
    const r = await fetch(`/api/cycles/history?mode=${currentMode}`);
    const d = await r.json();
    if (!d.success || d.cycles.length === 0) {
      div.innerHTML = '<p class="text-gray-500 text-sm">Sin ciclos completados en este modo.</p>';
      return;
    }
    
    // Filtrar solo significativos (â‰¥6h)
    const significant = d.cycles.filter(c => (c.durationMs || 0) >= 21600000);
    if (significant.length === 0) {
      div.innerHTML = '<p class="text-gray-500 text-sm">Sin ciclos significativos (â‰¥6h) en este modo.</p>';
      return;
    }
    
    div.innerHTML = '<div class="space-y-2"></div>';
    const container = div.querySelector('div');
    
    significant.slice(0, 20).forEach(c => {
      const card = document.createElement('div');
      card.className = 'bg-gray-900 border border-gray-700 rounded-lg p-3 cursor-pointer hover:border-purple-600 transition-colors';
      card.innerHTML = `
        <div class="flex items-center gap-3">
          <input type="checkbox" id="cycle-${c.id}" class="w-4 h-4" onchange="toggleCycleSelection('${c.id}')">
          <label for="cycle-${c.id}" class="flex-1 cursor-pointer text-sm">
            <div class="flex justify-between items-center">
              <span class="font-semibold">${new Date(c.completedAt).toLocaleDateString('es-ES')} ${new Date(c.completedAt).toLocaleTimeString('es-ES', {hour:'2-digit',minute:'2-digit'})}</span>
              <div class="flex items-center gap-2">
                <span class="text-xs text-gray-500">${c.snapshot?.length || 0} activos</span>
                <span class="text-xs font-bold ${parseFloat(c.metrics?.successRate || 0) > 60 ? 'text-green-400' : parseFloat(c.metrics?.successRate || 0) > 40 ? 'text-yellow-400' : 'text-red-400'}">${c.metrics?.successRate || '0'}%</span>
              </div>
            </div>
            <p class="text-xs text-gray-600 mt-0.5">${fmtDur(c.durationMs || 0)} Â· ${c.metrics?.correct || 0}/${c.metrics?.total || 0} correctas</p>
          </label>
        </div>
      `;
      container.appendChild(card);
    });
    
  } catch(e) {
    div.innerHTML = `<p class="text-red-400 text-sm">Error: ${e.message}</p>`;
  }
}

function toggleCycleSelection(cycleId) {
  const checkbox = document.getElementById('cycle-' + cycleId);
  if (checkbox.checked) {
    if (!selectedCyclesForInsights.includes(cycleId)) {
      selectedCyclesForInsights.push(cycleId);
    }
  } else {
    selectedCyclesForInsights = selectedCyclesForInsights.filter(id => id !== cycleId);
  }
  
  // Habilitar botÃ³n si hay al menos 1 ciclo seleccionado
  document.getElementById('btn-run-insights').disabled = selectedCyclesForInsights.length === 0;
}

async function runInsightsAnalysis() {
  if (selectedCyclesForInsights.length === 0) {
    alert('Selecciona al menos 1 ciclo para analizar');
    return;
  }
  
  const btn = document.getElementById('btn-run-insights');
  const originalText = btn.textContent;
  btn.disabled = true;
  btn.textContent = 'â³ Analizando con LLMs... (30-60s)';
  
  const resultDiv = document.getElementById('insights-modal-result');
  resultDiv.classList.remove('hidden');
  resultDiv.innerHTML = `
    <div class="bg-gray-800 border border-purple-700 rounded-xl p-6 text-center">
      <p class="text-purple-400 text-lg font-semibold mb-2">ğŸ§  Consultando a los agentes IA...</p>
      <p class="text-xs text-gray-500">Gemini Â· Claude Â· GPT-4 Â· Llama</p>
      <div class="mt-4">
        <div class="animate-pulse flex justify-center gap-2">
          <div class="h-3 w-3 bg-purple-500 rounded-full"></div>
          <div class="h-3 w-3 bg-purple-500 rounded-full animation-delay-200"></div>
          <div class="h-3 w-3 bg-purple-500 rounded-full animation-delay-400"></div>
        </div>
      </div>
      <p class="text-xs text-gray-600 mt-3">Esto puede tardar 30-60 segundos...</p>
    </div>
  `;
  
  try {
    const r = await fetch('/api/insights/analyze', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ cycleIds: selectedCyclesForInsights, mode: currentMode })
    });
    
    const d = await r.json();
    if (!d.success) throw new Error(d.error);
    
    currentInsightsResult = d;
    renderInsightsResult(d);
    
  } catch(e) {
    resultDiv.innerHTML = `<div class="bg-red-950 border border-red-800 rounded-xl p-4">
      <p class="text-red-400 font-semibold">âŒ Error en el anÃ¡lisis</p>
      <p class="text-xs text-gray-400 mt-1">${e.message}</p>
    </div>`;
  } finally {
    btn.disabled = false;
    btn.textContent = originalText;
  }
}

// CatÃ¡logo completo de agentes â€” mismo orden que el backend
const LLM_AGENTS_CATALOG = [
  { key: 'gemini',   icon: 'ğŸ”·', name: 'Google Gemini',         tier: 'PAID', tierCss: 'bg-blue-900 text-blue-300' },
  { key: 'claude',   icon: 'ğŸŸ£', name: 'Anthropic Claude',      tier: 'PAID', tierCss: 'bg-purple-900 text-purple-300' },
  { key: 'openai',   icon: 'ğŸŸ¢', name: 'OpenAI GPT-4',          tier: 'PAID', tierCss: 'bg-green-900 text-green-300' },
  { key: 'llama',    icon: 'ğŸŸ ', name: 'Groq Llama',            tier: 'FREE', tierCss: 'bg-orange-900 text-orange-300' },
  { key: 'mistral',  icon: 'ğŸ”µ', name: 'Mistral AI',            tier: 'FREE', tierCss: 'bg-sky-900 text-sky-300' },
  { key: 'cohere',   icon: 'ğŸŸ¤', name: 'Cohere Command-R',      tier: 'FREE', tierCss: 'bg-amber-900 text-amber-300' },
  { key: 'cerebras', icon: 'âš¡', name: 'Cerebras Llama',        tier: 'FREE', tierCss: 'bg-cyan-900 text-cyan-300' },
];

function renderInsightsResult(data) {
  const div = document.getElementById('insights-modal-result');
  const responses = data.responses || {};
  const consensus = data.consensus || {};

  const successful = LLM_AGENTS_CATALOG.filter(a => responses[a.key]?.success);
  const failed     = LLM_AGENTS_CATALOG.filter(a => responses[a.key] && !responses[a.key].success);
  const notQueried = LLM_AGENTS_CATALOG.filter(a => !responses[a.key]);
  const totalAgents = LLM_AGENTS_CATALOG.length;

  // â”€â”€ Cabecera â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let html = `
    <div class="bg-gray-800 border border-purple-700 rounded-xl overflow-hidden">
      <!-- Header -->
      <div class="bg-gray-900 border-b border-gray-700 px-6 py-4 flex flex-wrap items-center justify-between gap-2">
        <div>
          <h4 class="text-lg font-bold text-purple-400">ğŸ“Š Los ${successful.length} Sabios â€” Resultados del AnÃ¡lisis</h4>
          <p class="text-xs text-gray-400 mt-0.5">${data.cyclesAnalyzed} ciclo(s) analizados Â· ${successful.length} de ${totalAgents} agentes respondieron Â· ${failed.length} fallidos Â· ${notQueried.length} sin key</p>
        </div>
        ${consensus.hasConsensus ? `
          <button onclick="applyInsightsConsensus()"
            class="bg-green-700 hover:bg-green-600 px-4 py-2 rounded-lg text-sm font-bold whitespace-nowrap">
            âœ“ Aplicar consenso al algoritmo
          </button>` : ''}
      </div>

      <div class="p-6 space-y-6">
  `;

  // â”€â”€ Respuestas individuales de cada agente â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  html += `<div>
    <h5 class="text-sm font-bold text-gray-300 mb-3 flex items-center gap-2">
      ğŸ¤– Respuesta de cada agente IA
      <span class="text-xs text-gray-500 font-normal">â€” conclusiÃ³n completa y razonamiento</span>
    </h5>
    <div class="space-y-3">`;

  LLM_AGENTS_CATALOG.forEach(agent => {
    const r = responses[agent.key];

    if (!r) {
      // No consultado (sin key)
      html += `
        <div class="bg-gray-900 border border-gray-800 rounded-xl p-4 opacity-40">
          <div class="flex items-center gap-2 mb-1">
            <span class="text-base">${agent.icon}</span>
            <span class="font-semibold text-sm text-gray-400">${agent.name}</span>
            <span class="text-xs px-1.5 py-0.5 rounded ${agent.tierCss}">${agent.tier}</span>
            <span class="ml-auto text-xs text-gray-600 bg-gray-800 px-2 py-0.5 rounded-full">âšª Sin key configurada</span>
          </div>
        </div>`;
      return;
    }

    if (!r.success) {
      html += `
        <div class="bg-red-950/20 border border-red-900/50 rounded-xl p-4">
          <div class="flex items-center gap-2 mb-1">
            <span class="text-base">${agent.icon}</span>
            <span class="font-semibold text-sm">${agent.name}</span>
            <span class="text-xs px-1.5 py-0.5 rounded ${agent.tierCss}">${agent.tier}</span>
            <span class="ml-auto text-xs text-red-400 bg-red-950 px-2 py-0.5 rounded-full">âœ— Error</span>
          </div>
          <p class="text-xs text-red-400 mt-1 ml-7">${r.error || 'Sin respuesta'}</p>
        </div>`;
      return;
    }

    // Respuesta exitosa â€” mostrar todo
    const modelUsed = r.modelUsed ? `<span class="text-xs text-gray-500 mono ml-1">(${r.modelUsed})</span>` : '';
    html += `
      <div class="bg-gray-900 border border-green-900/40 rounded-xl p-4">
        <div class="flex items-center gap-2 mb-3">
          <span class="text-base">${agent.icon}</span>
          <span class="font-semibold text-sm">${agent.name}</span>${modelUsed}
          <span class="text-xs px-1.5 py-0.5 rounded ${agent.tierCss}">${agent.tier}</span>
          <span class="ml-auto text-xs text-green-400 bg-green-950 px-2 py-0.5 rounded-full">âœ“ Exitoso</span>
        </div>

        ${r.assessment ? `
          <div class="mb-2">
            <p class="text-xs text-gray-500 uppercase tracking-wide mb-1 font-semibold">ğŸ“‹ EvaluaciÃ³n general</p>
            <p class="text-sm text-gray-200 leading-relaxed ml-1">${r.assessment}</p>
          </div>` : ''}

        ${r.reasoning ? `
          <div class="mb-2 border-t border-gray-800 pt-2 mt-2">
            <p class="text-xs text-gray-500 uppercase tracking-wide mb-1 font-semibold">ğŸ’¡ Razonamiento</p>
            <p class="text-sm text-gray-300 leading-relaxed ml-1">${r.reasoning}</p>
          </div>` : ''}

        ${r.expectedImpact ? `
          <div class="border-t border-gray-800 pt-2 mt-2">
            <p class="text-xs text-gray-500 uppercase tracking-wide mb-1 font-semibold">ğŸ“ˆ Impacto esperado</p>
            <p class="text-sm text-blue-300 ml-1">${r.expectedImpact}</p>
          </div>` : ''}
      </div>`;
  });

  html += `</div></div>`;  // cierre space-y-3 y div respuestas

  // â”€â”€ Bloque de consenso â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (consensus.hasConsensus) {
    const cats = [
      { key: 'metaWeights',       label: 'âš–ï¸ Meta-pesos',          color: 'blue',   desc: 'Potencial vs Resistencia' },
      { key: 'classification',    label: 'ğŸ·ï¸ ClasificaciÃ³n',       color: 'yellow', desc: 'Umbrales INVERTIBLE / APALANCADO' },
      { key: 'prediction',        label: 'ğŸ¯ PredicciÃ³n',          color: 'green',  desc: 'Target y tolerancia de magnitud' },
      { key: 'potentialWeights',  label: 'ğŸ“ˆ Factores Potencial',  color: 'purple', desc: 'ATL, Volume, Social, News, Rebound' },
      { key: 'resistanceWeights', label: 'ğŸ“‰ Factores Resistencia',color: 'red',    desc: 'Leverage, MCap, Volatility, Fear' },
    ];

    // ExplicaciÃ³n del cÃ¡lculo de consenso
    const modelNames = (consensus.modelNames || []).join(', ');
    const n = consensus.modelsUsed;

    html += `
      <div class="bg-green-950/20 border border-green-800 rounded-xl overflow-hidden">
        <div class="bg-green-950/40 px-5 py-3 border-b border-green-900">
          <h5 class="font-bold text-green-400 text-base">âœ¨ Consenso de ${n} agente${n > 1 ? 's' : ''}</h5>
          <p class="text-xs text-gray-400 mt-0.5">
            Participantes: <span class="text-green-300">${modelNames}</span>
          </p>
          <p class="text-xs text-gray-500 mt-1">
            MÃ©todo: media aritmÃ©tica de los valores sugeridos por cada agente para cada parÃ¡metro
            (solo se incluyen parÃ¡metros donde â‰¥2 agentes coincidieron en sugerir un valor).
          </p>
        </div>
        <div class="p-5">
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">`;

    cats.forEach(cat => {
      const adj = consensus.consensus?.[cat.key];
      if (!adj || Object.keys(adj).length === 0) return;
      html += `
        <div class="bg-gray-900 border border-${cat.color}-900/60 rounded-lg p-3">
          <p class="text-xs font-bold text-${cat.color}-400 mb-0.5">${cat.label}</p>
          <p class="text-xs text-gray-600 mb-2">${cat.desc}</p>
          <div class="space-y-1">`;
      Object.entries(adj).forEach(([k, v]) => {
        const display = typeof v === 'number' && v <= 1 && v > 0
          ? `${(v * 100).toFixed(0)}% <span class="text-gray-600">(${v})</span>`
          : `<span class="font-bold">${v}</span>`;
        html += `<div class="flex justify-between items-center text-xs">
          <span class="text-gray-400 mono">${k}</span>
          <span class="text-white font-bold ml-2">${display}</span>
        </div>`;
      });
      html += `</div></div>`;
    });

    html += `
          </div>

          <!-- Bloque de razonamientos del consenso -->
          <div class="mt-4 bg-gray-900 rounded-lg p-4 border border-gray-800">
            <p class="text-xs text-gray-500 uppercase tracking-wide font-semibold mb-2">ğŸ§  Â¿Por quÃ© estos ajustes?</p>
            <div class="space-y-2">`;

    // Mostrar el reasoning de cada agente exitoso como justificaciÃ³n del consenso
    LLM_AGENTS_CATALOG.forEach(agent => {
      const r = responses[agent.key];
      if (!r?.success || !r.reasoning) return;
      html += `
        <div class="text-xs leading-relaxed">
          <span class="font-semibold text-gray-300">${agent.icon} ${agent.name}:</span>
          <span class="text-gray-400 ml-1">${r.reasoning}</span>
        </div>`;
    });

    html += `
            </div>
          </div>

          <div class="mt-4 flex justify-end">
            <button onclick="applyInsightsConsensus()"
              class="bg-green-700 hover:bg-green-600 px-5 py-2.5 rounded-lg text-sm font-bold">
              âœ“ Aplicar este consenso al algoritmo
            </button>
          </div>
        </div>
      </div>`;

  } else {
    html += `
      <div class="bg-yellow-950/20 border border-yellow-800 rounded-xl p-4">
        <p class="text-yellow-400 font-semibold mb-1">âš ï¸ Consenso no alcanzado</p>
        <p class="text-sm text-gray-400">${consensus.message || 'Se necesitan al menos 2 agentes con respuesta exitosa para calcular el consenso.'}</p>
        ${successful.length === 1 ? `<p class="text-xs text-gray-500 mt-2">Solo respondiÃ³ 1 agente. Configura mÃ¡s modelos gratuitos (Mistral, Cohere, Cerebras) en la pestaÃ±a Config â†’ APIs.</p>` : ''}
        ${successful.length === 0 ? `<p class="text-xs text-gray-500 mt-2">NingÃºn agente respondiÃ³. Verifica que las API keys estÃ©n correctamente configuradas.</p>` : ''}
      </div>`;
  }

  html += `</div></div>`;  // cierre space-y-6 y div principal

  div.innerHTML = html;
  div.classList.remove('hidden');

  // TambiÃ©n actualizar la vista de la pestaÃ±a de anÃ¡lisis si existe
  const insightsResult = document.getElementById('insights-result');
  if (insightsResult) {
    insightsResult.classList.remove('hidden');
    insightsResult.innerHTML = html;
  }
}

async function applyInsightsConsensus() {
  if (!currentInsightsResult || !currentInsightsResult.consensus?.hasConsensus) {
    alert('No hay consenso disponible para aplicar');
    return;
  }
  
  if (!confirm(`Â¿Aplicar el consenso de ${currentInsightsResult.consensus.modelsUsed} modelos al algoritmo ${currentMode === 'speculative' ? 'Especulativo' : 'Generalista'}?\n\nEsto sobrescribirÃ¡ la configuraciÃ³n actual.`)) {
    return;
  }
  
  try {
    const r = await fetch('/api/insights/apply-consensus', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ 
        consensus: currentInsightsResult.consensus.consensus, 
        mode: currentMode 
      })
    });
    
    const d = await r.json();
    if (d.success) {
      config = d.applied;
      applyConfigToUI();
      buildFactorSliders();
      alert(`âœ… ${d.message}\n\nLa configuraciÃ³n ha sido actualizada. Puedes revisarla en la pestaÃ±a Config.`);
      closeModal('modal-insights');
    } else {
      alert('âŒ ' + d.error);
    }
  } catch(e) {
    alert('âŒ Error: ' + e.message);
  }
}

</script>

<!-- â•â• MODAL: DETALLE ACTIVO PUMP â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="modal-pump-asset-detail" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4 overflow-y-auto">
  <div class="bg-gray-900 rounded-2xl w-full max-w-4xl shadow-2xl my-8 max-h-[90vh] overflow-y-auto">
    <div class="sticky top-0 bg-gray-900 border-b border-gray-800 px-6 py-4 flex justify-between items-center">
      <h3 class="text-xl font-bold">ğŸ” AnÃ¡lisis Completo</h3>
      <button onclick="closeModal('modal-pump-asset-detail')" class="text-gray-500 hover:text-white text-2xl">Ã—</button>
    </div>
    <div class="p-6">
      <div id="pump-asset-detail-loading" class="text-center py-12">
        <p class="text-blue-400 text-lg">â³ Cargando anÃ¡lisis completo...</p>
        <p class="text-xs text-gray-500 mt-2">Obteniendo datos de mercado, noticias, redes sociales...</p>
      </div>
      <div id="pump-asset-detail-content" class="hidden">
        <!-- El contenido se renderiza dinÃ¡micamente -->
      </div>
    </div>
  </div>
</div>


<!-- â•â• MODAL: INSIGHTS CON LLMs â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="modal-insights" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4 overflow-y-auto">
  <div class="bg-gray-900 rounded-2xl w-full max-w-5xl shadow-2xl my-8">
    <div class="sticky top-0 bg-gray-900 border-b border-gray-800 px-6 py-4 flex justify-between items-center rounded-t-2xl">
      <h3 class="text-xl font-bold text-purple-400">ğŸ§  Los N Sabios â€” Consenso de Agentes IA</h3>
      <button onclick="closeModal('modal-insights')" class="text-gray-500 hover:text-white text-2xl">Ã—</button>
    </div>
    <div class="p-6">
      <!-- Estado de APIs -->
      <div id="insights-api-status" class="bg-gray-800 border border-gray-700 rounded-xl p-4 mb-4">
        <p class="text-sm text-gray-400 mb-2">â³ Verificando APIs configuradas...</p>
      </div>

      <!-- Selector de ciclos -->
      <div class="mb-5">
        <h4 class="text-sm font-semibold text-gray-300 mb-2">Selecciona ciclos significativos (â‰¥6h)</h4>
        <div id="insights-cycles-list" class="bg-gray-800 border border-gray-700 rounded-xl p-4 max-h-64 overflow-y-auto">
          <p class="text-gray-500 text-sm">Cargando ciclos...</p>
        </div>
      </div>

      <!-- Botones -->
      <div class="flex gap-3">
        <button onclick="runInsightsAnalysis()" id="btn-run-insights" class="flex-1 bg-purple-700 hover:bg-purple-600 px-6 py-3 rounded-lg font-bold" disabled>
          ğŸš€ Analizar con LLMs (30-60s)
        </button>
        <button onclick="closeModal('modal-insights')" class="bg-gray-700 hover:bg-gray-600 px-6 py-3 rounded-lg font-semibold">
          Cancelar
        </button>
      </div>

      <!-- Resultado del anÃ¡lisis -->
      <div id="insights-modal-result" class="hidden mt-6">
        <!-- Se renderiza aquÃ­ -->
      </div>
    </div>
  </div>
</div>

  <script src="/patch-llm-keys.js"></script>
  <script src="/patch-pump-sources.js"></script>
  <script src="/patch-analysis-categories.js"></script>
  <script src="/patch-cycles-history.js"></script>
  <script src="/patch-pump-duration.js"></script>
  <script src="/patch-scheduler-sync.js"></script>
  <script src="/patch-price-status.js"></script>
  <script src="/patch-scenario-analysis.js"></script>
  <script src="/patch-performance-v2.js"></script>
  <script src="/patch-status-bar.js"></script>
  <script src="/patch-rounds-v3.js"></script>
  <script src="/patch-decide-priority.js"></script>
  <script src="/patch-fix-orphaned-positions.js"></script>
  <script src="/patch-round-verbose.js"></script>

<!-- â•â• MODAL: COMPRA MANUAL DESDE DETECTOR PUMP â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="modal-pump-buy" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
  <div class="bg-gray-900 rounded-2xl w-full max-w-lg shadow-2xl">
    <div class="flex justify-between items-center px-6 py-4 border-b border-gray-800">
      <h3 class="text-lg font-bold">ğŸ’° Orden de Compra</h3>
      <button onclick="closeModal('modal-pump-buy')" class="text-gray-500 hover:text-white text-2xl leading-none">Ã—</button>
    </div>
    <div class="p-6" id="pump-buy-modal-body">
      <p class="text-gray-400 text-sm">Cargando configuraciÃ³n...</p>
    </div>
  </div>
</div>

</body>
</html>
