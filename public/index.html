<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Detector v3.1 - Iteraci√≥n 3</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white">
    <div class="container mx-auto p-6 max-w-7xl">
        <div class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-4xl font-bold">üöÄ Crypto Detector v3.1</h1>
                <p class="text-gray-400">Iter 3: Datos Reales + Ciclos + Validaci√≥n</p>
            </div>
            <div id="external-data" class="text-sm text-right"></div>
        </div>
        
        <!-- Tabs -->
        <div class="flex gap-2 mb-6 border-b border-gray-700">
            <button onclick="setTab('monitor')" id="tab-monitor" class="px-4 py-2 rounded-t-lg bg-blue-600">
                üìä Monitor
            </button>
            <button onclick="setTab('config')" id="tab-config" class="px-4 py-2 rounded-t-lg bg-gray-700">
                ‚öôÔ∏è Config
            </button>
            <button onclick="setTab('validation')" id="tab-validation" class="px-4 py-2 rounded-t-lg bg-gray-700">
                ‚úÖ Validaci√≥n
            </button>
        </div>
        
        <!-- Tab Monitor -->
        <div id="content-monitor" class="tab-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold">Monitor en Tiempo Real</h2>
                <div class="flex gap-3">
                    <button onclick="loadCryptos()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg">
                        üîÑ Cargar
                    </button>
                    <button onclick="startCycle()" id="btn-start-cycle" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg font-semibold">
                        ‚è∞ Iniciar Ciclo 12h
                    </button>
                </div>
            </div>
            
            <div id="stats" class="grid grid-cols-4 gap-4 mb-4"></div>
            <div id="crypto-list" class="space-y-3"></div>
        </div>
        
        <!-- Tab Config (simplificado de Iter 2) -->
        <div id="content-config" class="tab-content" style="display:none">
            <h2 class="text-2xl font-semibold mb-4">Configuraci√≥n</h2>
            <div class="bg-gray-800 rounded-lg p-6 mb-4">
                <h3 class="text-lg font-semibold mb-3">Meta-Pesos</h3>
                <div class="mb-3">
                    <label class="block text-sm mb-2">
                        Cuantitativo: <span id="meta-quant-val">60</span>%
                    </label>
                    <input type="range" id="meta-quant" min="0" max="100" step="5" value="60" 
                           onchange="updateMetaWeights()" class="w-full"/>
                </div>
            </div>
            
            <div class="bg-gray-800 rounded-lg p-6 mb-4">
                <h3 class="text-lg font-semibold mb-3">Pesos de Factores</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <h4 class="text-green-400 mb-2">Cuantitativos</h4>
                        <div id="quant-factors"></div>
                    </div>
                    <div>
                        <h4 class="text-purple-400 mb-2">Cualitativos</h4>
                        <div id="qual-factors"></div>
                    </div>
                </div>
            </div>
            
            <button onclick="saveConfig()" class="bg-green-600 hover:bg-green-700 px-6 py-2 rounded-lg">
                üíæ Guardar
            </button>
            <div id="config-message" class="mt-3"></div>
        </div>
        
        <!-- Tab Validaci√≥n -->
        <div id="content-validation" class="tab-content" style="display:none">
            <h2 class="text-2xl font-semibold mb-4">Validaci√≥n de Ciclos</h2>
            
            <!-- Ciclos Activos -->
            <div class="mb-6">
                <h3 class="text-xl font-semibold mb-3">üîÑ Ciclos Activos</h3>
                <div id="active-cycles"></div>
            </div>
            
            <!-- Ciclos Completados -->
            <div>
                <h3 class="text-xl font-semibold mb-3">‚úÖ Historial de Ciclos</h3>
                <div id="completed-cycles"></div>
            </div>
            
            <!-- Estad√≠sticas Globales -->
            <div class="mt-6">
                <h3 class="text-xl font-semibold mb-3">üìä Estad√≠sticas Globales</h3>
                <div id="global-stats"></div>
            </div>
        </div>
    </div>

    <script>
        let config = null;
        let metadata = null;
        let currentCryptos = [];
        
        // Init
        async function init() {
            await loadMetadata();
            await loadConfig();
            renderFactorControls();
            await loadValidation();
        }
        
        async function loadMetadata() {
            try {
                const res = await fetch('/api/config/metadata');
                const data = await res.json();
                if (data.success) metadata = data.metadata;
            } catch (err) {}
        }
        
        async function loadConfig() {
            try {
                const res = await fetch('/api/config');
                const data = await res.json();
                if (data.success) {
                    config = data.config;
                    updateUIFromConfig();
                }
            } catch (err) {}
        }
        
        function updateUIFromConfig() {
            if (!config) return;
            const quantPercent = Math.round(config.metaWeights.quantitative * 100);
            document.getElementById('meta-quant').value = quantPercent;
            document.getElementById('meta-quant-val').textContent = quantPercent;
        }
        
        function renderFactorControls() {
            if (!metadata || !config) return;
            
            const quantDiv = document.getElementById('quant-factors');
            quantDiv.innerHTML = '';
            metadata.quantitative.forEach(factor => {
                const weight = Math.round((config.factorWeights[factor.id] || 0) * 100);
                quantDiv.innerHTML += `
                    <div class="mb-2">
                        <label class="block text-xs">${factor.name}: <span id="fw-${factor.id}">${weight}</span>%</label>
                        <input type="range" id="factor-${factor.id}" min="0" max="30" value="${weight}" 
                               onchange="updateFactorWeight('${factor.id}')" class="w-full"/>
                    </div>
                `;
            });
            
            const qualDiv = document.getElementById('qual-factors');
            qualDiv.innerHTML = '';
            metadata.qualitative.forEach(factor => {
                const weight = Math.round((config.factorWeights[factor.id] || 0) * 100);
                qualDiv.innerHTML += `
                    <div class="mb-2">
                        <label class="block text-xs">${factor.name}: <span id="fw-${factor.id}">${weight}</span>%</label>
                        <input type="range" id="factor-${factor.id}" min="0" max="30" value="${weight}" 
                               onchange="updateFactorWeight('${factor.id}')" class="w-full"/>
                    </div>
                `;
            });
        }
        
        function updateMetaWeights() {
            const quant = parseInt(document.getElementById('meta-quant').value);
            document.getElementById('meta-quant-val').textContent = quant;
            config.metaWeights.quantitative = quant / 100;
            config.metaWeights.qualitative = (100 - quant) / 100;
        }
        
        function updateFactorWeight(factorId) {
            const value = parseInt(document.getElementById(`factor-${factorId}`).value);
            document.getElementById(`fw-${factorId}`).textContent = value;
            config.factorWeights[factorId] = value / 100;
        }
        
        async function saveConfig() {
            const msgDiv = document.getElementById('config-message');
            msgDiv.innerHTML = '<div class="text-gray-400">üíæ Guardando...</div>';
            
            try {
                const res = await fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ config })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    msgDiv.innerHTML = '<div class="text-green-400 p-3 bg-green-900/30 rounded">‚úÖ Guardado</div>';
                } else {
                    msgDiv.innerHTML = '<div class="text-red-400 p-3 bg-red-900/30 rounded">‚ùå Error</div>';
                }
                
                setTimeout(() => msgDiv.innerHTML = '', 3000);
            } catch (error) {
                msgDiv.innerHTML = '<div class="text-red-400">‚ùå ' + error.message + '</div>';
            }
        }
        
        async function loadCryptos() {
            const listDiv = document.getElementById('crypto-list');
            const statsDiv = document.getElementById('stats');
            const externalDiv = document.getElementById('external-data');
            listDiv.innerHTML = '<div class="text-gray-400">‚è≥ Cargando datos reales...</div>';
            
            try {
                const res = await fetch('/api/crypto');
                const data = await res.json();
                
                if (data.success) {
                    currentCryptos = data.data;
                    
                    // Mostrar datos externos
                    if (data.externalData.fearGreed) {
                        externalDiv.innerHTML = `
                            <div class="text-xs">
                                <div>Fear & Greed: <span class="font-bold">${data.externalData.fearGreed.value}</span></div>
                                <div>${data.externalData.fearGreed.classification}</div>
                            </div>
                        `;
                    }
                    
                    // Stats
                    const invertible = data.data.filter(c => c.classification === 'INVERTIBLE').length;
                    const apalancado = data.data.filter(c => c.classification === 'APALANCADO').length;
                    const ruidoso = data.data.filter(c => c.classification === 'RUIDOSO').length;
                    
                    statsDiv.innerHTML = `
                        <div class="bg-green-900/30 p-4 rounded">
                            <div class="text-green-400 text-2xl font-bold">${invertible}</div>
                            <div class="text-sm">INVERTIBLES</div>
                        </div>
                        <div class="bg-yellow-900/30 p-4 rounded">
                            <div class="text-yellow-400 text-2xl font-bold">${apalancado}</div>
                            <div class="text-sm">APALANCADOS</div>
                        </div>
                        <div class="bg-gray-800 p-4 rounded">
                            <div class="text-gray-400 text-2xl font-bold">${ruidoso}</div>
                            <div class="text-sm">RUIDOSOS</div>
                        </div>
                        <div class="bg-blue-900/30 p-4 rounded">
                            <div class="text-blue-400 text-2xl font-bold">${data.data.length}</div>
                            <div class="text-sm">TOTAL</div>
                        </div>
                    `;
                    
                    // List
                    listDiv.innerHTML = '';
                    data.data.forEach(crypto => {
                        const colorClass = crypto.color === 'green' ? 'border-green-500' : 
                                         crypto.color === 'yellow' ? 'border-yellow-500' : 'border-gray-600';
                        
                        const card = document.createElement('div');
                        card.className = `bg-gray-800 p-4 rounded-lg border-l-4 ${colorClass}`;
                        card.innerHTML = `
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="font-bold text-lg">${crypto.name} <span class="text-gray-500 text-sm">${crypto.symbol.toUpperCase()}</span></div>
                                    <div class="text-xl text-blue-400">$${crypto.current_price.toLocaleString()}</div>
                                    <div class="${crypto.price_change_percentage_24h >= 0 ? 'text-green-400' : 'text-red-400'} text-sm">
                                        ${crypto.price_change_percentage_24h >= 0 ? '‚Üë' : '‚Üì'} 
                                        ${Math.abs(crypto.price_change_percentage_24h).toFixed(2)}%
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-sm font-medium mb-1">${crypto.classification}</div>
                                    <div class="text-2xl font-bold">${crypto.boostPowerPercent}%</div>
                                    <div class="text-xs text-gray-400">BoostPower</div>
                                    <div class="text-xs text-gray-500 mt-1">Pred: ${crypto.predictedChange.toFixed(1)}%</div>
                                </div>
                            </div>
                        `;
                        listDiv.appendChild(card);
                    });
                    
                    // Habilitar bot√≥n de ciclo
                    document.getElementById('btn-start-cycle').disabled = false;
                }
            } catch (error) {
                listDiv.innerHTML = '<div class="text-red-400">‚ùå Error: ' + error.message + '</div>';
            }
        }
        
        async function startCycle() {
            if (currentCryptos.length === 0) {
                alert('Primero carga los datos con el bot√≥n Cargar');
                return;
            }
            
            if (!confirm('¬øIniciar ciclo de predicci√≥n de 12 horas con los top 20 activos?')) return;
            
            try {
                const snapshot = currentCryptos.slice(0, 20);
                
                const res = await fetch('/api/cycles/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ snapshot })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    alert(`‚úÖ Ciclo iniciado!\nID: ${data.cycle.id}\nFinaliza en 12 horas`);
                    setTab('validation');
                    await loadValidation();
                } else {
                    alert('‚ùå Error: ' + data.error);
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }
        
        async function loadValidation() {
            await loadActiveCycles();
            await loadCompletedCycles();
            await loadGlobalStats();
        }
        
        async function loadActiveCycles() {
            const div = document.getElementById('active-cycles');
            div.innerHTML = '<div class="text-gray-400">Cargando...</div>';
            
            try {
                const res = await fetch('/api/cycles/active');
                const data = await res.json();
                
                if (data.success && data.cycles.length > 0) {
                    div.innerHTML = '';
                    data.cycles.forEach(cycle => {
                        const card = document.createElement('div');
                        card.className = 'bg-gray-800 p-4 rounded-lg mb-3';
                        card.innerHTML = `
                            <div class="flex justify-between items-center">
                                <div>
                                    <div class="font-bold">Ciclo activo</div>
                                    <div class="text-sm text-gray-400">${cycle.snapshot.length} activos</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-2xl font-bold text-blue-400">${cycle.hoursRemaining}h</div>
                                    <div class="text-xs text-gray-400">restantes</div>
                                </div>
                            </div>
                        `;
                        div.appendChild(card);
                    });
                } else {
                    div.innerHTML = '<div class="text-gray-500">No hay ciclos activos</div>';
                }
            } catch (error) {
                div.innerHTML = '<div class="text-red-400">Error al cargar</div>';
            }
        }
        
        async function loadCompletedCycles() {
            const div = document.getElementById('completed-cycles');
            div.innerHTML = '<div class="text-gray-400">Cargando...</div>';
            
            try {
                const res = await fetch('/api/cycles/history');
                const data = await res.json();
                
                if (data.success && data.cycles.length > 0) {
                    div.innerHTML = '';
                    data.cycles.slice(0, 5).forEach(cycle => {
                        const card = document.createElement('div');
                        card.className = 'bg-gray-800 p-4 rounded-lg mb-3';
                        card.innerHTML = `
                            <div class="flex justify-between items-center">
                                <div class="flex-1">
                                    <div class="font-bold">Ciclo ${new Date(cycle.completedAt).toLocaleDateString()}</div>
                                    <div class="text-sm text-gray-400">
                                        ${cycle.metrics.correct}/${cycle.metrics.total} correctas
                                    </div>
                                </div>
                                <div class="text-right mr-4">
                                    <div class="text-2xl font-bold text-green-400">${cycle.metrics.successRate}%</div>
                                    <div class="text-xs text-gray-400">Tasa acierto</div>
                                </div>
                                <button onclick="downloadReport('${cycle.id}')" class="bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded text-sm">
                                    üìÑ Informe
                                </button>
                            </div>
                        `;
                        div.appendChild(card);
                    });
                } else {
                    div.innerHTML = '<div class="text-gray-500">No hay ciclos completados. Inicia tu primer ciclo!</div>';
                }
            } catch (error) {
                div.innerHTML = '<div class="text-red-400">Error al cargar</div>';
            }
        }
        
        async function loadGlobalStats() {
            const div = document.getElementById('global-stats');
            
            try {
                const res = await fetch('/api/cycles/stats/global');
                const data = await res.json();
                
                if (data.success) {
                    const stats = data.stats;
                    div.innerHTML = `
                        <div class="grid grid-cols-3 gap-4">
                            <div class="bg-gray-800 p-4 rounded">
                                <div class="text-2xl font-bold text-blue-400">${stats.totalCycles}</div>
                                <div class="text-sm text-gray-400">Total Ciclos</div>
                            </div>
                            <div class="bg-gray-800 p-4 rounded">
                                <div class="text-2xl font-bold text-green-400">${stats.avgSuccessRate}%</div>
                                <div class="text-sm text-gray-400">Accuracy Promedio</div>
                            </div>
                            <div class="bg-gray-800 p-4 rounded">
                                <div class="text-2xl font-bold text-purple-400">${stats.totalPredictions}</div>
                                <div class="text-sm text-gray-400">Total Predicciones</div>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {}
        }
        
        async function downloadReport(cycleId) {
            try {
                window.location.href = `/api/cycles/${cycleId}/report`;
            } catch (error) {
                alert('Error al descargar informe');
            }
        }
        
        function setTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
            document.querySelectorAll('[id^="tab-"]').forEach(el => {
                el.classList.remove('bg-blue-600');
                el.classList.add('bg-gray-700');
            });
            
            document.getElementById('content-' + tab).style.display = 'block';
            document.getElementById('tab-' + tab).classList.remove('bg-gray-700');
            document.getElementById('tab-' + tab).classList.add('bg-blue-600');
            
            if (tab === 'validation') {
                loadValidation();
            }
        }
        
        // Auto-check pending cycles
        setInterval(async () => {
            try {
                const res = await fetch('/api/cycles/pending');
                const data = await res.json();
                if (data.success && data.cycles.length > 0) {
                    for (const cycle of data.cycles) {
                        await fetch(`/api/cycles/${cycle.id}/complete`, { method: 'POST' });
                    }
                    if (document.getElementById('content-validation').style.display !== 'none') {
                        loadValidation();
                    }
                }
            } catch (error) {}
        }, 60000); // Cada minuto
        
        window.onload = () => {
            init();
        };
    </script>
</body>
</html>
