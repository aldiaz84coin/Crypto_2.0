<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Crypto Detector v3.2</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .tab-content{display:none}
    .tab-active{background:#2563EB!important;color:#fff!important}
    .result-card{cursor:pointer;transition:opacity .2s,border .2s}
    .result-card:hover{opacity:.8}
    .excluded{opacity:.4;border-style:dashed!important}
  </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
<div class="max-w-7xl mx-auto p-4">

  <!-- Header -->
  <div class="flex justify-between items-start mb-5">
    <div>
      <h1 class="text-3xl font-bold">ğŸš€ Crypto Detector v3.2</h1>
      <p class="text-gray-500 text-xs mt-1">Datos Reales Â· Ciclos Â· ValidaciÃ³n Â· APIs</p>
    </div>
    <div id="fgi-badge" class="text-right text-sm"></div>
  </div>

  <!-- Tabs -->
  <div class="flex gap-1 mb-5 border-b border-gray-700">
    <button onclick="setTab('monitor')"    id="tab-monitor"    class="tab-btn px-4 py-2 rounded-t text-sm bg-gray-700 tab-active">ğŸ“Š Monitor</button>
    <button onclick="setTab('config')"     id="tab-config"     class="tab-btn px-4 py-2 rounded-t text-sm bg-gray-700">âš™ï¸ Config</button>
    <button onclick="setTab('validation')" id="tab-validation" class="tab-btn px-4 py-2 rounded-t text-sm bg-gray-700">âœ… ValidaciÃ³n</button>
    <button onclick="setTab('status')"     id="tab-status"     class="tab-btn px-4 py-2 rounded-t text-sm bg-gray-700">ğŸ”Œ APIs</button>
  </div>

  <!-- MONITOR -->
  <div id="content-monitor" class="tab-content" style="display:block">
    <div class="flex flex-wrap gap-2 items-center mb-4">
      <h2 class="text-xl font-semibold flex-1">Monitor en Tiempo Real</h2>
      <button onclick="loadCryptos()" class="bg-green-700 hover:bg-green-600 px-4 py-2 rounded text-sm">ğŸ”„ Cargar datos</button>
      <button onclick="openCycleModal()" id="btn-cycle" disabled class="bg-purple-700 hover:bg-purple-600 px-4 py-2 rounded text-sm font-semibold disabled:opacity-40 disabled:cursor-not-allowed">â° Iniciar Ciclo</button>
    </div>
    <div id="stats" class="grid grid-cols-4 gap-3 mb-4"></div>
    <div id="crypto-list" class="space-y-2"></div>
  </div>

  <!-- CONFIG -->
  <div id="content-config" class="tab-content">
    <h2 class="text-xl font-semibold mb-4">âš™ï¸ ConfiguraciÃ³n del Algoritmo</h2>
    <div class="bg-gray-800 rounded p-4 mb-4">
      <h3 class="font-medium mb-3 text-sm">Meta-Pesos</h3>
      <label class="text-xs text-gray-400">Cuantitativo <span id="mq-val">60</span>% Â· Cualitativo <span id="mql-val">40</span>%</label>
      <input type="range" id="meta-quant" min="0" max="100" step="5" value="60" oninput="onMetaChange()" class="w-full mt-1"/>
    </div>
    <div class="bg-gray-800 rounded p-4 mb-4">
      <h3 class="font-medium mb-3 text-sm">Pesos de Factores</h3>
      <div class="grid grid-cols-2 gap-4">
        <div><p class="text-green-400 text-xs mb-2">Cuantitativos</p><div id="quant-factors"></div></div>
        <div><p class="text-purple-400 text-xs mb-2">Cualitativos</p><div id="qual-factors"></div></div>
      </div>
    </div>
    <div class="bg-gray-800 rounded p-4 mb-4">
      <h3 class="font-medium mb-3 text-sm">Umbral INVERTIBLE: <span id="thr-val">40</span>%</h3>
      <input type="range" id="thr-boost" min="30" max="50" value="40" oninput="onThrChange()" class="w-full"/>
    </div>
    <div class="flex gap-2">
      <button onclick="saveConfig()" class="bg-green-700 hover:bg-green-600 px-5 py-2 rounded text-sm">ğŸ’¾ Guardar</button>
      <button onclick="resetConfig()" class="bg-yellow-700 hover:bg-yellow-600 px-5 py-2 rounded text-sm">â†º Resetear</button>
    </div>
    <div id="cfg-msg" class="mt-3 text-sm"></div>
  </div>

  <!-- VALIDACIÃ“N -->
  <div id="content-validation" class="tab-content">
    <h2 class="text-xl font-semibold mb-4">âœ… ValidaciÃ³n de Ciclos</h2>

    <!-- Debug panel (colapsa) -->
    <div class="mb-4">
      <button onclick="toggleDebug()" class="text-xs text-gray-500 hover:text-gray-300">ğŸ”§ Panel de diagnÃ³stico â–¾</button>
      <div id="debug-panel" class="hidden mt-2 bg-gray-800 rounded p-3 text-xs space-y-1">
        <p class="text-gray-400">Verificar que Redis estÃ© funcionando antes de iniciar ciclos:</p>
        <button onclick="runDebug()" class="bg-blue-700 hover:bg-blue-600 px-3 py-1 rounded">ğŸ” Probar Redis</button>
        <pre id="debug-output" class="mt-2 text-green-400 whitespace-pre-wrap"></pre>
      </div>
    </div>

    <div class="mb-5">
      <h3 class="text-base font-semibold mb-2 text-blue-400">ğŸ”„ Ciclos Activos</h3>
      <div id="active-cycles"><p class="text-gray-500 text-sm">Sin ciclos activos</p></div>
    </div>
    <div class="mb-5">
      <h3 class="text-base font-semibold mb-2 text-green-400">ğŸ“‹ Historial</h3>
      <div id="completed-cycles"><p class="text-gray-500 text-sm">AÃºn no hay ciclos completados</p></div>
    </div>
    <div>
      <h3 class="text-base font-semibold mb-2 text-purple-400">ğŸ“Š EstadÃ­sticas Globales</h3>
      <div id="global-stats"></div>
    </div>
  </div>

  <!-- ESTADO APIs -->
  <div id="content-status" class="tab-content">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-semibold">ğŸ”Œ Estado de APIs</h2>
      <div class="flex gap-2">
        <button onclick="loadAPIStatus()" id="btn-refresh" class="bg-blue-700 hover:bg-blue-600 px-4 py-2 rounded text-sm">ğŸ”„ Actualizar</button>
        <button onclick="runDebug()" class="bg-gray-600 hover:bg-gray-500 px-4 py-2 rounded text-sm">ğŸ”§ Debug Redis</button>
      </div>
    </div>
    <div id="api-summary" class="grid grid-cols-4 gap-3 mb-5"></div>
    <div class="space-y-5" id="api-groups">
      <div><h3 class="text-green-400 font-semibold text-sm mb-2">ğŸŸ¢ FREE â€” Sin configuraciÃ³n</h3><div id="apis-free" class="space-y-2"></div></div>
      <div><h3 class="text-yellow-400 font-semibold text-sm mb-2">ğŸŸ¡ FREEMIUM â€” API key gratuita</h3><div id="apis-freemium" class="space-y-2"></div></div>
      <div><h3 class="text-orange-400 font-semibold text-sm mb-2">ğŸŸ  PAID</h3><div id="apis-paid" class="space-y-2"></div></div>
      <div><h3 class="text-red-400 font-semibold text-sm mb-2">ğŸ”´ PREMIUM</h3><div id="apis-premium" class="space-y-2"></div></div>
    </div>
  </div>

</div><!-- /container -->

<!-- â•â• MODAL: INICIAR CICLO â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="modal-cycle" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
  <div class="bg-gray-800 rounded-xl p-6 w-full max-w-md shadow-2xl">
    <h3 class="text-lg font-bold mb-4">â° Configurar Ciclo</h3>

    <p class="text-xs text-gray-400 mb-2">DuraciÃ³n</p>
    <div class="grid grid-cols-3 gap-2 mb-3">
      <button class="dur-btn bg-gray-700 hover:bg-gray-600 py-2 rounded text-sm" onclick="pickDur(1800000,this)">30 min</button>
      <button class="dur-btn bg-gray-700 hover:bg-gray-600 py-2 rounded text-sm" onclick="pickDur(3600000,this)">1 hora</button>
      <button class="dur-btn bg-gray-700 hover:bg-gray-600 py-2 rounded text-sm" onclick="pickDur(14400000,this)">4 horas</button>
      <button class="dur-btn bg-gray-700 hover:bg-gray-600 py-2 rounded text-sm" onclick="pickDur(21600000,this)">6 horas</button>
      <button class="dur-btn bg-blue-700 py-2 rounded text-sm font-bold" id="btn-dur-12" onclick="pickDur(43200000,this)">12 horas â­</button>
      <button class="dur-btn bg-gray-700 hover:bg-gray-600 py-2 rounded text-sm" onclick="pickDur(86400000,this)">24 horas</button>
    </div>
    <div class="flex items-center gap-2 mb-4">
      <span class="text-xs text-gray-400 whitespace-nowrap">Personalizado (min):</span>
      <input type="number" id="custom-dur" min="1" max="10080" placeholder="ej: 90"
             class="bg-gray-700 border border-gray-600 rounded px-2 py-1 text-sm w-full"
             oninput="pickDurMin(this.value)"/>
    </div>

    <div class="bg-gray-700/50 rounded p-3 mb-5 text-sm">
      DuraciÃ³n: <strong id="dur-label" class="text-blue-400">12 horas</strong> Â·
      Activos: <strong id="modal-count">â€”</strong>
    </div>

    <div class="flex gap-3">
      <button onclick="confirmCycle()" class="flex-1 bg-purple-700 hover:bg-purple-600 py-2 rounded font-semibold">ğŸš€ Iniciar</button>
      <button onclick="closeModal('modal-cycle')" class="flex-1 bg-gray-600 hover:bg-gray-700 py-2 rounded">Cancelar</button>
    </div>
  </div>
</div>

<!-- â•â• MODAL: CONFIGURAR API KEY â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="modal-apikey" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
  <div class="bg-gray-800 rounded-xl p-6 w-full max-w-md shadow-2xl">
    <h3 class="text-lg font-bold mb-1" id="apikey-modal-title">Configurar API</h3>
    <p class="text-xs text-gray-400 mb-1" id="apikey-modal-desc"></p>
    <a id="apikey-modal-link" href="#" target="_blank" class="text-xs text-blue-400 hover:underline block mb-4">â†’ Obtener API key</a>

    <label class="text-xs text-gray-400 block mb-1">API Key / Token</label>
    <input type="text" id="apikey-input" placeholder="Pega tu key aquÃ­..."
           class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm mb-1 font-mono"/>
    <p class="text-xs text-gray-500 mb-4">Se guarda de forma segura en Redis. Para APIs FREE puedes dejar en blanco.</p>

    <div id="apikey-instructions" class="bg-gray-700/50 rounded p-3 text-xs text-gray-300 mb-4 hidden"></div>

    <div class="flex gap-3">
      <button onclick="saveAPIKey()" class="flex-1 bg-green-700 hover:bg-green-600 py-2 rounded font-semibold text-sm">ğŸ’¾ Guardar</button>
      <button onclick="clearAPIKey()" class="bg-red-900 hover:bg-red-800 px-4 py-2 rounded text-sm">ğŸ—‘ Borrar</button>
      <button onclick="closeModal('modal-apikey')" class="flex-1 bg-gray-600 hover:bg-gray-700 py-2 rounded text-sm">Cancelar</button>
    </div>
    <div id="apikey-msg" class="mt-3 text-sm"></div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ESTADO GLOBAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let config = null;
let metadata = null;
let cryptos = [];
let selectedDuration = 43200000; // 12h por defecto
let cycleTimers = {};
let currentAPIName = '';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function init() {
  await loadMetadata();
  await loadConfig();
  renderFactors();
}

async function loadMetadata() {
  try {
    const d = await api('/api/config/metadata');
    if (d.success) metadata = d.metadata;
  } catch(_){}
}

async function loadConfig() {
  try {
    const d = await api('/api/config');
    if (d.success) { config = d.config; applyConfigToUI(); }
  } catch(_){}
}

function applyConfigToUI() {
  if (!config) return;
  const q = Math.round(config.metaWeights.quantitative * 100);
  set('meta-quant', q); set('mq-val', q); set('mql-val', 100-q);
  const t = Math.round(config.boostPowerThreshold * 100);
  set('thr-boost', t); set('thr-val', t);
}

function renderFactors() {
  if (!metadata || !config) return;
  const build = (factors, id) => {
    document.getElementById(id).innerHTML = factors.map(f => {
      const w = Math.round((config.factorWeights[f.id]||0)*100);
      return `<div class="mb-2">
        <label class="text-xs text-gray-400">${f.name}: <span id="fw-${f.id}">${w}</span>%</label>
        <input type="range" id="factor-${f.id}" min="0" max="30" value="${w}"
               oninput="onFactorChange('${f.id}')" class="w-full h-1"/>
      </div>`;
    }).join('');
  };
  build(metadata.quantitative, 'quant-factors');
  build(metadata.qualitative,  'qual-factors');
}

function onMetaChange() {
  const q = +document.getElementById('meta-quant').value;
  set('mq-val', q); set('mql-val', 100-q);
  config.metaWeights.quantitative = q/100;
  config.metaWeights.qualitative  = (100-q)/100;
}

function onThrChange() {
  const v = +document.getElementById('thr-boost').value;
  set('thr-val', v);
  config.boostPowerThreshold = v/100;
}

function onFactorChange(id) {
  const v = +document.getElementById(`factor-${id}`).value;
  set(`fw-${id}`, v);
  config.factorWeights[id] = v/100;
}

async function saveConfig() {
  const msg = document.getElementById('cfg-msg');
  msg.innerHTML = '<span class="text-gray-400">Guardando...</span>';
  try {
    const d = await api('/api/config', 'POST', { config });
    msg.innerHTML = d.success
      ? '<span class="text-green-400">âœ… Guardado</span>'
      : `<span class="text-red-400">âŒ ${d.error||JSON.stringify(d.errors)}</span>`;
    setTimeout(()=>msg.innerHTML='',3000);
  } catch(e){ msg.innerHTML=`<span class="text-red-400">âŒ ${e.message}</span>`; }
}

async function resetConfig() {
  if (!confirm('Â¿Resetear configuraciÃ³n?')) return;
  const d = await api('/api/config/reset','POST');
  if (d.success) { config=d.config; applyConfigToUI(); renderFactors(); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MONITOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadCryptos() {
  const list = document.getElementById('crypto-list');
  list.innerHTML = '<p class="text-gray-400 text-sm">â³ Cargando...</p>';
  try {
    const d = await api('/api/crypto');
    if (!d.success) throw new Error(d.error);
    cryptos = d.data;
    document.getElementById('btn-cycle').disabled = false;

    // FGI badge
    if (d.externalData?.fearGreed) {
      const fg = d.externalData.fearGreed;
      const c = fg.value<30?'text-red-400':fg.value<50?'text-orange-400':fg.value<70?'text-yellow-400':'text-green-400';
      document.getElementById('fgi-badge').innerHTML =
        `<p class="text-xs text-gray-500">Fear & Greed</p><p class="font-bold ${c}">${fg.value} Â· ${fg.classification}</p>`;
    }

    // Stats
    const inv = cryptos.filter(c=>c.classification==='INVERTIBLE').length;
    const apl = cryptos.filter(c=>c.classification==='APALANCADO').length;
    const rui = cryptos.filter(c=>c.classification==='RUIDOSO').length;
    document.getElementById('stats').innerHTML = `
      <div class="bg-green-900/30 rounded p-3 text-center"><div class="text-2xl font-bold text-green-400">${inv}</div><div class="text-xs mt-1">INVERTIBLES</div></div>
      <div class="bg-yellow-900/30 rounded p-3 text-center"><div class="text-2xl font-bold text-yellow-400">${apl}</div><div class="text-xs mt-1">APALANCADOS</div></div>
      <div class="bg-gray-800 rounded p-3 text-center"><div class="text-2xl font-bold text-gray-400">${rui}</div><div class="text-xs mt-1">RUIDOSOS</div></div>
      <div class="bg-blue-900/30 rounded p-3 text-center"><div class="text-2xl font-bold text-blue-400">${cryptos.length}</div><div class="text-xs mt-1">TOTAL</div></div>`;

    // Cards
    list.innerHTML = '';
    cryptos.forEach(c => {
      const border = c.color==='green'?'border-green-500':c.color==='yellow'?'border-yellow-500':'border-gray-600';
      const chgColor = c.price_change_percentage_24h>=0?'text-green-400':'text-red-400';
      const card = document.createElement('div');
      card.className = `bg-gray-800 rounded p-3 border-l-4 ${border} flex justify-between items-center`;
      card.innerHTML = `
        <div>
          <span class="font-semibold">${c.name}</span>
          <span class="text-gray-500 text-xs ml-1">${c.symbol.toUpperCase()}</span>
          <div class="text-blue-400 text-sm font-medium">$${c.current_price.toLocaleString()}</div>
          <div class="${chgColor} text-xs">${c.price_change_percentage_24h>=0?'â†‘':'â†“'}${Math.abs(c.price_change_percentage_24h).toFixed(2)}%</div>
        </div>
        <div class="text-right">
          <div class="text-xs text-gray-400">${c.classification}</div>
          <div class="text-2xl font-bold">${c.boostPowerPercent}%</div>
          <div class="text-xs text-gray-500">BoostPower</div>
          <div class="text-xs text-gray-500">Pred: ${c.predictedChange}%</div>
        </div>`;
      list.appendChild(card);
    });
  } catch(e) {
    list.innerHTML = `<p class="text-red-400 text-sm">âŒ ${e.message}</p>`;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODAL CICLO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openCycleModal() {
  if (cryptos.length===0) { alert('Carga los datos primero.'); return; }
  document.getElementById('modal-count').textContent = Math.min(cryptos.length,20);
  showModal('modal-cycle');
}

function pickDur(ms, btn) {
  selectedDuration = ms;
  document.getElementById('dur-label').textContent = fmtDur(ms);
  document.getElementById('custom-dur').value = '';
  document.querySelectorAll('.dur-btn').forEach(b=>b.classList.replace('bg-blue-700','bg-gray-700'));
  btn.classList.replace('bg-gray-700','bg-blue-700');
}

function pickDurMin(val) {
  const m = parseInt(val);
  if (!isNaN(m) && m>=1) {
    selectedDuration = m*60000;
    document.getElementById('dur-label').textContent = fmtDur(selectedDuration);
    document.querySelectorAll('.dur-btn').forEach(b=>b.classList.replace('bg-blue-700','bg-gray-700'));
  }
}

function fmtDur(ms) {
  const h=Math.floor(ms/3600000), m=Math.floor((ms%3600000)/60000);
  return h===0?`${m} min`:m===0?`${h}h`:`${h}h ${m}min`;
}

async function confirmCycle() {
  closeModal('modal-cycle');
  const snapshot = cryptos.slice(0,20);

  // Mostrar feedback inmediato en ValidaciÃ³n
  setTab('validation');
  document.getElementById('active-cycles').innerHTML =
    '<p class="text-blue-400 text-sm">â³ Iniciando ciclo...</p>';

  try {
    const d = await api('/api/cycles/start','POST',{ snapshot, durationMs: selectedDuration });
    if (d.success) {
      await loadValidation();
    } else {
      document.getElementById('active-cycles').innerHTML =
        `<p class="text-red-400 text-sm">âŒ Error: ${d.error||JSON.stringify(d)}</p>`;
    }
  } catch(e) {
    document.getElementById('active-cycles').innerHTML =
      `<p class="text-red-400 text-sm">âŒ Error de red: ${e.message}</p>`;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VALIDACIÃ“N
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadValidation() {
  await Promise.all([loadActiveCycles(), loadCompletedCycles(), loadGlobalStats()]);
}

async function loadActiveCycles() {
  const div = document.getElementById('active-cycles');
  try {
    const d = await api('/api/cycles/active');
    if (!d.success || d.cycles.length===0) {
      div.innerHTML = '<p class="text-gray-500 text-sm">Sin ciclos activos</p>';
      return;
    }
    div.innerHTML = '';
    d.cycles.forEach(c => {
      const card = document.createElement('div');
      card.id = `acard-${c.id}`;
      card.className = 'bg-gray-800 rounded p-4 mb-2';
      div.appendChild(card);
      updateActiveCycleCard(c);
      if (cycleTimers[c.id]) clearInterval(cycleTimers[c.id]);
      cycleTimers[c.id] = setInterval(()=>tickCycle(c), 1000);
    });
  } catch(e) {
    div.innerHTML = `<p class="text-red-400 text-sm">Error: ${e.message}</p>`;
  }
}

function updateActiveCycleCard(cycle) {
  const card = document.getElementById(`acard-${cycle.id}`);
  if (!card) return;
  const now      = Date.now();
  const total    = cycle.durationMs || (cycle.endTime - cycle.startTime);
  const elapsed  = now - cycle.startTime;
  const remaining= Math.max(0, cycle.endTime - now);
  const pct      = Math.min(100, Math.round(elapsed/total*100));
  const ready    = remaining === 0;

  card.innerHTML = `
    <div class="flex justify-between items-start mb-3">
      <div>
        <p class="font-semibold text-sm">${ready?'âœ… Listo':'ğŸ”„ Activo'} Â· ${cycle.snapshot.length} activos Â· ${fmtDur(total)}</p>
        <p class="text-xs text-gray-500 mt-0.5">ID: ${cycle.id}</p>
      </div>
      <div class="text-right">
        ${ready
          ? `<button onclick="completeCycle('${cycle.id}')" class="bg-green-700 hover:bg-green-600 px-3 py-1.5 rounded text-sm font-bold">Validar ahora</button>`
          : `<div class="text-xl font-bold text-blue-400 font-mono" id="cd-${cycle.id}">${fmtCountdown(remaining)}</div>
             <div class="text-xs text-gray-500">restante</div>`
        }
      </div>
    </div>
    <div class="w-full bg-gray-700 rounded-full h-1.5 mb-1">
      <div class="bg-blue-500 h-1.5 rounded-full" style="width:${pct}%" id="bar-${cycle.id}"></div>
    </div>
    <div class="flex justify-between text-xs text-gray-500">
      <span>${pct}%</span>
      <span>Fin: ${new Date(cycle.endTime).toLocaleString()}</span>
    </div>
    ${!ready?`<div class="text-right mt-1"><button onclick="completeCycle('${cycle.id}')" class="text-xs text-gray-600 hover:text-yellow-400">Completar manualmente</button></div>`:''}`;
}

function tickCycle(cycle) {
  const now      = Date.now();
  const total    = cycle.durationMs || (cycle.endTime - cycle.startTime);
  const remaining= Math.max(0, cycle.endTime - now);
  const pct      = Math.min(100, Math.round((now - cycle.startTime)/total*100));

  const cdEl  = document.getElementById(`cd-${cycle.id}`);
  const barEl = document.getElementById(`bar-${cycle.id}`);
  if (cdEl)  cdEl.textContent = fmtCountdown(remaining);
  if (barEl) barEl.style.width = pct + '%';

  if (remaining === 0) {
    clearInterval(cycleTimers[cycle.id]);
    updateActiveCycleCard(cycle); // muestra botÃ³n "Validar ahora"
  }
}

function fmtCountdown(ms) {
  if (ms<=0) return '00:00:00';
  const h=Math.floor(ms/3600000), m=Math.floor((ms%3600000)/60000), s=Math.floor((ms%60000)/1000);
  return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

async function completeCycle(id) {
  document.getElementById(`acard-${id}`).querySelector('button').disabled = true;
  document.getElementById(`acard-${id}`).querySelector('button').textContent = 'â³ Completando...';
  try {
    const d = await api(`/api/cycles/${id}/complete`,'POST');
    if (d.success) { clearInterval(cycleTimers[id]); await loadValidation(); }
    else alert('âŒ ' + d.error);
  } catch(e) { alert('âŒ ' + e.message); }
}

async function loadCompletedCycles() {
  const div = document.getElementById('completed-cycles');
  try {
    const d = await api('/api/cycles/history');
    if (!d.success || d.cycles.length===0) {
      div.innerHTML = '<p class="text-gray-500 text-sm">AÃºn no hay ciclos completados</p>';
      return;
    }
    div.innerHTML = '';
    d.cycles.slice(0,10).forEach(c => {
      const excl = (c.excludedResults||[]).length;
      const el   = document.createElement('div');
      el.className = 'bg-gray-800 rounded p-4 mb-2';
      el.innerHTML = `
        <div class="flex justify-between items-center mb-2">
          <div>
            <p class="font-semibold text-sm">${new Date(c.completedAt).toLocaleString()}</p>
            <p class="text-xs text-gray-400">${c.snapshot.length} activos Â· ${fmtDur(c.durationMs||43200000)}
              ${excl>0?`<span class="text-yellow-400 ml-2">${excl} excluidos</span>`:''}
            </p>
          </div>
          <div class="flex gap-2 items-center">
            <div class="text-right mr-2">
              <div class="text-xl font-bold text-green-400">${c.metrics?.successRate??'?'}%</div>
              <div class="text-xs text-gray-400">${c.metrics?.correct??'?'}/${c.metrics?.total??'?'} correctas</div>
            </div>
            <button onclick="toggleDetail('${c.id}')" class="bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded text-xs">ğŸ“‹ Ver</button>
            <button onclick="dlReport('${c.id}')" class="bg-blue-800 hover:bg-blue-700 px-2 py-1 rounded text-xs">ğŸ“„ Word</button>
          </div>
        </div>
        <div id="detail-${c.id}" class="hidden border-t border-gray-700 pt-3 mt-2">
          <p class="text-xs text-gray-400 mb-2">Click en un resultado para excluirlo/incluirlo de las estadÃ­sticas</p>
          ${(c.results||[]).map(r=>resultCard(r,c)).join('')}
        </div>`;
      div.appendChild(el);
    });
  } catch(e) {
    div.innerHTML = `<p class="text-red-400 text-sm">Error: ${e.message}</p>`;
  }
}

function resultCard(r, cycle) {
  const excl = (cycle.excludedResults||[]).includes(r.id);
  const border= excl?'border-gray-600':r.correct?'border-green-600':'border-red-600';
  const icon  = excl?'âŠ˜':r.correct?'âœ“':'âœ—';
  const icolor= excl?'text-gray-400':r.correct?'text-green-400':'text-red-400';
  const chgc  = parseFloat(r.actualChange)>=0?'text-green-400':'text-red-400';
  return `
    <div class="result-card ${excl?'excluded':''} bg-gray-700/40 rounded p-2.5 border-l-4 ${border} flex justify-between items-center mb-1"
         onclick="toggleExclude('${cycle.id}','${r.id}',this)">
      <div>
        <span class="font-medium text-sm">${r.name}</span>
        <span class="text-gray-400 text-xs ml-1">${r.symbol?.toUpperCase()}</span>
        <span class="ml-1 text-xs px-1 rounded bg-gray-600">${r.classification}</span>
      </div>
      <div class="flex gap-3 items-center text-xs">
        <span class="text-gray-400">Pred:<span class="text-white ml-1">${r.predictedChange}%</span></span>
        <span class="text-gray-400">Real:<span class="${chgc} ml-1">${r.actualChange}%</span></span>
        <span class="text-gray-500">Î”${r.error}%</span>
        <span class="${icolor} font-bold text-base">${icon}</span>
      </div>
    </div>`;
}

function toggleDetail(id) {
  document.getElementById(`detail-${id}`)?.classList.toggle('hidden');
}

async function toggleExclude(cycleId, assetId, el) {
  try {
    const d = await api(`/api/cycles/${cycleId}/results/${assetId}/toggle-exclude`,'POST');
    if (d.success) {
      // Refrescar la secciÃ³n de completados manteniendo el detalle abierto
      await loadCompletedCycles();
      document.getElementById(`detail-${cycleId}`)?.classList.remove('hidden');
    }
  } catch(e) { console.error(e); }
}

async function loadGlobalStats() {
  try {
    const d = await api('/api/cycles/stats/global');
    if (!d.success) return;
    const s = d.stats;
    document.getElementById('global-stats').innerHTML = `
      <div class="grid grid-cols-3 gap-3">
        <div class="bg-gray-800 rounded p-3 text-center"><div class="text-xl font-bold text-blue-400">${s.totalCycles}</div><div class="text-xs text-gray-400 mt-1">Ciclos</div></div>
        <div class="bg-gray-800 rounded p-3 text-center"><div class="text-xl font-bold text-green-400">${s.avgSuccessRate}%</div><div class="text-xs text-gray-400 mt-1">Accuracy Media</div></div>
        <div class="bg-gray-800 rounded p-3 text-center"><div class="text-xl font-bold text-purple-400">${s.totalPredictions}</div><div class="text-xs text-gray-400 mt-1">Predicciones</div></div>
      </div>
      ${s.bestCycle?`<p class="text-xs text-gray-500 mt-2">ğŸ† Mejor: ${s.bestCycle.successRate}% el ${s.bestCycle.date}</p>`:''}`;
  } catch(_){}
}

function dlReport(id) { window.location.href=`/api/cycles/${id}/report`; }

// Debug
function toggleDebug() { document.getElementById('debug-panel').classList.toggle('hidden'); }

async function runDebug() {
  const out = document.getElementById('debug-output');
  out.textContent = 'Probando...';
  try {
    const d = await api('/api/debug/redis');
    out.textContent = JSON.stringify(d, null, 2);
  } catch(e) { out.textContent = 'âŒ ' + e.message; }
}

// Auto-completar ciclos terminados
setInterval(async()=>{
  try {
    const d = await api('/api/cycles/pending');
    if (d.success && d.cycles.length>0) {
      for (const c of d.cycles) {
        await api(`/api/cycles/${c.id}/complete`,'POST');
        clearInterval(cycleTimers[c.id]);
      }
      if (document.getElementById('content-validation').style.display!=='none') loadValidation();
    }
  } catch(_){}
}, 30000);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ESTADO APIs + Modal de configuraciÃ³n
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Meta-datos de cada API para el modal de configuraciÃ³n
const API_META = {
  CRYPTOCOMPARE_API_KEY: {
    label:'CryptoCompare', link:'https://www.cryptocompare.com/cryptopian/api-keys',
    desc:'Noticias y sentimiento de crypto. Plan gratuito: 100K calls/mes.',
    instructions:'1. Ve a cryptocompare.com â†’ Sign Up\n2. Dashboard â†’ API Keys â†’ Create Key\n3. Copia la key y pÃ©gala aquÃ­'
  },
  NEWSAPI_KEY: {
    label:'NewsAPI', link:'https://newsapi.org/register',
    desc:'Noticias de medios mainstream. Plan gratuito: 100 requests/dÃ­a.',
    instructions:'1. Ve a newsapi.org â†’ Get API Key\n2. Registra email\n3. Copia la key del dashboard'
  },
  GITHUB_TOKEN: {
    label:'GitHub Token', link:'https://github.com/settings/tokens',
    desc:'Actividad de desarrollo. Gratis: 5000 req/hora con token.',
    instructions:'1. GitHub â†’ Settings â†’ Developer Settings\n2. Personal Access Tokens â†’ Tokens (classic)\n3. Generate new token â†’ selecciona "public_repo"\n4. Copia el token (empieza con ghp_)'
  },
  TELEGRAM_BOT_TOKEN: {
    label:'Telegram Bot', link:'https://t.me/botfather',
    desc:'Monitoreo de canales de Telegram. Completamente gratis.',
    instructions:'1. Abre Telegram â†’ busca @BotFather\n2. Escribe /newbot\n3. Sigue las instrucciones\n4. Copia el token que te da (formato: 123456:ABC...)'
  },
  SERPAPI_KEY: {
    label:'SerpAPI (Google Trends)', link:'https://serpapi.com/',
    desc:'Google Trends real. Desde $50/mes. 100 bÃºsquedas gratis al mes.',
    instructions:'1. serpapi.com â†’ Sign Up\n2. Dashboard â†’ API Key\n3. Copia la key'
  },
  TWITTER_BEARER_TOKEN: {
    label:'Twitter API v2', link:'https://developer.twitter.com/',
    desc:'Sentimiento de Twitter. Desde $100/mes.',
    instructions:'1. developer.twitter.com â†’ Apply\n2. Crea una App\n3. Keys & Tokens â†’ Bearer Token\n4. Copia el Bearer Token'
  },
  GLASSNODE_API_KEY: {
    label:'Glassnode', link:'https://glassnode.com/',
    desc:'MÃ©tricas on-chain profesionales. Desde $29/mes.',
    instructions:'1. glassnode.com â†’ Sign Up\n2. Elige plan\n3. API Settings â†’ Copy Key'
  },
  CRYPTOQUANT_API_KEY: {
    label:'CryptoQuant', link:'https://cryptoquant.com/',
    desc:'Exchange flows on-chain. Desde $49/mes.',
    instructions:'1. cryptoquant.com â†’ Sign Up\n2. Settings â†’ API Management\n3. Generate Key'
  },
  WHALE_ALERT_API_KEY: {
    label:'Whale Alert', link:'https://whale-alert.io/',
    desc:'Monitoreo de ballenas. Desde $49/mes.',
    instructions:'1. whale-alert.io â†’ Subscribe\n2. Dashboard â†’ API Key\n3. Copia la key'
  }
};

async function loadAPIStatus() {
  const btn = document.getElementById('btn-refresh');
  btn.disabled = true; btn.textContent = 'â³ Verificando...';

  document.getElementById('api-summary').innerHTML =
    '<div class="col-span-4 text-gray-400 text-sm">â³ Verificando en paralelo...</div>';
  ['apis-free','apis-freemium','apis-paid','apis-premium'].forEach(id=>
    document.getElementById(id).innerHTML = '<p class="text-gray-600 text-xs">Cargando...</p>'
  );

  try {
    const d = await api('/api/status/complete');
    if (!d.success) throw new Error(d.error||'Error');

    const s = d.summary;
    document.getElementById('api-summary').innerHTML = `
      <div class="bg-gray-800 rounded p-3 text-center"><div class="text-xl font-bold text-blue-400">${s.total}</div><div class="text-xs text-gray-400">Total</div></div>
      <div class="bg-green-900/30 rounded p-3 text-center"><div class="text-xl font-bold text-green-400">${s.available}</div><div class="text-xs text-gray-400">Operacionales</div></div>
      <div class="bg-yellow-900/30 rounded p-3 text-center"><div class="text-xl font-bold text-yellow-400">${s.configured}</div><div class="text-xs text-gray-400">Configuradas</div></div>
      <div class="bg-red-900/30 rounded p-3 text-center"><div class="text-xl font-bold text-red-400">${s.errors}</div><div class="text-xs text-gray-400">Errores</div></div>`;

    const groups = { free:[], freemium:[], paid:[], premium:[] };
    Object.values(d.apis).forEach(a=>{ if(groups[a.tier]) groups[a.tier].push(a); });

    ['free','freemium','paid','premium'].forEach(tier=>{
      document.getElementById(`apis-${tier}`).innerHTML =
        groups[tier].length ? groups[tier].map(a=>apiCard(a)).join('') : '<p class="text-gray-600 text-xs">â€”</p>';
    });
  } catch(e) {
    document.getElementById('api-summary').innerHTML =
      `<div class="col-span-4 text-red-400 text-sm">âŒ ${e.message}</div>`;
  } finally {
    btn.disabled=false; btn.textContent='ğŸ”„ Actualizar';
  }
}

function apiCard(api) {
  const icons   = { operational:'âœ…', error:'âŒ', not_configured:'âšª', limited:'âš ï¸', unknown:'â“' };
  const borders = { operational:'border-green-500', error:'border-red-500', not_configured:'border-gray-600', limited:'border-yellow-500', unknown:'border-gray-600' };
  const badges  = { operational:'bg-green-900/50 text-green-300', error:'bg-red-900/50 text-red-300', not_configured:'bg-gray-700 text-gray-400', limited:'bg-yellow-900/50 text-yellow-300', unknown:'bg-gray-700 text-gray-400' };

  // Encontrar apiName para el modal de configuraciÃ³n
  const apiNameEntry = Object.entries(API_META).find(([,m])=>m.label===api.name || api.name.includes(m.label.split(' ')[0]));
  const apiName = apiNameEntry?.[0] || '';

  const configBtn = apiName
    ? `<button onclick="openAPIKeyModal('${apiName}')" class="ml-2 text-xs bg-blue-800 hover:bg-blue-700 px-2 py-0.5 rounded">âš™ï¸ Configurar</button>`
    : '';

  return `
    <div class="bg-gray-800 rounded p-3 border-l-4 ${borders[api.status]||'border-gray-600'}">
      <div class="flex justify-between items-start">
        <div class="flex-1">
          <div class="flex flex-wrap items-center gap-1.5 mb-1">
            <span class="text-base">${icons[api.status]||'â“'}</span>
            <span class="font-medium text-sm">${api.name}</span>
            <span class="px-1.5 py-0.5 rounded text-xs ${badges[api.status]||'bg-gray-700 text-gray-400'}">${api.status.replace('_',' ').toUpperCase()}</span>
            ${api.configured?'<span class="text-green-400 text-xs">âœ“ Configurada</span>':'<span class="text-gray-500 text-xs">â—‹ Sin configurar</span>'}
            ${api.cost?`<span class="text-orange-400 text-xs">${api.cost}</span>`:''}
            ${configBtn}
          </div>
          <p class="text-xs text-gray-400">${api.factors.join(' Â· ')}</p>
          <p class="text-sm mt-1 ${api.status==='error'?'text-red-300':'text-gray-300'}">${api.message}</p>
          ${api.currentValue?`<p class="text-xs text-blue-300 mt-0.5">${api.currentValue}</p>`:''}
        </div>
        ${api.responseTime>0?`<span class="text-xs text-gray-500 ml-2 whitespace-nowrap">${api.responseTime}ms</span>`:''}
      </div>
    </div>`;
}

// â”€â”€â”€ Modal de configuraciÃ³n de API key â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openAPIKeyModal(apiName) {
  currentAPIName = apiName;
  const meta = API_META[apiName];
  if (!meta) return;

  document.getElementById('apikey-modal-title').textContent = `Configurar ${meta.label}`;
  document.getElementById('apikey-modal-desc').textContent  = meta.desc;
  document.getElementById('apikey-modal-link').href         = meta.link;
  document.getElementById('apikey-modal-link').textContent  = `â†’ Obtener API key en ${meta.link}`;
  document.getElementById('apikey-input').value             = '';
  document.getElementById('apikey-msg').innerHTML           = '';

  const instrEl = document.getElementById('apikey-instructions');
  if (meta.instructions) {
    instrEl.textContent = meta.instructions;
    instrEl.classList.remove('hidden');
  } else {
    instrEl.classList.add('hidden');
  }

  showModal('modal-apikey');
}

async function saveAPIKey() {
  const key = document.getElementById('apikey-input').value.trim();
  const msg = document.getElementById('apikey-msg');
  msg.innerHTML = '<span class="text-gray-400">Guardando...</span>';
  try {
    const d = await api('/api/config/api-key','POST',{ apiName: currentAPIName, apiKey: key });
    if (d.success) {
      msg.innerHTML = '<span class="text-green-400">âœ… Key guardada. Recarga la pÃ¡gina para que surta efecto.</span>';
      setTimeout(()=>closeModal('modal-apikey'),2000);
    } else {
      msg.innerHTML = `<span class="text-red-400">âŒ ${d.error}</span>`;
    }
  } catch(e) { msg.innerHTML=`<span class="text-red-400">âŒ ${e.message}</span>`; }
}

async function clearAPIKey() {
  if (!confirm('Â¿Borrar la API key guardada?')) return;
  const msg = document.getElementById('apikey-msg');
  try {
    const d = await api('/api/config/api-key','POST',{ apiName: currentAPIName, apiKey: '' });
    msg.innerHTML = d.success
      ? '<span class="text-yellow-400">ğŸ—‘ Key borrada</span>'
      : `<span class="text-red-400">âŒ ${d.error}</span>`;
  } catch(e) { msg.innerHTML=`<span class="text-red-400">âŒ ${e.message}</span>`; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function setTab(tab) {
  document.querySelectorAll('.tab-content').forEach(el=>el.style.display='none');
  document.querySelectorAll('.tab-btn').forEach(el=>{ el.classList.remove('tab-active'); el.classList.add('bg-gray-700'); });
  document.getElementById('content-'+tab).style.display='block';
  const btn = document.getElementById('tab-'+tab);
  btn.classList.add('tab-active'); btn.classList.remove('bg-gray-700');
  if (tab==='validation') loadValidation();
  if (tab==='status')     loadAPIStatus();
}

// â”€â”€ Debug â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function runDebug() {
  const panel = document.getElementById('debug-panel');
  panel.classList.remove('hidden');
  panel.innerHTML = '<p class="text-gray-400 text-sm">â³ Ejecutando diagnÃ³stico...</p>';

  try {
    // Test 1: Redis bÃ¡sico
    const r1 = await fetch('/api/debug/redis');
    const d1 = await r1.json();

    // Test 2: Estado de ciclos
    const r2 = await fetch('/api/debug/cycles');
    const d2 = await r2.json();

    panel.innerHTML = `
      <h4 class="font-bold text-yellow-400 mb-2">ğŸ”§ DiagnÃ³stico Redis</h4>
      <div class="text-xs font-mono bg-gray-900 p-3 rounded mb-3 overflow-auto">
        <p class="${d1.success ? 'text-green-400' : 'text-red-400'}">Redis: ${d1.success ? 'âœ… Conectado' : 'âŒ ' + d1.error}</p>
        <p>Escritura/Lectura: ${d1.writeRead ? 'âœ… OK' : 'âŒ Falla'}</p>
        <p>KV_URL configurada: ${d1.env?.hasUrl ? 'âœ…' : 'âŒ FALTA'}</p>
        <p>KV_TOKEN configurada: ${d1.env?.hasToken ? 'âœ…' : 'âŒ FALTA'}</p>
      </div>

      <h4 class="font-bold text-yellow-400 mb-2">ğŸ”„ Estado Ciclos</h4>
      <div class="text-xs font-mono bg-gray-900 p-3 rounded overflow-auto">
        <p>Tipo de active_cycles en Redis: <span class="text-blue-400">${d2.rawType || '?'}</span></p>
        <p>Valor raw: <span class="text-gray-300">${JSON.stringify(d2.rawActiveValue)}</span></p>
        <p>IDs activos: <span class="text-green-400">${JSON.stringify(d2.activeIds)}</span></p>
        ${d2.firstCycle ? `<p class="text-green-400 mt-1">âœ… Primer ciclo: ${d2.firstCycle.id} (${d2.firstCycle.status}, ${d2.firstCycle.assetsCount} activos)</p>` : '<p class="text-gray-400">Sin ciclos activos</p>'}
        ${d2.error ? `<p class="text-red-400">Error: ${d2.error}</p>` : ''}
      </div>
    `;
  } catch(e) {
    panel.innerHTML = `<p class="text-red-400 text-sm">âŒ Error: ${e.message}</p>`;
  }
}

function showModal(id) { document.getElementById(id).classList.remove('hidden'); }
function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

function set(id, val) {
  const el = document.getElementById(id);
  if (!el) return;
  if (el.tagName==='INPUT'||el.tagName==='SELECT') el.value = val;
  else el.textContent = val;
}

async function api(url, method='GET', body=null) {
  const opts = { method, headers:{'Content-Type':'application/json'} };
  if (body) opts.body = JSON.stringify(body);
  const r = await fetch(url, opts);
  if (!r.ok) {
    const txt = await r.text();
    throw new Error(`HTTP ${r.status}: ${txt.slice(0,200)}`);
  }
  return r.json();
}

window.onload = ()=>init();
</script>
</body>
</html>
